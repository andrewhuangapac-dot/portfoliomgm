<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½æŠ•è³‡çµ„åˆ (æ–°è+è«–å£‡)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        .text-up { color: #ef4444; } 
        .text-down { color: #22c55e; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #6366f1; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Markdown æ¨£å¼ */
        .prose h1, .prose h2, .prose h3 { font-weight: 700; color: #1e293b; margin-top: 1em; margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 1em; }
        .prose p { margin-bottom: 0.8em; line-height: 1.7; color: #334155; }
        .prose strong { color: #0f172a; font-weight: 700; }

        /* AI å‹•ç•« */
        .ai-glow { box-shadow: 0 0 15px rgba(99, 102, 241, 0.5); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); } }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 md:p-8 max-w-7xl mx-auto">
    
    <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                æŠ•è³‡çµ„åˆç®¡ç†
                <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full border border-indigo-200 flex items-center gap-1">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/><path d="M12 6a1 1 0 0 0-1 1v4.59L7.71 14.88a1 1 0 0 0 1.41 1.41l3.59-3.58A1 1 0 0 0 13 12V7a1 1 0 0 0-1-1z"/></svg>
                    AI Agent
                </span>
            </h1>
            <p class="text-slate-500 text-sm">æ–°èè¼¿æƒ… â€¢ è«–å£‡é¢¨å‘ â€¢ è‡ªå‹•åˆ†æ</p>
        </div>
        <div class="flex gap-2">
            <button @click="resetPassword" class="px-3 py-2 text-xs text-gray-400 hover:text-gray-600 underline">é‡è¨­å¯†ç¢¼</button>
            <button @click="fetchData" class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded shadow-sm hover:bg-slate-50 text-sm font-medium transition flex items-center gap-2">
                <span v-if="isLoading" class="loader w-4 h-4 border-slate-400 border-t-transparent"></span>
                <span>{{ isLoading ? 'åŒæ­¥ä¸­...' : 'ğŸ”„ åŒæ­¥æ•¸æ“š' }}</span>
            </button>
            <button @click="saveData" class="px-4 py-2 bg-slate-800 text-white rounded shadow-md hover:bg-slate-900 text-sm font-medium transition">ğŸ’¾ å„²å­˜è®Šæ›´</button>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">å¯ç”¨ç¾é‡‘</h3>
            <div class="flex justify-between items-end mt-2">
                <p class="text-2xl font-bold text-slate-800">{{ formatCurrency(dashboard.cash) }}</p>
                <button @click="showCashModal = true" class="text-xs text-indigo-600 hover:bg-indigo-50 px-2 py-1 rounded transition">èª¿æ•´è³‡é‡‘</button>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">æŒå€‰æˆæœ¬</h3>
            <p class="text-2xl font-bold text-slate-800 mt-2">{{ formatCurrency(dashboard.investedAmount) }}</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">å·²å¯¦ç¾æç›Š</h3>
            <p class="text-2xl font-bold mt-2" :class="dashboard.totalRealizedPnL >= 0 ? 'text-up' : 'text-down'">
                {{ dashboard.totalRealizedPnL >= 0 ? '+' : '' }}{{ formatCurrency(dashboard.totalRealizedPnL) }}
            </p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">ç¸½è³‡ç”¢</h3>
            <p class="text-2xl font-bold text-slate-800 mt-2">{{ formatCurrency(dashboard.cash + dashboard.investedAmount) }}</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-2 space-y-6">
            
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <h2 class="text-sm font-bold text-slate-700 mb-4 uppercase">æ–°å¢äº¤æ˜“ç´€éŒ„</h2>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                    <div class="col-span-2 md:col-span-1"><input type="date" v-model="form.date" class="w-full border border-slate-300 rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></div>
                    <div class="col-span-2 md:col-span-1"><select v-model="form.type" class="w-full border border-slate-300 rounded p-2 text-sm"><option value="buy">è²·å…¥</option><option value="sell">è³£å‡º</option></select></div>
                    <div class="col-span-2 md:col-span-1"><input type="text" v-model="form.symbol" placeholder="ä»£è™Ÿ (å¦‚ 2330)" class="w-full border border-slate-300 rounded p-2 text-sm uppercase"></div>
                    <div class="col-span-1"><input type="number" step="0.01" v-model.number="form.price" placeholder="åƒ¹æ ¼" class="w-full border border-slate-300 rounded p-2 text-sm"></div>
                    <div class="col-span-1"><input type="number" v-model.number="form.shares" placeholder="è‚¡æ•¸" class="w-full border border-slate-300 rounded p-2 text-sm"></div>
                    <div class="col-span-2 md:col-span-1"><button @click="addTransaction" class="w-full bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700 text-sm font-medium transition">æ–°å¢</button></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                    <h2 class="font-bold text-slate-700 text-sm">ç•¶å‰æŒå€‰</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 uppercase text-xs">
                            <tr><th class="p-3">ä»£è™Ÿ</th><th class="p-3 text-right">è‚¡æ•¸</th><th class="p-3 text-right">å¹³å‡æˆæœ¬</th><th class="p-3 text-center">AI åˆ†æ</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="(holding, symbol) in dashboard.holdings" :key="symbol" v-show="holding.shares > 0" class="hover:bg-slate-50">
                                <td class="p-3 font-bold text-slate-700">{{ symbol }}</td>
                                <td class="p-3 text-right">{{ holding.shares }}</td>
                                <td class="p-3 text-right text-slate-500">{{ formatCurrency(holding.avgCost, 2) }}</td>
                                <td class="p-3 text-center">
                                    <button @click="openAIModal(symbol)" class="group bg-white border border-indigo-200 text-indigo-600 px-3 py-1 rounded-full text-xs hover:bg-indigo-50 hover:border-indigo-300 transition flex items-center gap-1 mx-auto shadow-sm">
                                        <span class="group-hover:scale-110 transition-transform">âœ¨</span> AI è§£è®€
                                    </button>
                                </td>
                            </tr>
                            <tr v-if="Object.keys(dashboard.holdings).length === 0"><td colspan="4" class="p-8 text-center text-slate-400">ç›®å‰ç„¡æŒå€‰</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

             <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50"><h2 class="font-bold text-slate-700 text-sm">äº¤æ˜“æ˜ç´°</h2></div>
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 uppercase text-xs sticky top-0">
                            <tr><th class="p-3">æ—¥æœŸ</th><th class="p-3">ä»£è™Ÿ</th><th class="p-3">é¡åˆ¥</th><th class="p-3 text-right">åƒ¹æ ¼</th><th class="p-3 text-right">è‚¡æ•¸</th><th class="p-3 text-right">æç›Š</th><th class="p-3"></th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="t in sortedTransactions" :key="t.id" class="hover:bg-slate-50">
                                <td class="p-3 text-slate-500">{{ t.date }}</td>
                                <td class="p-3 font-bold text-slate-700">{{ t.symbol }}</td>
                                <td class="p-3"><span :class="t.type==='buy'?'bg-red-50 text-red-600 border-red-100':'bg-green-50 text-green-600 border-green-100'" class="px-2 py-0.5 rounded text-xs border">{{ t.type==='buy'?'è²·å…¥':'è³£å‡º' }}</span></td>
                                <td class="p-3 text-right">{{ formatCurrency(t.price) }}</td>
                                <td class="p-3 text-right">{{ t.shares }}</td>
                                <td class="p-3 text-right font-bold"><span v-if="t.type==='sell'" :class="t.realizedPnL>=0?'text-up':'text-down'">{{ t.realizedPnL>=0?'+':'' }}{{ formatCurrency(t.realizedPnL, 0) }}</span><span v-else class="text-slate-300">-</span></td>
                                <td class="p-3 text-center"><button @click="removeTransaction(t.id)" class="text-slate-300 hover:text-red-500 transition">Ã—</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-sm p-5 border border-slate-200">
                <h2 class="font-bold text-slate-700 border-b border-slate-100 pb-2 mb-2 text-sm uppercase">æœˆåº¦æç›Šçµ±è¨ˆ</h2>
                <div v-for="(stat, month) in dashboard.monthlyStats" :key="month" class="flex justify-between py-2 border-b border-slate-50 last:border-0 text-sm">
                    <span class="text-slate-600 font-medium">{{ month }}</span>
                    <span :class="stat.pnl >= 0 ? 'text-up' : 'text-down'" class="font-bold">{{ stat.pnl >= 0 ? '+' : '' }}{{ formatCurrency(stat.pnl, 0) }}</span>
                </div>
                <div v-if="Object.keys(dashboard.monthlyStats).length === 0" class="text-center text-slate-400 py-4 text-xs">å°šç„¡è³£å‡ºç´€éŒ„</div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-5 border border-slate-200">
                <div class="flex justify-between items-center border-b border-slate-100 pb-2 mb-2">
                    <h2 class="font-bold text-slate-700 text-sm uppercase">è³‡é‡‘è®Šå‹•ç´€éŒ„</h2>
                </div>
                <div class="max-h-64 overflow-y-auto space-y-2">
                    <div v-for="adj in sortedAdjustments" :key="adj.id" class="flex justify-between text-sm py-1 border-b border-slate-50 last:border-0">
                        <div class="flex flex-col">
                            <span class="text-slate-400 text-xs">{{ adj.date }}</span>
                            <span class="text-slate-700">{{ adj.note }}</span>
                        </div>
                        <span :class="adj.amount>=0?'text-blue-600':'text-orange-600'" class="font-medium self-center">{{ adj.amount>=0?'+':''}}{{ formatCurrency(adj.amount, 0) }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showAIModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[85vh] shadow-2xl flex flex-col overflow-hidden relative border border-slate-200">
            <div class="p-5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white flex justify-between items-center">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <span>ğŸ¤–</span> AI æŠ•è³‡åŠ©ç† - {{ selectedSymbol }}
                </h3>
                <button @click="showAIModal = false" class="text-indigo-100 hover:text-white text-2xl transition">&times;</button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 bg-slate-50">
                
                <div v-if="aiLoading" class="flex flex-col items-center justify-center py-12 space-y-6">
                    <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center ai-glow">
                        <div class="loader"></div>
                    </div>
                    <div class="text-center">
                        <p class="text-indigo-800 font-bold text-lg">AI æ­£åœ¨æœå°‹æ–°èèˆ‡è«–å£‡...</p>
                        <p class="text-slate-500 text-sm mt-1">æœå°‹ Google News â€¢ çˆ¬å– Reddit / è«–å£‡å ±å° â€¢ ç¶œåˆåˆ†æ</p>
                    </div>
                </div>

                <div v-else>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-indigo-100 mb-6">
                        <div class="flex items-center gap-2 mb-4">
                            <span class="bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded text-xs font-bold border border-indigo-100">Gemini 1.5 Flash</span>
                            <span class="text-slate-400 text-xs">AI Market Analysis</span>
                        </div>
                        <div class="prose prose-sm max-w-none" v-html="aiContentParsed"></div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <a :href="`https://www.google.com/search?q=${selectedSymbol}+site:ptt.cc`" target="_blank" class="flex items-center justify-center py-2 bg-slate-800 text-white rounded-lg text-xs hover:bg-slate-900 transition">PTT è¨è«–</a>
                        <a :href="`https://tw.stock.yahoo.com/quote/${selectedSymbol}/discussion`" target="_blank" class="flex items-center justify-center py-2 bg-purple-600 text-white rounded-lg text-xs hover:bg-purple-700 transition">Yahoo è¨è«–</a>
                        <a :href="`https://www.mobile01.com/googlesearch.php?q=${selectedSymbol}`" target="_blank" class="flex items-center justify-center py-2 bg-green-600 text-white rounded-lg text-xs hover:bg-green-700 transition">Mobile01</a>
                        <a :href="`https://www.google.com/search?q=${selectedSymbol}+stock+news`" target="_blank" class="flex items-center justify-center py-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg text-xs hover:bg-blue-100 transition">æ›´å¤šæ–°è</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div v-if="showCashModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-80 shadow-xl">
            <h3 class="font-bold mb-4 text-slate-700">è³‡é‡‘èª¿æ•´</h3>
            <input type="date" v-model="cashForm.date" class="w-full border rounded p-2 mb-2 text-sm">
            <input type="number" v-model.number="cashForm.amount" class="w-full border rounded p-2 mb-2 text-sm" placeholder="é‡‘é¡ (è² æ•¸ç‚ºå‡ºé‡‘)">
            <input type="text" v-model="cashForm.note" class="w-full border rounded p-2 mb-4 text-sm" placeholder="å‚™è¨» (ä¾‹å¦‚: å…¥é‡‘)">
            <div class="flex gap-2"><button @click="addCashAdjustment" class="flex-1 bg-indigo-600 text-white py-2 rounded text-sm hover:bg-indigo-700">ç¢ºèª</button><button @click="showCashModal = false" class="flex-1 bg-slate-100 text-slate-600 py-2 rounded text-sm hover:bg-slate-200">å–æ¶ˆ</button></div>
        </div>
    </div>

</div>

<script>
    const { createApp, reactive, computed, onMounted, ref } = Vue;

    // ==========================================
    // ğŸ”´ è¨­å®šå€ (è«‹å‹™å¿…ä¿®æ”¹é€™è£¡)
    // ==========================================
    const API_URL = 'https://script.google.com/macros/s/AKfycbwP5jPb7oLdEhj962kOt9umpKlNkcwhcApm8QOQ3iDDNcInpUpxNObFUeMD4LHmMkSK/exec';
    // ==========================================

    createApp({
        setup() {
            const transactions = ref([]);
            const cashAdjustments = ref([]);
            const showCashModal = ref(false);
            const isLoading = ref(false);
            
            // å®‰å…¨æ€§ï¼šå¯†ç¢¼ç®¡ç†
            const password = ref(localStorage.getItem('portfolio_password') || '');

            // AI ç›¸é—œ
            const showAIModal = ref(false);
            const aiLoading = ref(false);
            const selectedSymbol = ref('');
            const aiContent = ref('');

            const form = reactive({ date: new Date().toISOString().split('T')[0], type: 'buy', symbol: '', price: '', shares: '' });
            const cashForm = reactive({ date: new Date().toISOString().split('T')[0], amount: '', note: '' });

            onMounted(() => {
                if (password.value) fetchData();
            });

            // å¯†ç¢¼æª¢æŸ¥é‚è¼¯
            const checkPassword = () => {
                if (!password.value) {
                    const input = prompt('è«‹è¼¸å…¥å­˜å–å¯†ç¢¼ (Access Password)ï¼š');
                    if (input) {
                        password.value = input;
                        localStorage.setItem('portfolio_password', input);
                    } else {
                        alert('éœ€è¦å¯†ç¢¼æ‰èƒ½å­˜å–æ•¸æ“šã€‚');
                        return false;
                    }
                }
                return true;
            };

            const resetPassword = () => {
                localStorage.removeItem('portfolio_password');
                password.value = '';
                alert('å¯†ç¢¼å·²æ¸…é™¤ï¼Œä¸‹æ¬¡æ“ä½œéœ€é‡æ–°è¼¸å…¥ã€‚');
            };

            // Markdown
            const aiContentParsed = computed(() => {
                return aiContent.value ? marked.parse(aiContent.value) : '';
            });

            // API: è®€å–
            const fetchData = async () => {
                if (!checkPassword()) return;
                if (API_URL === 'YOUR_GOOGLE_SCRIPT_URL') return alert('è«‹å…ˆè¨­å®š API URLï¼');
                
                isLoading.value = true;
                try {
                    // é€é URL åƒæ•¸å‚³é password
                    const res = await fetch(`${API_URL}?action=read&password=${encodeURIComponent(password.value)}`);
                    const data = await res.json();
                    
                    if (data.status === 'error') {
                        throw new Error(data.message);
                    }
                    
                    transactions.value = data.transactions || [];
                    cashAdjustments.value = data.cashAdjustments || [];
                } catch (e) {
                    // å¦‚æœå¯†ç¢¼éŒ¯èª¤ï¼Œæ¸…é™¤æœ¬åœ°å¯†ç¢¼
                    if(e.message.includes('å¯†ç¢¼éŒ¯èª¤')) resetPassword();
                    alert(e.message);
                } finally {
                    isLoading.value = false;
                }
            };

            // API: å„²å­˜
            const saveData = async () => {
                if (!checkPassword()) return;
                if(!confirm('ç¢ºå®šè¦å„²å­˜è®Šæ›´å—ï¼Ÿ')) return;
                
                try {
                    const res = await fetch(`${API_URL}?action=save&password=${encodeURIComponent(password.value)}`, {
                        method: 'POST', 
                        body: JSON.stringify({ transactions: transactions.value, cashAdjustments: cashAdjustments.value })
                    });
                    const data = await res.json();
                    if(data.status === 'error') throw new Error(data.message);
                    alert('å„²å­˜æˆåŠŸï¼');
                } catch (e) { 
                    alert('å„²å­˜å¤±æ•—: ' + e.message); 
                }
            };

            // API: AI åˆ†æ
            const openAIModal = async (symbol) => {
                if (!checkPassword()) return;
                
                selectedSymbol.value = symbol;
                showAIModal.value = true;
                aiLoading.value = true;
                aiContent.value = '';

                try {
                    const res = await fetch(`${API_URL}?action=analyze&symbol=${symbol}&password=${encodeURIComponent(password.value)}`);
                    const data = await res.json();
                    
                    if (data.status === 'success') {
                        aiContent.value = data.analysis;
                    } else {
                        aiContent.value = `**åˆ†æå¤±æ•—**ï¼š${data.message || 'æœªçŸ¥éŒ¯èª¤'}`;
                    }
                } catch (e) {
                    aiContent.value = `**é€£ç·šéŒ¯èª¤**ï¼š${e.message}`;
                } finally {
                    aiLoading.value = false;
                }
            };

            // æ ¸å¿ƒè¨ˆç®—é‚è¼¯
            const dashboard = computed(() => {
                let cash = 0;
                let holdings = {};
                let totalRealizedPnL = 0;
                let investedAmount = 0;
                let monthlyStats = {};

                cashAdjustments.value.forEach(adj => cash += adj.amount);
                
                const sorted = [...transactions.value].sort((a,b) => new Date(a.date)-new Date(b.date));
                sorted.forEach(t => {
                    const sym = t.symbol.toUpperCase();
                    if(!holdings[sym]) holdings[sym] = {shares:0, totalCost:0, avgCost:0};
                    const amt = t.price * t.shares;
                    
                    if(t.type === 'buy') {
                        cash -= amt;
                        holdings[sym].totalCost += amt;
                        holdings[sym].shares += t.shares;
                        if(holdings[sym].shares>0) holdings[sym].avgCost = holdings[sym].totalCost/holdings[sym].shares;
                    } else {
                        cash += amt;
                        const cost = holdings[sym].avgCost * t.shares;
                        const pnl = amt - cost;
                        totalRealizedPnL += pnl;
                        const m = t.date.substring(0,7);
                        if(!monthlyStats[m]) monthlyStats[m] = {pnl:0};
                        monthlyStats[m].pnl += pnl;
                        holdings[sym].shares -= t.shares;
                        holdings[sym].totalCost -= cost;
                    }
                });

                for(let s in holdings) if(holdings[s].shares>0) investedAmount += holdings[s].totalCost;
                
                // æœˆä»½å€’åº
                const sortedMonthly = Object.keys(monthlyStats).sort().reverse().reduce((obj, key) => { obj[key] = monthlyStats[key]; return obj; }, {});

                return { cash, holdings, totalRealizedPnL, investedAmount, monthlyStats: sortedMonthly };
            });

            const sortedTransactions = computed(() => {
                const chronological = [...transactions.value].sort((a,b)=>new Date(a.date)-new Date(b.date));
                const tempHoldings = {};
                const res = chronological.map(t => {
                    const sym = t.symbol.toUpperCase();
                    if(!tempHoldings[sym]) tempHoldings[sym] = {shares:0, totalCost:0, avgCost:0};
                    let realizedPnL = 0;
                    const amt = t.price * t.shares;
                    if(t.type==='buy'){
                         tempHoldings[sym].totalCost+=amt; tempHoldings[sym].shares+=t.shares;
                         if(tempHoldings[sym].shares>0) tempHoldings[sym].avgCost=tempHoldings[sym].totalCost/tempHoldings[sym].shares;
                    } else {
                        const cost = tempHoldings[sym].avgCost * t.shares;
                        realizedPnL = amt - cost;
                        tempHoldings[sym].shares-=t.shares; tempHoldings[sym].totalCost-=cost;
                    }
                    return {...t, realizedPnL};
                });
                return res.sort((a,b)=>new Date(b.date)-new Date(a.date));
            });
            
            const sortedAdjustments = computed(() => [...cashAdjustments.value].sort((a,b)=>new Date(b.date)-new Date(a.date)));

            const addTransaction = () => {
                if(!form.symbol) return;
                transactions.value.push({ id:Date.now(), date:form.date, type:form.type, symbol:form.symbol.toUpperCase(), price:form.price, shares:form.shares });
                form.symbol=''; form.price=''; form.shares='';
            };
            const removeTransaction = (id) => { if(confirm('åˆªé™¤?')) transactions.value=transactions.value.filter(t=>t.id!==id); };
            const addCashAdjustment = () => { cashAdjustments.value.push({id:Date.now(), date:cashForm.date, amount:cashForm.amount, note:cashForm.note}); showCashModal.value=false; };

            const formatCurrency = (val, d=0) => (val||0).toLocaleString('en-US', {minimumFractionDigits:d, maximumFractionDigits:d});

            return {
                API_URL, dashboard, form, cashForm, showCashModal, password, isLoading,
                transactions, cashAdjustments, sortedTransactions, sortedAdjustments,
                fetchData, saveData, addTransaction, removeTransaction, addCashAdjustment, formatCurrency, resetPassword,
                showAIModal, aiLoading, selectedSymbol, aiContentParsed, openAIModal
            };
        }
    }).mount('#app');
</script>
</body>
</html>
