<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾è‚¡æŠ•è³‡çµ„åˆ (AI Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; color: #334155; }
        .text-up { color: #16a34a; } .text-down { color: #dc2626; } 
        .loader { border: 3px solid #e2e8f0; border-top: 3px solid #2563eb; width: 24px; height: 24px; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ai-glow { box-shadow: 0 0 20px rgba(37, 99, 235, 0.3); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }
        .board-enter-active, .board-leave-active { transition: all 0.5s ease; }
        .board-enter-from, .board-leave-to { opacity: 0; transform: translateY(20px); }
        .markdown-sm p { margin-bottom: 4px; }
        .markdown-sm ul { list-style-type: disc; padding-left: 14px; margin-bottom: 4px; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 md:p-8 max-w-7xl mx-auto pb-32">
    
    <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-2xl font-extrabold text-slate-900 flex items-center gap-2 tracking-tight">
                ç¾è‚¡æŠ•è³‡çµ„åˆ
                <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded-md font-bold tracking-wide flex items-center gap-1 shadow-sm">Gemini 2.5 Pro</span>
            </h1>
            <p class="text-slate-500 text-sm font-medium">æŒå€‰ç®¡ç† â€¢ æ½›åœ¨ç›®æ¨™ â€¢ æŠ•è³‡å»ºè­°çœ‹æ¿</p>
        </div>
        <div class="flex gap-2">
            <button @click="resetPassword" class="px-3 py-2 text-xs text-slate-400 hover:text-slate-600 underline font-medium">é‡è¨­å¯†ç¢¼</button>
            <button @click="fetchData" class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg shadow-sm hover:bg-slate-50 text-sm font-bold transition flex items-center gap-2">
                <span v-if="isLoading" class="loader w-4 h-4 border-slate-400 border-t-transparent"></span>
                <span>{{ isLoading ? 'åŒæ­¥ä¸­...' : 'ğŸ”„ åŒæ­¥æ•¸æ“š' }}</span>
            </button>
            <button @click="saveData" class="px-4 py-2 bg-slate-900 text-white rounded-lg shadow-md hover:bg-slate-800 text-sm font-bold transition">ğŸ’¾ å„²å­˜è®Šæ›´</button>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">å¯ç”¨ç¾é‡‘</h3><p class="text-2xl font-bold text-slate-800 mt-2">${{ formatCurrency(dashboard.cash) }}</p></div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">æŒå€‰ç¸½æˆæœ¬</h3><p class="text-2xl font-bold text-slate-800 mt-2">${{ formatCurrency(dashboard.investedAmount) }}</p></div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">å·²å¯¦ç¾æç›Š</h3><p class="text-2xl font-bold mt-2" :class="dashboard.totalRealizedPnL >= 0 ? 'text-up' : 'text-down'">{{ dashboard.totalRealizedPnL >= 0 ? '+' : '' }}${{ formatCurrency(dashboard.totalRealizedPnL) }}</p></div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">æ·¨è³‡ç”¢</h3><p class="text-2xl font-bold text-slate-800 mt-2">${{ formatCurrency(dashboard.cash + dashboard.investedAmount) }}</p></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <h2 class="text-sm font-bold text-slate-700 mb-4 uppercase">æ–°å¢äº¤æ˜“</h2>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                    <div class="col-span-2 md:col-span-1"><input type="date" v-model="form.date" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none"></div>
                    <div class="col-span-2 md:col-span-1"><select v-model="form.type" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm font-medium"><option value="buy">è²·å…¥</option><option value="sell">è³£å‡º</option></select></div>
                    <div class="col-span-2 md:col-span-1"><input type="text" v-model="form.symbol" placeholder="ä»£è™Ÿ" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm uppercase font-bold"></div>
                    <div class="col-span-1"><input type="number" v-model.number="form.price" placeholder="åƒ¹æ ¼" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm"></div>
                    <div class="col-span-1"><input type="number" v-model.number="form.shares" placeholder="è‚¡æ•¸" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm"></div>
                    <div class="col-span-2 md:col-span-1"><button @click="addTransaction" class="w-full bg-blue-600 text-white p-2.5 rounded-lg hover:bg-blue-700 text-sm font-bold transition">æ–°å¢</button></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center"><h2 class="font-bold text-slate-700 text-sm uppercase">ç•¶å‰æŒå€‰</h2></div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 uppercase text-xs font-semibold">
                            <tr><th class="p-3">ä»£è™Ÿ</th><th class="p-3 text-right">è‚¡æ•¸</th><th class="p-3 text-right">å‡åƒ¹</th><th class="p-3 text-right text-blue-700">ç¸½æˆæœ¬</th><th class="p-3 text-center">AI</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="(holding, symbol) in dashboard.holdings" :key="symbol" v-show="holding.shares > 0">
                                <td class="p-3 font-bold text-slate-800">{{ symbol }}</td>
                                <td class="p-3 text-right">{{ holding.shares }}</td>
                                <td class="p-3 text-right text-slate-500">${{ formatCurrency(holding.avgCost, 2) }}</td>
                                <td class="p-3 text-right font-bold text-blue-700">${{ formatCurrency(holding.totalCost, 0) }}</td>
                                <td class="p-3 text-center"><button @click="openAIModal(symbol)" class="bg-white border border-blue-200 text-blue-600 px-3 py-1 rounded-full text-xs font-bold hover:bg-blue-50">è§£è®€</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden border-t-4 border-t-orange-400">
                <div class="p-4 border-b border-slate-100 bg-orange-50 flex justify-between items-center"><h2 class="font-bold text-orange-800 text-sm uppercase">æ½›åœ¨é—œæ³¨ç›®æ¨™ (Watchlist)</h2></div>
                <div class="p-4 bg-white border-b border-slate-100 flex gap-2">
                    <input type="text" v-model="newWatchSymbol" placeholder="è¼¸å…¥ä»£è™Ÿ (ä¾‹å¦‚ TSLA)" class="flex-1 border border-slate-300 rounded-lg p-2 text-sm uppercase font-bold focus:ring-2 focus:ring-orange-400 outline-none">
                    <button @click="addWatchlist" class="bg-orange-500 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-orange-600 transition shadow-sm">åŠ å…¥</button>
                </div>
                <table class="w-full text-sm text-left"><tbody class="divide-y divide-slate-100"><tr v-for="item in sortedWatchlist" :key="item.id" class="hover:bg-orange-50/50"><td class="p-3 font-bold text-slate-800 w-1/4">{{ item.symbol }}</td><td class="p-3 text-slate-400 text-xs w-1/4">Added: {{ item.addedDate }}</td><td class="p-3 text-center"><button @click="openAIModal(item.symbol)" class="bg-white border border-orange-200 text-orange-600 px-3 py-1 rounded-full text-xs font-bold hover:bg-orange-50">AI åˆ†æ</button></td><td class="p-3 text-right"><button @click="removeWatchlist(item.id)" class="text-slate-300 hover:text-red-500 font-bold px-2 py-1">ç§»é™¤</button></td></tr></tbody></table>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-sm p-5 border border-slate-200">
                <h2 class="font-bold text-slate-700 border-b border-slate-100 pb-2 mb-2 text-sm uppercase">æœˆåº¦æç›Š</h2>
                <div v-for="(stat, month) in dashboard.monthlyStats" :key="month" class="flex justify-between py-2 border-b border-slate-50 last:border-0 text-sm">
                    <span class="text-slate-600 font-medium">{{ month }}</span>
                    <span :class="stat.pnl >= 0 ? 'text-up' : 'text-down'" class="font-bold">{{ stat.pnl >= 0 ? '+' : '' }}${{ formatCurrency(stat.pnl, 0) }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end gap-2">
        <transition name="board">
            <div v-if="showBoard" class="bg-white p-0 rounded-xl shadow-2xl border border-slate-200 w-96 overflow-hidden flex flex-col max-h-[600px]">
                <div class="bg-slate-900 text-white p-3 flex justify-between items-center flex-shrink-0">
                    <h3 class="font-bold text-sm flex items-center gap-2">ğŸ“¢ AI æŠ•è³‡å»ºè­°å…¬å‘Š</h3>
                    <button @click="showBoard = false" class="text-slate-400 hover:text-white">&times;</button>
                </div>
                
                <div class="overflow-y-auto flex-1">
                    <div v-for="rec in sortedRecommendations" :key="rec.id" class="p-3 border-b border-slate-100 hover:bg-slate-50 text-sm relative group">
                        
                        <button @click="removeRecommendation(rec.id)" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 font-bold px-2" title="åˆªé™¤æ­¤å…¬å‘Š">Ã—</button>

                        <div class="flex justify-between items-center mb-1 pr-6">
                            <span class="font-bold text-slate-800 text-base">{{ rec.symbol }}</span>
                            <span class="text-xs text-slate-400">{{ rec.date }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex gap-2">
                                <span :class="rec.type === 'Buy' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'" class="px-2 py-0.5 rounded text-xs font-bold">{{ rec.type === 'Buy' ? 'è²·å…¥' : 'è³£å‡º' }}</span>
                                <span class="text-xs text-orange-600 bg-orange-50 px-2 py-0.5 rounded border border-orange-100">AIæ•¸: {{ rec.count }}</span>
                            </div>
                            <span class="text-slate-600 font-bold">@ ${{ formatCurrency(rec.price) }}</span>
                        </div>
                        
                        <div v-if="rec.analysis" class="mt-2">
                            <button @click="rec.showDetails = !rec.showDetails" class="text-xs text-blue-500 hover:text-blue-700 underline flex items-center gap-1">
                                {{ rec.showDetails ? 'æ”¶èµ·è§£è®€' : 'æŸ¥çœ‹ AI è§€é»' }}
                                <span v-if="!rec.showDetails">â–¼</span><span v-else>â–²</span>
                            </button>
                            <div v-if="rec.showDetails" class="mt-2 p-2 bg-slate-100 rounded text-xs text-slate-600 leading-relaxed markdown-sm" v-html="marked.parse(rec.analysis)"></div>
                        </div>
                    </div>
                    <div v-if="recommendations.length === 0" class="p-4 text-center text-slate-400 text-xs">å°šç„¡å»ºè­°</div>
                </div>

                <div class="p-3 bg-slate-50 border-t border-slate-100 flex-shrink-0">
                    <button @click="showRecForm = !showRecForm" class="w-full bg-blue-600 text-white py-1.5 rounded text-xs font-bold hover:bg-blue-700">{{ showRecForm ? 'å–æ¶ˆ' : '+ ç™¼å¸ƒæ–°å»ºè­°' }}</button>
                    
                    <div v-if="showRecForm" class="mt-3 space-y-2">
                        <div class="flex gap-2">
                            <input v-model="recForm.symbol" placeholder="ä»£è™Ÿ" class="w-1/3 border p-1.5 rounded text-xs uppercase font-bold">
                            <input v-model.number="recForm.price" type="number" placeholder="åƒ¹æ ¼" class="w-1/3 border p-1.5 rounded text-xs">
                            <input v-model.number="recForm.count" type="number" placeholder="AIæ•¸" class="w-1/3 border p-1.5 rounded text-xs">
                        </div>
                        <select v-model="recForm.type" class="w-full border p-1.5 rounded text-xs"><option value="Buy">è²·å…¥</option><option value="Sell">è³£å‡º</option></select>
                        
                        <div class="flex justify-between items-end">
                            <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">è§€é»æ‘˜è¦ / è§£è®€</span>
                            <button @click="generateAnalysis" :disabled="isGeneratingAnalysis" class="text-[10px] bg-purple-100 text-purple-700 border border-purple-200 px-2 py-0.5 rounded font-bold hover:bg-purple-200 flex items-center gap-1">
                                <span v-if="isGeneratingAnalysis" class="loader !w-3 !h-3 !border-2 !border-purple-300 !border-t-purple-600"></span>
                                {{ isGeneratingAnalysis ? 'ç”Ÿæˆä¸­...' : 'âœ¨ AI è‡ªå‹•ç”Ÿæˆ' }}
                            </button>
                        </div>
                        
                        <textarea v-model="recForm.analysis" placeholder="è¼¸å…¥å…§å®¹æˆ–é»æ“Šä¸Šæ–¹æŒ‰éˆ•ç”Ÿæˆç•¶ä¸‹ AI åˆ†æ..." rows="3" class="w-full border p-1.5 rounded text-xs focus:ring-1 focus:ring-blue-500"></textarea>

                        <button @click="addRecommendation" class="w-full bg-slate-800 text-white py-1.5 rounded text-xs hover:bg-slate-900 mt-1">ç¢ºèªç™¼å¸ƒ</button>
                    </div>
                </div>
            </div>
        </transition>
        <button v-if="!showBoard" @click="showBoard = true" class="bg-slate-900 text-white p-3 rounded-full shadow-lg hover:bg-slate-800 transition transform hover:scale-110 flex items-center gap-2 pr-4">
            <span class="text-xl">ğŸ“¢</span><span class="text-sm font-bold">å…¬å‘Š</span>
            <span v-if="recommendations.length > 0" class="bg-red-500 text-white text-[10px] px-1.5 rounded-full absolute -top-1 -right-1">{{ recommendations.length }}</span>
        </button>
    </div>

    <div v-if="showAIModal" class="fixed inset-0 bg-slate-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[85vh] shadow-2xl flex flex-col overflow-hidden relative border border-slate-200">
            <div class="p-5 bg-gradient-to-r from-slate-800 to-slate-900 text-white flex justify-between items-center"><h3 class="text-lg font-bold flex items-center gap-2"><span class="text-blue-400">ğŸ¤–</span> AI åˆ†æ - {{ selectedSymbol }}</h3><button @click="showAIModal = false" class="text-slate-400 hover:text-white text-2xl">&times;</button></div>
            <div class="flex-1 overflow-y-auto p-6 bg-slate-50">
                <div v-if="aiLoading" class="flex flex-col items-center justify-center py-12 space-y-6"><div class="w-16 h-16 bg-white rounded-full flex items-center justify-center ai-glow border border-blue-100"><div class="loader"></div></div><p class="text-slate-800 font-bold">AI æ­£åœ¨æ€è€ƒ...</p></div>
                <div v-else>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-blue-100 mb-6"><div class="prose prose-sm max-w-none text-slate-700" v-html="aiContentParsed"></div></div>
                </div>
            </div>
        </div>
    </div>
    
    <div v-if="showCashModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-80 shadow-xl border border-slate-100">
            <h3 class="font-bold mb-4 text-slate-800 uppercase text-sm">èª¿æ•´è³‡é‡‘</h3>
            <input type="date" v-model="cashForm.date" class="w-full border rounded-lg p-2.5 mb-3 text-sm">
            <input type="number" v-model.number="cashForm.amount" class="w-full border rounded-lg p-2.5 mb-3 text-sm" placeholder="é‡‘é¡ (è² æ•¸=å‡ºé‡‘)">
            <input type="text" v-model="cashForm.note" class="w-full border rounded-lg p-2.5 mb-5 text-sm" placeholder="å‚™è¨»">
            <div class="flex gap-2"><button @click="addCashAdjustment" class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg text-sm font-bold">ç¢ºèª</button><button @click="showCashModal = false" class="flex-1 bg-slate-100 text-slate-600 py-2.5 rounded-lg text-sm font-bold">å–æ¶ˆ</button></div>
        </div>
    </div>
</div>

<script>
    const { createApp, reactive, computed, onMounted, ref } = Vue;

    // ==========================================
    // ğŸ”´ é€™è£¡å¿…é ˆå¡«å…¥æ‚¨çš„ Apps Script ç¶²å€ (çµå°¾æ˜¯ /exec)
    // ==========================================
    const API_URL = 'https://script.google.com/macros/s/AKfycbx95Q2OXfIP7X-ygDW-fpoJESl6lAUk6bY1h8JW0_ipq8ErmG5YPPYkekXHfBscpGRr/exec'; 
    // ==========================================

    createApp({
        setup() {
            const transactions = ref([]);
            const cashAdjustments = ref([]);
            const watchlist = ref([]); 
            const recommendations = ref([]); // AI å»ºè­°
            const showCashModal = ref(false);
            const isLoading = ref(false);
            const password = ref(localStorage.getItem('portfolio_password') || '');
            const showAIModal = ref(false);
            const aiLoading = ref(false);
            const selectedSymbol = ref('');
            const aiContent = ref('');
            const showBoard = ref(true); 
            const showRecForm = ref(false);
            const isGeneratingAnalysis = ref(false);
            
            const form = reactive({ date: new Date().toISOString().split('T')[0], type: 'buy', symbol: '', price: '', shares: '' });
            const cashForm = reactive({ date: new Date().toISOString().split('T')[0], amount: '', note: '' });
            const recForm = reactive({ symbol: '', type: 'Buy', price: '', count: 1, analysis: '' });
            const newWatchSymbol = ref('');

            onMounted(() => { if (password.value) fetchData(); });

            const checkPassword = () => {
                if (!password.value) {
                    const input = prompt('è«‹è¼¸å…¥å¯†ç¢¼ï¼š');
                    if (input) { password.value = input; localStorage.setItem('portfolio_password', input); } 
                    else { alert('éœ€è¦å¯†ç¢¼'); return false; }
                }
                return true;
            };
            const resetPassword = () => { localStorage.removeItem('portfolio_password'); password.value = ''; alert('å¯†ç¢¼å·²æ¸…é™¤'); };
            const aiContentParsed = computed(() => aiContent.value ? marked.parse(aiContent.value) : '');

            const fetchData = async () => {
                if (!checkPassword()) return;
                isLoading.value = true;
                try {
                    const res = await fetch(`${API_URL}?action=read&password=${encodeURIComponent(password.value)}`);
                    const data = await res.json();
                    if (data.status === 'error') throw new Error(data.message);
                    transactions.value = data.transactions || [];
                    cashAdjustments.value = data.cashAdjustments || [];
                    watchlist.value = data.watchlist || [];
                    recommendations.value = (data.recommendations || []).map(r => ({...r, showDetails: false}));
                } catch (e) {
                    if(e.message.includes('Wrong Password')) resetPassword();
                    alert(e.message);
                } finally { isLoading.value = false; }
            };

            const saveData = async () => {
                if (!checkPassword()) return;
                if(!confirm('å„²å­˜è®Šæ›´ï¼Ÿ')) return;
                try {
                    const cleanRecs = recommendations.value.map(({showDetails, ...rest}) => rest);
                    await fetch(`${API_URL}?action=save&password=${encodeURIComponent(password.value)}`, {
                        method: 'POST', body: JSON.stringify({ 
                            transactions: transactions.value, 
                            cashAdjustments: cashAdjustments.value,
                            watchlist: watchlist.value,
                            recommendations: cleanRecs
                        })
                    });
                    alert('å„²å­˜æˆåŠŸï¼');
                } catch (e) { alert('å„²å­˜å¤±æ•—: ' + e.message); }
            };

            const openAIModal = async (symbol) => {
                if (!checkPassword()) return;
                selectedSymbol.value = symbol;
                showAIModal.value = true;
                aiLoading.value = true;
                aiContent.value = '';
                try {
                    const res = await fetch(`${API_URL}?action=analyze&symbol=${symbol}&password=${encodeURIComponent(password.value)}`);
                    const data = await res.json();
                    if (data.status === 'success') aiContent.value = data.analysis;
                    else aiContent.value = `**åˆ†æå¤±æ•—**: ${data.message}`;
                } catch (e) { aiContent.value = `**é€£ç·šéŒ¯èª¤**: ${e.message}`; } finally { aiLoading.value = false; }
            };

            const addWatchlist = () => {
                if (!newWatchSymbol.value) return;
                const sym = newWatchSymbol.value.toUpperCase();
                if (watchlist.value.some(w => w.symbol === sym)) return alert('å·²å­˜åœ¨');
                watchlist.value.push({ id: Date.now(), symbol: sym, addedDate: new Date().toISOString().split('T')[0] });
                newWatchSymbol.value = '';
            };
            const removeWatchlist = (id) => { if(confirm('ç¢ºå®šç§»é™¤ï¼Ÿ')) watchlist.value = watchlist.value.filter(w => w.id !== id); };

            const generateAnalysis = async () => {
                if (!recForm.symbol) return alert('è«‹å…ˆè¼¸å…¥ä»£è™Ÿ (ä¾‹å¦‚ NVDA)');
                if (!checkPassword()) return;
                isGeneratingAnalysis.value = true;
                const symbol = recForm.symbol.toUpperCase();
                try {
                    const res = await fetch(`${API_URL}?action=analyze&symbol=${symbol}&password=${encodeURIComponent(password.value)}`);
                    const data = await res.json();
                    if (data.status === 'success') recForm.analysis = data.analysis;
                    else alert(`åˆ†æå¤±æ•—: ${data.message}`);
                } catch (e) { alert(`é€£ç·šéŒ¯èª¤: ${e.message}`); } finally { isGeneratingAnalysis.value = false; }
            };

            const addRecommendation = () => {
                if (!recForm.symbol || !recForm.price || !recForm.count) return alert('è«‹å¡«å¯«å®Œæ•´');
                const sym = recForm.symbol.toUpperCase();
                recommendations.value.push({ 
                    id: Date.now(), 
                    date: new Date().toISOString().split('T')[0], 
                    type: recForm.type, 
                    symbol: sym, 
                    price: recForm.price, 
                    count: recForm.count,
                    analysis: recForm.analysis,
                    showDetails: false
                });
                recForm.symbol = ''; recForm.price = ''; recForm.count = 1; recForm.analysis = ''; showRecForm = false;
            };

            // ğŸŸ¢ æ–°å¢ï¼šåˆªé™¤å…¬å‘Šå‡½å¼
            const removeRecommendation = (id) => {
                if(confirm('ç¢ºå®šåˆªé™¤æ­¤å…¬å‘Šï¼Ÿ(åˆªé™¤å¾Œè«‹è¨˜å¾—æŒ‰å„²å­˜)')) {
                    recommendations.value = recommendations.value.filter(r => r.id !== id);
                }
            };

            const dashboard = computed(() => {
                let cash = 0, holdings = {}, totalRealizedPnL = 0, investedAmount = 0, monthlyStats = {};
                cashAdjustments.value.forEach(adj => cash += adj.amount);
                const sorted = [...transactions.value].sort((a,b) => new Date(a.date)-new Date(b.date));
                sorted.forEach(t => {
                    const sym = t.symbol.toUpperCase();
                    if(!holdings[sym]) holdings[sym] = {shares:0, totalCost:0, avgCost:0};
                    const amt = t.price * t.shares;
                    if(t.type === 'buy') {
                        cash -= amt; holdings[sym].totalCost += amt; holdings[sym].shares += t.shares;
                        if(holdings[sym].shares > 0) holdings[sym].avgCost = holdings[sym].totalCost / holdings[sym].shares;
                    } else {
                        cash += amt; const cost = holdings[sym].avgCost * t.shares; const pnl = amt - cost;
                        totalRealizedPnL += pnl; const m = t.date.substring(0,7);
                        if(!monthlyStats[m]) monthlyStats[m] = {pnl:0}; monthlyStats[m].pnl += pnl;
                        holdings[sym].shares -= t.shares; holdings[sym].totalCost -= cost;
                    }
                });
                for(let s in holdings) if(holdings[s].shares > 0) investedAmount += holdings[s].totalCost;
                return { cash, holdings, totalRealizedPnL, investedAmount, monthlyStats: Object.keys(monthlyStats).sort().reverse().reduce((obj, key) => { obj[key] = monthlyStats[key]; return obj; }, {}) };
            });

            const sortedTransactions = computed(() => [...transactions.value].sort((a,b)=>new Date(b.date)-new Date(a.date)));
            const sortedWatchlist = computed(() => [...watchlist.value].sort((a,b) => new Date(b.addedDate) - new Date(a.addedDate)));
            const sortedRecommendations = computed(() => [...recommendations.value].sort((a,b) => new Date(b.date) - new Date(a.date)));

            const addTransaction = () => { if(!form.symbol) return; transactions.value.push({ id:Date.now(), date:form.date, type:form.type, symbol:form.symbol.toUpperCase(), price:form.price, shares:form.shares }); form.symbol=''; form.price=''; form.shares=''; };
            const removeTransaction = (id) => { if(confirm('åˆªé™¤ï¼Ÿ')) transactions.value=transactions.value.filter(t=>t.id!==id); };
            const addCashAdjustment = () => { cashAdjustments.value.push({id:Date.now(), date:cashForm.date, amount:cashForm.amount, note:cashForm.note}); showCashModal.value=false; };
            const formatCurrency = (val, d=0) => (val||0).toLocaleString('en-US', {minimumFractionDigits:d, maximumFractionDigits:d});
            
            return { API_URL, dashboard, form, cashForm, showCashModal, password, isLoading, transactions, cashAdjustments, watchlist, recommendations, sortedTransactions, sortedWatchlist, sortedRecommendations, fetchData, saveData, addTransaction, removeTransaction, addCashAdjustment, addWatchlist, removeWatchlist, addRecommendation, removeRecommendation, formatCurrency, resetPassword, showAIModal, aiLoading, selectedSymbol, aiContentParsed, openAIModal, newWatchSymbol, showBoard, showRecForm, recForm, marked, generateAnalysis, isGeneratingAnalysis };
        }
    }).mount('#app');
</script>
</body>
</html>
