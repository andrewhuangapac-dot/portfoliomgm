<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç¾è‚¡æŠ•è³‡ç®¡ç†ç³»çµ± (AI Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8fafc; }
        .text-up { color: #16a34a; } .text-down { color: #dc2626; } 
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ai-card { background: white; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="p-4 md:p-8">
<div id="app" class="max-w-7xl mx-auto pb-32">
    <header class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">ç¾è‚¡æŠ•è³‡çµ„åˆ <span class="text-sm bg-blue-600 text-white px-2 py-1 rounded">Gemini 2.5 Pro</span></h1>
            <p v-if="isLoading" class="text-blue-500 text-xs mt-1 animate-pulse">æ­£åœ¨å¾ Google Finance æŠ“å–æœ€æ–°è‚¡åƒ¹...</p>
        </div>
        <div class="flex gap-2">
            <button @click="fetchData" class="px-4 py-2 bg-white border rounded shadow-sm text-sm font-bold hover:bg-slate-50">ğŸ”„ åŒæ­¥</button>
            <button @click="saveData" class="px-4 py-2 bg-slate-900 text-white rounded shadow text-sm font-bold">ğŸ’¾ å„²å­˜</button>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 text-center">
        <div class="bg-white p-4 rounded-xl border">
            <p class="text-xs text-slate-400 font-bold">å¯ç”¨ç¾é‡‘</p>
            <p class="text-xl font-bold">${{ formatCurrency(dashboard.cash) }}</p>
        </div>
        <div class="bg-white p-4 rounded-xl border">
            <p class="text-xs text-slate-400 font-bold">æŒå€‰æˆæœ¬</p>
            <p class="text-xl font-bold">${{ formatCurrency(dashboard.investedAmount) }}</p>
        </div>
        <div class="bg-white p-4 rounded-xl border">
            <p class="text-xs text-slate-400 font-bold">æœªå¯¦ç¾æç›Š</p>
            <p class="text-xl font-bold" :class="dashboard.totalUnrealized >= 0 ? 'text-up' : 'text-down'">${{ formatCurrency(dashboard.totalUnrealized) }}</p>
        </div>
        <div class="bg-white p-4 rounded-xl border">
            <p class="text-xs text-slate-400 font-bold">å¸³æˆ¶æ·¨å€¼</p>
            <p class="text-xl font-bold text-blue-600">${{ formatCurrency(dashboard.cash + dashboard.investedAmount + dashboard.totalUnrealized) }}</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white rounded-xl border overflow-hidden">
                <div class="p-4 bg-slate-50 border-b font-bold text-sm">ç•¶å‰æŒå€‰ (Holdings)</div>
                <table class="w-full text-sm">
                    <thead class="bg-slate-50 text-slate-500 text-xs">
                        <tr><th class="p-3 text-left">ä»£è™Ÿ</th><th class="p-3 text-right">è‚¡æ•¸</th><th class="p-3 text-right">å‡åƒ¹</th><th class="p-3 text-right">ç¾åƒ¹</th><th class="p-3 text-right">æç›Š</th><th class="p-3"></th></tr>
                    </thead>
                    <tbody class="divide-y">
                        <tr v-for="(h, sym) in dashboard.holdings" :key="sym" v-show="h.shares > 0">
                            <td class="p-3 font-bold">{{ sym }}</td>
                            <td class="p-3 text-right">{{ h.shares }}</td>
                            <td class="p-3 text-right text-slate-400">${{ formatCurrency(h.avgCost, 2) }}</td>
                            <td class="p-3 text-right font-bold text-blue-600">${{ formatCurrency(h.currentPrice, 2) }}</td>
                            <td class="p-3 text-right font-bold" :class="h.unrealizedPnL >= 0 ? 'text-up' : 'text-down'">
                                ${{ formatCurrency(h.unrealizedPnL, 0) }}<br><span class="text-[10px]">{{ h.unrealizedPnLPercent }}%</span>
                            </td>
                            <td class="p-3 text-center"><button @click="openAIModal(sym)" class="text-blue-500 hover:underline text-xs">AIåˆ†æ</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="bg-white p-5 rounded-xl border">
                <h2 class="text-sm font-bold mb-4">æ–°å¢äº¤æ˜“</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <input type="date" v-model="form.date" class="border rounded p-2 text-sm">
                    <select v-model="form.type" class="border rounded p-2 text-sm"><option value="buy">è²·å…¥</option><option value="sell">è³£å‡º</option></select>
                    <input type="text" v-model="form.symbol" placeholder="ä»£è™Ÿ" class="border rounded p-2 text-sm uppercase">
                    <input type="number" step="0.01" v-model.number="form.price" placeholder="åƒ¹æ ¼" class="border rounded p-2 text-sm">
                    <input type="number" v-model.number="form.shares" placeholder="è‚¡æ•¸" class="border rounded p-2 text-sm">
                    <button @click="addTransaction" class="md:col-span-5 bg-blue-600 text-white p-2 rounded font-bold hover:bg-blue-700">ç¢ºèªæ–°å¢</button>
                </div>
            </div>

            <div class="bg-white rounded-xl border overflow-hidden">
                <div class="p-4 bg-slate-50 border-b font-bold text-sm">æ­·å²ç´€éŒ„</div>
                <div class="max-h-64 overflow-y-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-xs"><tr><th class="p-3">æ—¥æœŸ</th><th class="p-3">ä»£è™Ÿ</th><th class="p-3">æ“ä½œ</th><th class="p-3 text-right">æç›Š</th><th class="p-3"></th></tr></thead>
                        <tbody class="divide-y">
                            <tr v-for="t in sortedTransactions" :key="t.id">
                                <td class="p-3 text-xs text-slate-400">{{ t.date }}</td>
                                <td class="p-3 font-bold">{{ t.symbol }}</td>
                                <td class="p-3 text-xs uppercase">{{ t.type }}</td>
                                <td class="p-3 text-right font-bold" :class="t.realizedPnL >= 0 ? 'text-up' : 'text-down'"><span v-if="t.type==='sell'">${{ formatCurrency(t.realizedPnL, 0) }}</span><span v-else class="text-slate-300">-</span></td>
                                <td class="p-3 text-center"><button @click="removeTransaction(t.id)" class="text-slate-300 hover:text-red-500">Ã—</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-xl border overflow-hidden">
                <div class="p-4 bg-slate-900 text-white font-bold text-sm flex justify-between">
                    <span>ğŸ“¢ æŠ•è³‡å»ºè­°å…¬å‘Š</span>
                </div>
                <div class="p-4 bg-slate-50 border-b">
                    <div class="space-y-2">
                        <input v-model="recForm.symbol" placeholder="ä»£è™Ÿ" class="w-full border p-2 text-sm uppercase font-bold">
                        <div class="flex gap-2">
                            <select v-model="recForm.type" class="w-1/2 border p-2 text-sm"><option value="Buy">è²·å…¥</option><option value="Sell">è³£å‡º</option></select>
                            <input v-model.number="recForm.price" step="0.01" type="number" placeholder="å»ºè­°åƒ¹" class="w-1/2 border p-2 text-sm">
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-slate-400">AIåƒè€ƒæ•¸:</span>
                            <input v-model.number="recForm.count" type="number" class="w-full border p-2 text-sm">
                        </div>
                        <button @click="generateAnalysis" :disabled="isGeneratingAnalysis" class="w-full text-xs bg-purple-100 text-purple-700 py-1 rounded font-bold hover:bg-purple-200">
                            {{ isGeneratingAnalysis ? 'AI æ€è€ƒä¸­...' : 'âœ¨ è‡ªå‹•ç”Ÿæˆ AI è§€é»' }}
                        </button>
                        <textarea v-model="recForm.analysis" placeholder="è§€é»æ‘˜è¦..." rows="3" class="w-full border p-2 text-xs"></textarea>
                        <button @click="addRecommendation" class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">ç™¼å¸ƒå…¬å‘Š</button>
                    </div>
                </div>
                <div class="divide-y max-h-96 overflow-y-auto">
                    <div v-for="r in sortedRecommendations" :key="r.id" class="p-4 hover:bg-slate-50 relative group">
                        <button @click="removeRecommendation(r.id)" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 font-bold">Ã—</button>
                        <div class="flex justify-between font-bold"><span>{{ r.symbol }}</span><span class="text-xs text-slate-400">{{ r.date }}</span></div>
                        <div class="flex justify-between text-sm mt-1">
                            <span :class="r.type==='Buy'?'text-up':'text-down'">{{ r.type==='Buy'?'è²·å…¥':'è³£å‡º' }} @ ${{ formatCurrency(r.price, 2) }}</span>
                            <span class="text-xs bg-orange-100 px-1 rounded text-orange-700">AIæ•¸: {{ r.count }}</span>
                        </div>
                        <div v-if="r.analysis" class="mt-2">
                            <button @click="r.showDetails = !r.showDetails" class="text-[10px] text-blue-500 underline">{{ r.showDetails ? 'éš±è—' : 'æŸ¥çœ‹è§€é»' }}</button>
                            <div v-if="r.showDetails" class="mt-2 text-xs text-slate-600 bg-slate-100 p-2 rounded leading-relaxed" v-html="marked.parse(r.analysis)"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showAIModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
            <div class="p-4 bg-slate-900 text-white flex justify-between font-bold"><span>ğŸ¤– AI æ·±åº¦è§£è®€ - {{ selectedSymbol }}</span><button @click="showAIModal=false">Ã—</button></div>
            <div class="p-6 overflow-y-auto flex-1 bg-slate-50">
                <div v-if="aiLoading" class="flex flex-col items-center py-12"><div class="loader mb-4"></div><p>Gemini 1.5 Pro æ­£åœ¨åˆ†æä¸­...</p></div>
                <div v-else class="prose prose-sm max-w-none" v-html="marked.parse(aiContent)"></div>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, reactive, computed, onMounted, ref } = Vue;
const API_URL = 'https://script.google.com/macros/s/AKfycby4Dxb1Ql7gNIc1z0UzVp7wXT5WpW_yADWWZvYYVKwtOes-q4inuSyYE28wfjVMJHO1/exec'; 

createApp({
    setup() {
        const transactions = ref([]);
        const currentPrices = ref({});
        const cashAdjustments = ref([]);
        const watchlist = ref([]);
        const recommendations = ref([]);
        const isLoading = ref(false);
        const isGeneratingAnalysis = ref(false);
        const password = ref(localStorage.getItem('p_pass') || '');
        const showAIModal = ref(false);
        const aiLoading = ref(false);
        const selectedSymbol = ref('');
        const aiContent = ref('');
        const form = reactive({ date: new Date().toISOString().split('T')[0], type: 'buy', symbol: '', price: '', shares: '' });
        const recForm = reactive({ symbol: '', type: 'Buy', price: '', count: 1, analysis: '' });

        onMounted(() => { if (password.value) fetchData(); });

        const checkPassword = () => {
            if (!password.value) {
                const p = prompt('è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼:');
                if (p) { password.value = p; localStorage.setItem('p_pass', p); return true; }
                return false;
            }
            return true;
        };

        const fetchData = async () => {
            if (!checkPassword()) return;
            isLoading.value = true;
            try {
                const res = await fetch(`${API_URL}?action=read&password=${encodeURIComponent(password.value)}`);
                const data = await res.json();
                if (data.status === 'error') throw new Error(data.message);
                transactions.value = data.transactions || [];
                currentPrices.value = data.currentPrices || {};
                cashAdjustments.value = data.cashAdjustments || [];
                watchlist.value = data.watchlist || [];
                recommendations.value = (data.recommendations || []).map(r => ({...r, showDetails: false}));
            } catch (e) { alert(e.message); password.value = ''; } finally { isLoading.value = false; }
        };

        const saveData = async () => {
            if (!confirm('å„²å­˜æ‰€æœ‰è®Šæ›´ï¼Ÿ')) return;
            try {
                const cleanRecs = recommendations.value.map(({showDetails, ...rest}) => rest);
                await fetch(`${API_URL}?action=save&password=${encodeURIComponent(password.value)}`, {
                    method: 'POST', body: JSON.stringify({ transactions: transactions.value, cashAdjustments: cashAdjustments.value, watchlist: watchlist.value, recommendations: cleanRecs })
                });
                alert('å·²å„²å­˜ï¼');
            } catch (e) { alert('å„²å­˜å¤±æ•—'); }
        };

        const generateAnalysis = async () => {
            if (!recForm.symbol) return alert('è«‹è¼¸å…¥ä»£è™Ÿ');
            isGeneratingAnalysis.value = true;
            try {
                const res = await fetch(`${API_URL}?action=analyze&symbol=${recForm.symbol}&password=${encodeURIComponent(password.value)}`);
                const data = await res.json();
                recForm.analysis = data.analysis;
            } catch (e) { alert('AIåˆ†æå¤±æ•—'); } finally { isGeneratingAnalysis.value = false; }
        };

        const openAIModal = async (s) => {
            selectedSymbol.value = s; showAIModal.value = true; aiLoading.value = true;
            try {
                const res = await fetch(`${API_URL}?action=analyze&symbol=${s}&password=${encodeURIComponent(password.value)}`);
                const data = await res.json();
                aiContent.value = data.analysis;
            } catch (e) { aiContent.value = 'è®€å–å¤±æ•—'; } finally { aiLoading.value = false; }
        };

        const dashboard = computed(() => {
            let cash = 0, holdings = {}, investedAmount = 0, totalUnrealized = 0, monthlyStats = {};
            cashAdjustments.value.forEach(a => cash += a.amount);
            [...transactions.value].sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(t => {
                const sym = t.symbol.toUpperCase();
                if(!holdings[sym]) holdings[sym] = {shares:0, totalCost:0, avgCost:0, currentPrice:0, unrealizedPnL:0};
                const amt = t.price * t.shares;
                if (t.type === 'buy') {
                    cash -= amt; holdings[sym].totalCost += amt; holdings[sym].shares += t.shares;
                } else {
                    cash += amt; const cost = holdings[sym].avgCost * t.shares; holdings[sym].totalCost -= cost; holdings[sym].shares -= t.shares;
                }
                if(holdings[sym].shares > 0) holdings[sym].avgCost = holdings[sym].totalCost / holdings[sym].shares;
            });
            for(let s in holdings) {
                if(holdings[s].shares > 0) {
                    investedAmount += holdings[s].totalCost;
                    holdings[s].currentPrice = currentPrices.value[s] || 0;
                    holdings[s].unrealizedPnL = (holdings[s].currentPrice * holdings[s].shares) - holdings[s].totalCost;
                    holdings[s].unrealizedPnLPercent = ((holdings[s].unrealizedPnL / holdings[s].totalCost) * 100).toFixed(2);
                    totalUnrealized += holdings[s].unrealizedPnL;
                }
            }
            return { cash, holdings, investedAmount, totalUnrealized, monthlyStats };
        });

        const sortedTransactions = computed(() => {
            const h = {};
            return [...transactions.value].sort((a,b)=>new Date(a.date)-new Date(b.date)).map(t => {
                const sym = t.symbol.toUpperCase(); if(!h[sym]) h[sym] = {s:0, c:0, avg:0};
                let pnl = 0; if(t.type==='buy'){ h[sym].c += t.price*t.shares; h[sym].s += t.shares; h[sym].avg = h[sym].c/h[sym].s; }
                else { pnl = (t.price - h[sym].avg)*t.shares; h[sym].c -= h[sym].avg*t.shares; h[sym].s -= t.shares; }
                return {...t, realizedPnL: pnl};
            }).reverse();
        });

        const addTransaction = () => { transactions.value.push({id:Date.now(), ...form}); form.symbol=''; form.price=''; form.shares=''; };
        const removeTransaction = (id) => { transactions.value = transactions.value.filter(t=>t.id!==id); };
        const addRecommendation = () => { recommendations.value.push({id:Date.now(), date:new Date().toISOString().split('T')[0], ...recForm, showDetails:false}); recForm.symbol=''; recForm.analysis=''; };
        const removeRecommendation = (id) => { recommendations.value = recommendations.value.filter(r=>r.id!==id); };
        const formatCurrency = (v, d=0) => (v||0).toLocaleString('en-US', {minimumFractionDigits:d, maximumFractionDigits:d});

        return { dashboard, form, recForm, transactions, recommendations, sortedTransactions, sortedRecommendations: computed(()=>[...recommendations.value].reverse()), fetchData, saveData, addTransaction, removeTransaction, addRecommendation, removeRecommendation, formatCurrency, isLoading, isGeneratingAnalysis, generateAnalysis, openAIModal, showAIModal, aiLoading, aiContent, selectedSymbol, marked, resetPassword:()=>{localStorage.clear();location.reload();} };
    }
}).mount('#app');
</script>
</body>
</html>
