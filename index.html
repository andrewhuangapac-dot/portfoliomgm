<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾è‚¡æŠ•è³‡çµ„åˆç®¡ç† (Gemini 1.5 Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; color: #334155; }
        .text-up { color: #16a34a; }   /* ç¶ è‰²ä»£è¡¨ç²åˆ© (ç¾è‚¡æ…£ä¾‹) */
        .text-down { color: #dc2626; } /* ç´…è‰²ä»£è¡¨è™§æ */
        .loader { border: 3px solid #e2e8f0; border-radius: 50%; border-top: 3px solid #2563eb; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Markdown æ¨£å¼å„ªåŒ– */
        .prose h1, .prose h2, .prose h3 { font-weight: 700; color: #1e293b; margin-top: 1em; margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.3em; }
        .prose p { margin-bottom: 0.8em; line-height: 1.6; }
        .prose strong { color: #0f172a; font-weight: 700; }

        .ai-glow { box-shadow: 0 0 20px rgba(37, 99, 235, 0.3); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 md:p-8 max-w-7xl mx-auto">
    
    <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-2xl font-extrabold text-slate-900 flex items-center gap-2 tracking-tight">
                ç¾è‚¡æŠ•è³‡çµ„åˆ
                <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded-md font-bold tracking-wide flex items-center gap-1 shadow-sm">
                    Gemini 1.5 Pro
                </span>
            </h1>
            <p class="text-slate-500 text-sm font-medium">è¯çˆ¾è¡—æ–°è â€¢ Reddit è«–å£‡é¢¨å‘ â€¢ AI æ™ºèƒ½åˆ†æ</p>
        </div>
        <div class="flex gap-2">
            <button @click="resetPassword" class="px-3 py-2 text-xs text-slate-400 hover:text-slate-600 underline font-medium">é‡è¨­å¯†ç¢¼</button>
            <button @click="fetchData" class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg shadow-sm hover:bg-slate-50 text-sm font-bold transition flex items-center gap-2">
                <span v-if="isLoading" class="loader w-4 h-4 border-slate-400 border-t-transparent"></span>
                <span>{{ isLoading ? 'åŒæ­¥ä¸­...' : 'ğŸ”„ åŒæ­¥æ•¸æ“š' }}</span>
            </button>
            <button @click="saveData" class="px-4 py-2 bg-slate-900 text-white rounded-lg shadow-md hover:bg-slate-800 text-sm font-bold transition">ğŸ’¾ å„²å­˜è®Šæ›´</button>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">å¯ç”¨ç¾é‡‘ (Buying Power)</h3>
            <div class="flex justify-between items-end mt-2">
                <p class="text-2xl font-bold text-slate-800">${{ formatCurrency(dashboard.cash) }}</p>
                <button @click="showCashModal = true" class="text-xs text-blue-600 hover:bg-blue-50 px-2 py-1 rounded transition font-medium">è³‡é‡‘ç®¡ç†</button>
            </div>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">æŒå€‰ç¸½æˆæœ¬ (Cost Basis)</h3>
            <p class="text-2xl font-bold text-slate-800 mt-2">${{ formatCurrency(dashboard.investedAmount) }}</p>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">å·²å¯¦ç¾æç›Š (Realized P&L)</h3>
            <p class="text-2xl font-bold mt-2" :class="dashboard.totalRealizedPnL >= 0 ? 'text-up' : 'text-down'">
                {{ dashboard.totalRealizedPnL >= 0 ? '+' : '' }}${{ formatCurrency(dashboard.totalRealizedPnL) }}
            </p>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">æ·¨è³‡ç”¢ (Net Worth)</h3>
            <p class="text-2xl font-bold text-slate-800 mt-2">${{ formatCurrency(dashboard.cash + dashboard.investedAmount) }}</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-2 space-y-6">
            
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <h2 class="text-sm font-bold text-slate-700 mb-4 uppercase tracking-wide">æ–°å¢äº¤æ˜“</h2>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                    <div class="col-span-2 md:col-span-1"><input type="date" v-model="form.date" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none"></div>
                    <div class="col-span-2 md:col-span-1"><select v-model="form.type" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm font-medium"><option value="buy">è²·å…¥ (Buy)</option><option value="sell">è³£å‡º (Sell)</option></select></div>
                    <div class="col-span-2 md:col-span-1"><input type="text" v-model="form.symbol" placeholder="ä»£è™Ÿ (å¦‚ NVDA)" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm uppercase font-bold"></div>
                    <div class="col-span-1"><input type="number" step="0.01" v-model.number="form.price" placeholder="åƒ¹æ ¼" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm"></div>
                    <div class="col-span-1"><input type="number" v-model.number="form.shares" placeholder="è‚¡æ•¸" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm"></div>
                    <div class="col-span-2 md:col-span-1"><button @click="addTransaction" class="w-full bg-blue-600 text-white p-2.5 rounded-lg hover:bg-blue-700 text-sm font-bold transition">æ–°å¢è¨˜éŒ„</button></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                    <h2 class="font-bold text-slate-700 text-sm uppercase">ç•¶å‰æŒå€‰ (Positions)</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 uppercase text-xs font-semibold">
                            <tr>
                                <th class="p-3">ä»£è™Ÿ</th>
                                <th class="p-3 text-right">è‚¡æ•¸</th>
                                <th class="p-3 text-right">å¹³å‡æˆæœ¬</th>
                                <th class="p-3 text-right text-blue-700">ç¸½æˆæœ¬</th> <th class="p-3 text-center">AI åˆ†æ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="(holding, symbol) in dashboard.holdings" :key="symbol" v-show="holding.shares > 0" class="hover:bg-slate-50 transition-colors">
                                <td class="p-3 font-bold text-slate-800">{{ symbol }}</td>
                                <td class="p-3 text-right font-medium">{{ holding.shares }}</td>
                                <td class="p-3 text-right text-slate-500">${{ formatCurrency(holding.avgCost, 2) }}</td>
                                <td class="p-3 text-right font-bold text-blue-700">${{ formatCurrency(holding.totalCost, 0) }}</td> <td class="p-3 text-center">
                                    <button @click="openAIModal(symbol)" class="group bg-white border border-blue-200 text-blue-600 px-3 py-1.5 rounded-full text-xs font-bold hover:bg-blue-50 transition flex items-center gap-1 mx-auto">
                                        <span class="group-hover:scale-110 transition-transform">âš¡</span> AI è§£è®€
                                    </button>
                                </td>
                            </tr>
                            <tr v-if="Object.keys(dashboard.holdings).length === 0"><td colspan="5" class="p-8 text-center text-slate-400 italic">ç›®å‰æ²’æœ‰æŒå€‰</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

             <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50"><h2 class="font-bold text-slate-700 text-sm uppercase">äº¤æ˜“æ­·å²ç´€éŒ„</h2></div>
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 uppercase text-xs font-semibold sticky top-0">
                            <tr><th class="p-3">æ—¥æœŸ</th><th class="p-3">ä»£è™Ÿ</th><th class="p-3">é¡åˆ¥</th><th class="p-3 text-right">åƒ¹æ ¼</th><th class="p-3 text-right">è‚¡æ•¸</th><th class="p-3 text-right">æç›Š</th><th class="p-3"></th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="t in sortedTransactions" :key="t.id" class="hover:bg-slate-50">
                                <td class="p-3 text-slate-500 text-xs">{{ t.date }}</td>
                                <td class="p-3 font-bold text-slate-700">{{ t.symbol }}</td>
                                <td class="p-3">
                                    <span :class="t.type==='buy'?'bg-blue-50 text-blue-700 border-blue-100':'bg-amber-50 text-amber-700 border-amber-100'" class="px-2 py-0.5 rounded text-xs border font-bold uppercase">
                                        {{ t.type === 'buy' ? 'è²·å…¥' : 'è³£å‡º' }}
                                    </span>
                                </td>
                                <td class="p-3 text-right font-medium">${{ formatCurrency(t.price) }}</td>
                                <td class="p-3 text-right font-medium">{{ t.shares }}</td>
                                <td class="p-3 text-right font-bold"><span v-if="t.type==='sell'" :class="t.realizedPnL>=0?'text-up':'text-down'">{{ t.realizedPnL>=0?'+':'' }}${{ formatCurrency(t.realizedPnL, 0) }}</span><span v-else class="text-slate-300">-</span></td>
                                <td class="p-3 text-center"><button @click="removeTransaction(t.id)" class="text-slate-300 hover:text-red-500 transition font-bold">Ã—</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-sm p-5 border border-slate-200">
                <h2 class="font-bold text-slate-700 border-b border-slate-100 pb-2 mb-2 text-sm uppercase">æœˆåº¦æç›Šçµ±è¨ˆ</h2>
                <div v-for="(stat, month) in dashboard.monthlyStats" :key="month" class="flex justify-between py-2 border-b border-slate-50 last:border-0 text-sm">
                    <span class="text-slate-600 font-medium">{{ month }}</span>
                    <span :class="stat.pnl >= 0 ? 'text-up' : 'text-down'" class="font-bold">{{ stat.pnl >= 0 ? '+' : '' }}${{ formatCurrency(stat.pnl, 0) }}</span>
                </div>
                <div v-if="Object.keys(dashboard.monthlyStats).length === 0" class="text-center text-slate-400 py-4 text-xs italic">å°šç„¡å·²å¯¦ç¾æç›Š</div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-5 border border-slate-200">
                <div class="flex justify-between items-center border-b border-slate-100 pb-2 mb-2">
                    <h2 class="font-bold text-slate-700 text-sm uppercase">è³‡é‡‘é€²å‡ºç´€éŒ„</h2>
                </div>
                <div class="max-h-64 overflow-y-auto space-y-2">
                    <div v-for="adj in sortedAdjustments" :key="adj.id" class="flex justify-between text-sm py-1 border-b border-slate-50 last:border-0">
                        <div class="flex flex-col">
                            <span class="text-slate-400 text-xs">{{ adj.date }}</span>
                            <span class="text-slate-700 font-medium">{{ adj.note }}</span>
                        </div>
                        <span :class="adj.amount>=0?'text-blue-600':'text-orange-600'" class="font-bold self-center">{{ adj.amount>=0?'+':''}}${{ formatCurrency(adj.amount, 0) }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showAIModal" class="fixed inset-0 bg-slate-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[85vh] shadow-2xl flex flex-col overflow-hidden relative border border-slate-200">
            <div class="p-5 bg-gradient-to-r from-slate-800 to-slate-900 text-white flex justify-between items-center">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <span class="text-blue-400">ğŸ¤–</span> AI æ™ºèƒ½åˆ†æ - {{ selectedSymbol }}
                </h3>
                <button @click="showAIModal = false" class="text-slate-400 hover:text-white text-2xl transition">&times;</button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 bg-slate-50">
                
                <div v-if="aiLoading" class="flex flex-col items-center justify-center py-12 space-y-6">
                    <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center ai-glow border border-blue-100">
                        <div class="loader"></div>
                    </div>
                    <div class="text-center">
                        <p class="text-slate-800 font-bold text-lg">AI æ­£åœ¨æ€è€ƒåˆ†æä¸­...</p>
                        <p class="text-slate-500 text-sm mt-1">æœå°‹è¯çˆ¾è¡—æ–°è â€¢ çˆ¬å– Reddit æƒ…ç·’ â€¢ ç¶œåˆåˆ¤æ–·</p>
                    </div>
                </div>

                <div v-else>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-blue-100 mb-6 relative overflow-hidden">
                        <div class="flex items-center gap-2 mb-4">
                            <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-bold border border-blue-200">GEMINI 2.5 PRO</span>
                            <span class="text-slate-400 text-xs font-medium">å‰›å‰›æ›´æ–°</span>
                        </div>
                        <div class="prose prose-sm max-w-none text-slate-700" v-html="aiContentParsed"></div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <a :href="`https://finviz.com/quote.ashx?t=${selectedSymbol}`" target="_blank" class="flex items-center justify-center py-2.5 bg-slate-800 text-white rounded-lg text-xs font-bold hover:bg-slate-900 transition">Finviz åœ–è¡¨</a>
                        <a :href="`https://seekingalpha.com/symbol/${selectedSymbol}`" target="_blank" class="flex items-center justify-center py-2.5 bg-orange-600 text-white rounded-lg text-xs font-bold hover:bg-orange-700 transition">Seeking Alpha</a>
                        <a :href="`https://finance.yahoo.com/quote/${selectedSymbol}`" target="_blank" class="flex items-center justify-center py-2.5 bg-purple-600 text-white rounded-lg text-xs font-bold hover:bg-purple-700 transition">Yahoo è²¡ç¶“</a>
                        <a :href="`https://www.google.com/search?q=${selectedSymbol}+stock+news`" target="_blank" class="flex items-center justify-center py-2.5 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg text-xs font-bold hover:bg-blue-100 transition">Google æ–°è</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div v-if="showCashModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-80 shadow-xl border border-slate-100">
            <h3 class="font-bold mb-4 text-slate-800 uppercase text-sm">èª¿æ•´è³‡é‡‘ (å…¥é‡‘/å‡ºé‡‘)</h3>
            <input type="date" v-model="cashForm.date" class="w-full border rounded-lg p-2.5 mb-3 text-sm">
            <input type="number" v-model.number="cashForm.amount" class="w-full border rounded-lg p-2.5 mb-3 text-sm" placeholder="é‡‘é¡ (è² æ•¸ä»£è¡¨å‡ºé‡‘)">
            <input type="text" v-model="cashForm.note" class="w-full border rounded-lg p-2.5 mb-5 text-sm" placeholder="å‚™è¨» (ä¾‹å¦‚: å…¥é‡‘)">
            <div class="flex gap-2"><button @click="addCashAdjustment" class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg text-sm font-bold hover:bg-blue-700">ç¢ºèª</button><button @click="showCashModal = false" class="flex-1 bg-slate-100 text-slate-600 py-2.5 rounded-lg text-sm font-bold hover:bg-slate-200">å–æ¶ˆ</button></div>
        </div>
    </div>

</div>

<script>
    const { createApp, reactive, computed, onMounted, ref } = Vue;

    // ==========================================
    // ğŸ”´ é€™è£¡å¿…é ˆå¡«å…¥æ‚¨çš„ Apps Script ç¶²å€ (çµå°¾æ˜¯ /exec)
    // ==========================================
    const API_URL = 'https://script.google.com/macros/s/AKfycbzZTiDJx46nbdrssqXf0Bh4MWx9bKa8kp6K187_O7krFXhclm7YlTOL0gj91SFGqGZj/exec'; 
    // ==========================================

    createApp({
        setup() {
            const transactions = ref([]);
            const cashAdjustments = ref([]);
            const showCashModal = ref(false);
            const isLoading = ref(false);
            const password = ref(localStorage.getItem('portfolio_password') || '');
            const showAIModal = ref(false);
            const aiLoading = ref(false);
            const selectedSymbol = ref('');
            const aiContent = ref('');
            const form = reactive({ date: new Date().toISOString().split('T')[0], type: 'buy', symbol: '', price: '', shares: '' });
            const cashForm = reactive({ date: new Date().toISOString().split('T')[0], amount: '', note: '' });

            onMounted(() => { if (password.value) fetchData(); });

            const checkPassword = () => {
                if (!password.value) {
                    const input = prompt('è«‹è¼¸å…¥å­˜å–å¯†ç¢¼ï¼š');
                    if (input) {
                        password.value = input;
                        localStorage.setItem('portfolio_password', input);
                    } else {
                        alert('éœ€è¦å¯†ç¢¼æ‰èƒ½å­˜å–ã€‚');
                        return false;
                    }
                }
                return true;
            };

            const resetPassword = () => {
                localStorage.removeItem('portfolio_password');
                password.value = '';
                alert('å¯†ç¢¼å·²æ¸…é™¤ã€‚');
            };

            const aiContentParsed = computed(() => aiContent.value ? marked.parse(aiContent.value) : '');

            const fetchData = async () => {
                if (!checkPassword()) return;
                if (API_URL.includes('APPS_SCRIPT_ç¶²å€')) return alert('è«‹åœ¨ç¨‹å¼ç¢¼ç¬¬ 335 è¡Œå¡«å…¥æ­£ç¢ºçš„ API URLï¼');
                isLoading.value = true;
                try {
                    const res = await fetch(`${API_URL}?action=read&password=${encodeURIComponent(password.value)}`);
                    const data = await res.json();
                    if (data.status === 'error') throw new Error(data.message);
                    transactions.value = data.transactions || [];
                    cashAdjustments.value = data.cashAdjustments || [];
                } catch (e) {
                    if(e.message.includes('Wrong Password')) resetPassword();
                    alert(e.message);
                } finally { isLoading.value = false; }
            };

            const saveData = async () => {
                if (!checkPassword()) return;
                if(!confirm('ç¢ºå®šè¦å„²å­˜æ‰€æœ‰è®Šæ›´å—ï¼Ÿ')) return;
                try {
                    const res = await fetch(`${API_URL}?action=save&password=${encodeURIComponent(password.value)}`, {
                        method: 'POST', body: JSON.stringify({ transactions: transactions.value, cashAdjustments: cashAdjustments.value })
                    });
                    const data = await res.json();
                    if(data.status === 'error') throw new Error(data.message);
                    alert('å„²å­˜æˆåŠŸï¼');
                } catch (e) { alert('å„²å­˜å¤±æ•—: ' + e.message); }
            };

            const openAIModal = async (symbol) => {
                if (!checkPassword()) return;
                selectedSymbol.value = symbol;
                showAIModal.value = true;
                aiLoading.value = true;
                aiContent.value = '';
                try {
                    const res = await fetch(`${API_URL}?action=analyze&symbol=${symbol}&password=${encodeURIComponent(password.value)}`);
                    const data = await res.json();
                    if (data.status === 'success') aiContent.value = data.analysis;
                    else aiContent.value = `**åˆ†æå¤±æ•—**: ${data.message || 'æœªçŸ¥éŒ¯èª¤'}`;
                } catch (e) { aiContent.value = `**é€£ç·šéŒ¯èª¤**: ${e.message}`; } finally { aiLoading.value = false; }
            };

            const dashboard = computed(() => {
                let cash = 0, holdings = {}, totalRealizedPnL = 0, investedAmount = 0, monthlyStats = {};
                cashAdjustments.value.forEach(adj => cash += adj.amount);
                
                const sorted = [...transactions.value].sort((a,b) => new Date(a.date)-new Date(b.date));
                sorted.forEach(t => {
                    const sym = t.symbol.toUpperCase();
                    // åˆå§‹åŒ–æŒå€‰ç‰©ä»¶ï¼ŒåŒ…å« totalCost
                    if(!holdings[sym]) holdings[sym] = {shares:0, totalCost:0, avgCost:0};
                    
                    const amt = t.price * t.shares;
                    
                    if(t.type === 'buy') {
                        cash -= amt;
                        holdings[sym].totalCost += amt; // è²·å…¥æ™‚å¢åŠ ç¸½æˆæœ¬
                        holdings[sym].shares += t.shares;
                        if(holdings[sym].shares > 0) holdings[sym].avgCost = holdings[sym].totalCost / holdings[sym].shares;
                    } else {
                        cash += amt;
                        // è³£å‡ºæ™‚ï¼Œä¾æ¯”ä¾‹æ‰£é™¤æˆæœ¬
                        const cost = holdings[sym].avgCost * t.shares;
                        const pnl = amt - cost;
                        
                        totalRealizedPnL += pnl;
                        const m = t.date.substring(0,7);
                        if(!monthlyStats[m]) monthlyStats[m] = {pnl:0};
                        monthlyStats[m].pnl += pnl;
                        
                        holdings[sym].shares -= t.shares;
                        holdings[sym].totalCost -= cost; // è³£å‡ºæ™‚æ¸›å°‘ç¸½æˆæœ¬
                    }
                });

                // è¨ˆç®—ç•¶å‰ç¸½æŠ•å…¥æˆæœ¬
                for(let s in holdings) if(holdings[s].shares > 0) investedAmount += holdings[s].totalCost;
                
                const sortedMonthly = Object.keys(monthlyStats).sort().reverse().reduce((obj, key) => { obj[key] = monthlyStats[key]; return obj; }, {});
                
                return { cash, holdings, totalRealizedPnL, investedAmount, monthlyStats: sortedMonthly };
            });

            const sortedTransactions = computed(() => {
                const chronological = [...transactions.value].sort((a,b)=>new Date(a.date)-new Date(b.date));
                const tempHoldings = {};
                const res = chronological.map(t => {
                    const sym = t.symbol.toUpperCase();
                    if(!tempHoldings[sym]) tempHoldings[sym] = {shares:0, totalCost:0, avgCost:0};
                    let realizedPnL = 0; const amt = t.price * t.shares;
                    if(t.type==='buy'){
                         tempHoldings[sym].totalCost+=amt; tempHoldings[sym].shares+=t.shares;
                         if(tempHoldings[sym].shares>0) tempHoldings[sym].avgCost=tempHoldings[sym].totalCost/tempHoldings[sym].shares;
                    } else {
                        const cost = tempHoldings[sym].avgCost * t.shares; realizedPnL = amt - cost;
                        tempHoldings[sym].shares-=t.shares; tempHoldings[sym].totalCost-=cost;
                    }
                    return {...t, realizedPnL};
                });
                return res.sort((a,b)=>new Date(b.date)-new Date(a.date));
            });
            const sortedAdjustments = computed(() => [...cashAdjustments.value].sort((a,b)=>new Date(b.date)-new Date(a.date)));

            const addTransaction = () => {
                if(!form.symbol) return;
                transactions.value.push({ id:Date.now(), date:form.date, type:form.type, symbol:form.symbol.toUpperCase(), price:form.price, shares:form.shares });
                form.symbol=''; form.price=''; form.shares='';
            };
            const removeTransaction = (id) => { if(confirm('ç¢ºå®šåˆªé™¤æ­¤äº¤æ˜“ï¼Ÿ')) transactions.value=transactions.value.filter(t=>t.id!==id); };
            const addCashAdjustment = () => { cashAdjustments.value.push({id:Date.now(), date:cashForm.date, amount:cashForm.amount, note:cashForm.note}); showCashModal.value=false; };
            const formatCurrency = (val, d=0) => (val||0).toLocaleString('en-US', {minimumFractionDigits:d, maximumFractionDigits:d});

            return { API_URL, dashboard, form, cashForm, showCashModal, password, isLoading, transactions, cashAdjustments, sortedTransactions, sortedAdjustments, fetchData, saveData, addTransaction, removeTransaction, addCashAdjustment, formatCurrency, resetPassword, showAIModal, aiLoading, selectedSymbol, aiContentParsed, openAIModal };
        }
    }).mount('#app');
</script>
</body>
</html>
