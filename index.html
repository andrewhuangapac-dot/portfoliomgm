<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•è³‡çµ„åˆç®¡ç† (Google Sheets åŒæ­¥ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        /* å°ç£è‚¡å¸‚ç¿’æ…£ï¼šç´…æ¼²ç¶ è·Œ */
        .text-up { color: #ef4444; } 
        .text-down { color: #22c55e; }
        .bg-up { background-color: #fee2e2; color: #b91c1c; }
        .bg-down { background-color: #dcfce7; color: #15803d; }
        
        /* Loading å‹•ç•« */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db; width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 md:p-8 max-w-7xl mx-auto">
    
    <div v-if="isLoading" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader mb-3"></div>
            <p class="text-gray-700 font-medium">{{ loadingMsg }}</p>
        </div>
    </div>

    <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                æŠ•è³‡çµ„åˆç®¡ç†
                <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full border border-green-200">Sheets Sync</span>
            </h1>
            <p class="text-gray-500 text-sm">æ•¸æ“šå„²å­˜æ–¼ Google è©¦ç®—è¡¨</p>
        </div>
        <div class="space-x-2">
            <button @click="fetchData" class="px-4 py-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-sm font-medium transition">ğŸ”„ åŒæ­¥æ•¸æ“š</button>
            <button @click="saveData" class="px-4 py-2 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm font-medium transition">ğŸ’¾ ç«‹å³å„²å­˜</button>
        </div>
    </header>

    <div v-if="unsavedChanges" class="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 animate-pulse">
        <div class="flex">
            <div class="flex-shrink-0">âš ï¸</div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700">
                    æ‚¨æœ‰æœªå„²å­˜çš„æ›´å‹•ã€‚è«‹é»æ“Šä¸Šæ–¹ã€Œç«‹å³å„²å­˜ã€å°‡è³‡æ–™å¯«å› Google Sheetsï¼Œå¦å‰‡é‡æ–°æ•´ç†å¾Œå°‡æœƒéºå¤±ã€‚
                </p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-blue-500">
            <h3 class="text-gray-500 text-sm font-medium">å¯ç”¨ç¾é‡‘ (Cash)</h3>
            <p class="text-2xl font-bold text-gray-800">{{ formatCurrency(dashboard.cash) }}</p>
            <button @click="showCashModal = true" class="text-xs text-blue-600 mt-2 hover:underline">èª¿æ•´è³‡é‡‘ (+/-)</button>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-purple-500">
            <h3 class="text-gray-500 text-sm font-medium">æŒå€‰æˆæœ¬ (Cost Basis)</h3>
            <p class="text-2xl font-bold text-gray-800">{{ formatCurrency(dashboard.investedAmount) }}</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-sm border-l-4" :class="dashboard.totalRealizedPnL >= 0 ? 'border-red-500' : 'border-green-500'">
            <h3 class="text-gray-500 text-sm font-medium">ç´¯è¨ˆå·²å¯¦ç¾æç›Š</h3>
            <p class="text-2xl font-bold" :class="dashboard.totalRealizedPnL >= 0 ? 'text-up' : 'text-down'">
                {{ dashboard.totalRealizedPnL >= 0 ? '+' : '' }}{{ formatCurrency(dashboard.totalRealizedPnL) }}
            </p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-gray-500">
            <h3 class="text-gray-500 text-sm font-medium">ç¸½è³‡ç”¢ (ç¾é‡‘+æŒå€‰)</h3>
            <p class="text-2xl font-bold text-gray-800">{{ formatCurrency(dashboard.cash + dashboard.investedAmount) }}</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-2 space-y-8">
            
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    æ–°å¢äº¤æ˜“ç´€éŒ„
                </h2>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-gray-500 mb-1">æ—¥æœŸ</label>
                        <input type="date" v-model="form.date" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-gray-500 mb-1">é¡å‹</label>
                        <select v-model="form.type" class="w-full border rounded p-2 text-sm">
                            <option value="buy">è²·å…¥ (Buy)</option>
                            <option value="sell">è³£å‡º (Sell)</option>
                        </select>
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-gray-500 mb-1">ä»£è™Ÿ</label>
                        <input type="text" v-model="form.symbol" placeholder="å¦‚ AAPL" class="w-full border rounded p-2 text-sm uppercase">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-xs text-gray-500 mb-1">åƒ¹æ ¼</label>
                        <input type="number" step="0.01" v-model.number="form.price" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-xs text-gray-500 mb-1">è‚¡æ•¸</label>
                        <input type="number" v-model.number="form.shares" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div class="col-span-2 md:col-span-1 flex items-end">
                        <button @click="addTransaction" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 text-sm font-medium">æ–°å¢</button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                    <h2 class="font-bold text-gray-800">ç•¶å‰æŒå€‰ (Holdings)</h2>
                    <span class="text-xs text-gray-500">*å¹³å‡æˆæœ¬æ³•è¨ˆç®—</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500">
                            <tr>
                                <th class="p-3">ä»£è™Ÿ</th>
                                <th class="p-3 text-right">æŒæœ‰è‚¡æ•¸</th>
                                <th class="p-3 text-right">å¹³å‡æˆæœ¬</th>
                                <th class="p-3 text-right">ç¸½æŠ•å…¥æˆæœ¬</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            <tr v-for="(holding, symbol) in dashboard.holdings" :key="symbol" v-show="holding.shares > 0">
                                <td class="p-3 font-bold">{{ symbol }}</td>
                                <td class="p-3 text-right">{{ holding.shares }}</td>
                                <td class="p-3 text-right">{{ formatCurrency(holding.avgCost, 3) }}</td>
                                <td class="p-3 text-right">{{ formatCurrency(holding.totalCost) }}</td>
                            </tr>
                            <tr v-if="Object.keys(dashboard.holdings).length === 0 || Object.values(dashboard.holdings).every(h => h.shares <= 0)">
                                <td colspan="4" class="p-8 text-center text-gray-400">å°šç„¡æŒå€‰æ•¸æ“š</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="p-4 border-b bg-gray-50">
                    <h2 class="font-bold text-gray-800">äº¤æ˜“ç´€éŒ„æ˜ç´°</h2>
                </div>
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500 sticky top-0">
                            <tr>
                                <th class="p-3">æ—¥æœŸ</th>
                                <th class="p-3">é¡å‹</th>
                                <th class="p-3">ä»£è™Ÿ</th>
                                <th class="p-3 text-right">åƒ¹æ ¼</th>
                                <th class="p-3 text-right">è‚¡æ•¸</th>
                                <th class="p-3 text-right">ç¸½é‡‘é¡</th>
                                <th class="p-3 text-right">æç›Š (P&L)</th>
                                <th class="p-3 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            <tr v-for="t in sortedTransactions" :key="t.id" class="hover:bg-gray-50">
                                <td class="p-3 text-gray-600">{{ t.date }}</td>
                                <td class="p-3">
                                    <span :class="t.type === 'buy' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'" class="px-2 py-1 rounded text-xs font-bold uppercase">
                                        {{ t.type === 'buy' ? 'è²·å…¥' : 'è³£å‡º' }}
                                    </span>
                                </td>
                                <td class="p-3 font-medium">{{ t.symbol }}</td>
                                <td class="p-3 text-right">{{ formatCurrency(t.price) }}</td>
                                <td class="p-3 text-right">{{ t.shares }}</td>
                                <td class="p-3 text-right text-gray-500">{{ formatCurrency(t.totalAmount) }}</td>
                                
                                <td class="p-3 text-right font-bold">
                                    <span v-if="t.type === 'sell'" :class="t.realizedPnL >= 0 ? 'text-up' : 'text-down'">
                                        {{ t.realizedPnL >= 0 ? '+' : '' }}{{ formatCurrency(t.realizedPnL) }}
                                        <span class="text-xs font-normal text-gray-400 block">
                                            ({{ t.roi.toFixed(1) }}%)
                                        </span>
                                    </span>
                                    <span v-else class="text-gray-300">-</span>
                                </td>

                                <td class="p-3 text-center">
                                    <button @click="removeTransaction(t.id)" class="text-gray-400 hover:text-red-500">Ã—</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="space-y-8">
            
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="p-4 border-b bg-gray-50">
                    <h2 class="font-bold text-gray-800">æœˆåº¦æç›Šçµ±è¨ˆ</h2>
                </div>
                <div class="p-4">
                    <div v-for="(stat, month) in dashboard.monthlyStats" :key="month" class="flex justify-between items-center py-3 border-b last:border-0">
                        <span class="text-gray-600 font-medium">{{ month }}</span>
                        <div class="text-right">
                            <div :class="stat.pnl >= 0 ? 'text-up' : 'text-down'" class="font-bold text-lg">
                                {{ stat.pnl >= 0 ? '+' : '' }}{{ formatCurrency(stat.pnl) }}
                            </div>
                            <div class="text-xs text-gray-400">äº¤æ˜“é‡: {{ stat.count }} ç­†</div>
                        </div>
                    </div>
                     <div v-if="Object.keys(dashboard.monthlyStats).length === 0" class="text-center text-gray-400 py-4">
                        å°šç„¡è³£å‡ºç´€éŒ„
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                 <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                    <h2 class="font-bold text-gray-800">è³‡é‡‘è®Šå‹•ç´€éŒ„</h2>
                    <button @click="showCashModal = true" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">å…¥/å‡ºé‡‘</button>
                </div>
                <div class="max-h-64 overflow-y-auto">
                    <table class="w-full text-sm">
                        <tbody class="divide-y">
                            <tr v-for="adj in sortedAdjustments" :key="adj.id">
                                <td class="p-3 text-gray-500">{{ adj.date }}</td>
                                <td class="p-3">{{ adj.note }}</td>
                                <td class="p-3 text-right font-bold" :class="adj.amount >= 0 ? 'text-blue-600' : 'text-orange-600'">
                                    {{ adj.amount >= 0 ? '+' : '' }}{{ formatCurrency(adj.amount) }}
                                </td>
                                <td class="p-3 text-right">
                                    <button @click="removeAdjustment(adj.id)" class="text-gray-300 hover:text-red-500">Ã—</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div v-if="showCashModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-96 shadow-xl">
            <h3 class="text-lg font-bold mb-4">è³‡é‡‘èª¿æ•´ (å…¥é‡‘/å‡ºé‡‘)</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs text-gray-500 mb-1">æ—¥æœŸ</label>
                    <input type="date" v-model="cashForm.date" class="w-full border rounded p-2">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">é‡‘é¡ (è² æ•¸ä»£è¡¨å‡ºé‡‘)</label>
                    <input type="number" v-model.number="cashForm.amount" class="w-full border rounded p-2" placeholder="ä¾‹å¦‚: 10000">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">å‚™è¨»</label>
                    <input type="text" v-model="cashForm.note" class="w-full border rounded p-2" placeholder="ä¾‹å¦‚: åˆå§‹è³‡é‡‘">
                </div>
                <div class="flex space-x-2 mt-4">
                    <button @click="addCashAdjustment" class="flex-1 bg-blue-600 text-white py-2 rounded">ç¢ºèª</button>
                    <button @click="showCashModal = false" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, reactive, computed, watch, onMounted, ref } = Vue;

    // ==========================================
    // TODO: è«‹æ›¿æ›æˆä½ çš„ Google Apps Script ç¶²å€
    // ==========================================
    const API_URL = 'https://script.google.com/macros/s/AKfycbyzdP8JX6bWyHFL4pDbLBnq3iTe3I8pLKEdGjLSClfUMNnqQ8eJKLItM1X_mY7yoFoE/exec';

    createApp({
        setup() {
            // åŸºç¤ç‹€æ…‹
            const transactions = ref([]);
            const cashAdjustments = ref([]);
            const showCashModal = ref(false);
            const isLoading = ref(false);
            const loadingMsg = ref('');
            const unsavedChanges = ref(false);

            // è¡¨å–®ç¶å®š
            const form = reactive({
                date: new Date().toISOString().split('T')[0],
                type: 'buy',
                symbol: '',
                price: '',
                shares: ''
            });

            const cashForm = reactive({
                date: new Date().toISOString().split('T')[0],
                amount: '',
                note: ''
            });

            // åˆå§‹åŒ–ï¼šå¾ Google Sheets è®€å–æ•¸æ“š
            onMounted(() => {
                fetchData();
            });

            // æ¨™è¨˜è®Šæ›´
            const markAsChanged = () => {
                unsavedChanges.value = true;
            };

            // å¾å¾Œç«¯è®€å–
            const fetchData = async () => {
                if (API_URL === 'YOUR_GOOGLE_SCRIPT_URL') {
                    alert('è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ‚¨çš„ Google Apps Script URLï¼');
                    return;
                }
                isLoading.value = true;
                loadingMsg.value = 'æ­£åœ¨å¾ Google Sheets åŒæ­¥è³‡æ–™...';
                try {
                    const res = await fetch(`${API_URL}?action=read`);
                    const data = await res.json();
                    
                    if(data.status === 'error') throw new Error(data.message);

                    transactions.value = data.transactions || [];
                    cashAdjustments.value = data.cashAdjustments || [];
                    unsavedChanges.value = false;
                } catch (e) {
                    alert('è®€å–å¤±æ•—: ' + e.message);
                } finally {
                    isLoading.value = false;
                }
            };

            // å„²å­˜åˆ°å¾Œç«¯
            const saveData = async () => {
                isLoading.value = true;
                loadingMsg.value = 'æ­£åœ¨å„²å­˜è‡³ Google Sheets...';
                try {
                    const res = await fetch(API_URL + '?action=save', {
                        method: 'POST',
                        body: JSON.stringify({
                            transactions: transactions.value,
                            cashAdjustments: cashAdjustments.value
                        })
                    });
                    
                    const result = await res.json();
                    if (result.status === 'success') {
                        unsavedChanges.value = false;
                        alert('å„²å­˜æˆåŠŸï¼');
                    } else {
                        throw new Error(result.message);
                    }
                } catch (e) {
                    alert('å„²å­˜å¤±æ•— (å¯èƒ½æ˜¯ç¶²è·¯å•é¡Œæˆ–è…³æœ¬éŒ¯èª¤): ' + e.message);
                } finally {
                    isLoading.value = false;
                }
            };

            // æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®—å„€è¡¨æ¿ç¸½è¦½æ•¸æ“š (ç¸½è³‡ç”¢ã€ç¸½æŒå€‰ã€ç¸½æç›Š)
            const dashboard = computed(() => {
                const sorted = [...transactions.value].sort((a, b) => new Date(a.date) - new Date(b.date));
                let cash = 0;
                let holdings = {}; 
                let monthlyStats = {}; 
                let totalRealizedPnL = 0;
                let investedAmount = 0;

                // 1. è¨ˆç®—ç¾é‡‘èª¿æ•´
                cashAdjustments.value.forEach(adj => cash += adj.amount);

                // 2. éæ­·äº¤æ˜“
                sorted.forEach(t => {
                    const sym = t.symbol.toUpperCase();
                    if (!holdings[sym]) holdings[sym] = { shares: 0, totalCost: 0, avgCost: 0 };
                    const total = t.price * t.shares;

                    if (t.type === 'buy') {
                        cash -= total;
                        holdings[sym].totalCost += total;
                        holdings[sym].shares += t.shares;
                        if (holdings[sym].shares > 0) holdings[sym].avgCost = holdings[sym].totalCost / holdings[sym].shares;
                    } else if (t.type === 'sell') {
                        cash += total;
                        const costBasis = holdings[sym].avgCost * t.shares;
                        const realized = total - costBasis;
                        
                        totalRealizedPnL += realized;
                        
                        // æœˆåº¦
                        const month = t.date.substring(0, 7);
                        if (!monthlyStats[month]) monthlyStats[month] = { pnl: 0, count: 0 };
                        monthlyStats[month].pnl += realized;
                        monthlyStats[month].count += 1;

                        holdings[sym].shares -= t.shares;
                        holdings[sym].totalCost -= costBasis;
                    }
                });

                // è¨ˆç®—ç•¶å‰æŠ•å…¥æˆæœ¬
                for (let sym in holdings) {
                    if (holdings[sym].shares > 0) investedAmount += holdings[sym].totalCost;
                }

                // æœˆä»½æ’åº
                const sortedMonthly = Object.keys(monthlyStats).sort().reverse().reduce((obj, key) => { 
                    obj[key] = monthlyStats[key]; 
                    return obj;
                }, {});

                return { cash, holdings, monthlyStats: sortedMonthly, totalRealizedPnL, investedAmount };
            });

            // æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®—æ¯ç­†äº¤æ˜“çš„è©³ç´°æç›Š (ç”¨æ–¼åˆ—è¡¨é¡¯ç¤º)
            const sortedTransactions = computed(() => {
                // 1. å…ˆæŒ‰æ™‚é–“æ­£åºæ’åˆ—ï¼Œä»¥æ­£ç¢ºè¨ˆç®—æˆæœ¬æµå‹•
                const chronological = [...transactions.value].sort((a, b) => new Date(a.date) - new Date(b.date));
                const tempHoldings = {};
                
                // 2. é€æ­¥è¨ˆç®—
                const processed = chronological.map(t => {
                    const sym = t.symbol.toUpperCase();
                    if (!tempHoldings[sym]) tempHoldings[sym] = { shares: 0, totalCost: 0, avgCost: 0 };
                    
                    let realizedPnL = 0;
                    let roi = 0;
                    const totalAmount = t.price * t.shares;

                    if (t.type === 'buy') {
                        tempHoldings[sym].totalCost += totalAmount;
                        tempHoldings[sym].shares += t.shares;
                        if (tempHoldings[sym].shares > 0) {
                            tempHoldings[sym].avgCost = tempHoldings[sym].totalCost / tempHoldings[sym].shares;
                        }
                    } else {
                        const costBasis = tempHoldings[sym].avgCost * t.shares;
                        realizedPnL = totalAmount - costBasis;
                        if(costBasis > 0) roi = (realizedPnL / costBasis) * 100;

                        tempHoldings[sym].shares -= t.shares;
                        tempHoldings[sym].totalCost -= costBasis;
                    }

                    return {
                        ...t,
                        totalAmount: totalAmount,
                        realizedPnL: realizedPnL,
                        roi: roi
                    };
                });

                // 3. æœ€å¾Œå€’åºæ’åˆ— (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
                return processed.sort((a, b) => new Date(b.date) - new Date(a.date));
            });

            const sortedAdjustments = computed(() => {
                return [...cashAdjustments.value].sort((a, b) => new Date(b.date) - new Date(a.date));
            });

            // æ“ä½œæ–¹æ³•
            const addTransaction = () => {
                if (!form.symbol || !form.price || !form.shares) return alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
                
                transactions.value.push({
                    id: Date.now(),
                    date: form.date,
                    type: form.type,
                    symbol: form.symbol.toUpperCase(),
                    price: parseFloat(form.price),
                    shares: parseFloat(form.shares)
                });
                
                form.symbol = ''; form.price = ''; form.shares = '';
                markAsChanged();
            };

            const removeTransaction = (id) => {
                if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ')) {
                    transactions.value = transactions.value.filter(t => t.id !== id);
                    markAsChanged();
                }
            };

            const addCashAdjustment = () => {
                if (!cashForm.amount) return;
                cashAdjustments.value.push({
                    id: Date.now(),
                    date: cashForm.date,
                    amount: parseFloat(cashForm.amount),
                    note: cashForm.note || 'è³‡é‡‘èª¿æ•´'
                });
                showCashModal.value = false;
                cashForm.amount = ''; cashForm.note = '';
                markAsChanged();
            };

            const removeAdjustment = (id) => {
                if(confirm('ç¢ºå®šåˆªé™¤æ­¤è³‡é‡‘ç´€éŒ„ï¼Ÿ')) {
                    cashAdjustments.value = cashAdjustments.value.filter(a => a.id !== id);
                    markAsChanged();
                }
            };

            const formatCurrency = (val, decimals = 2) => {
                if (val === undefined || val === null) return '0.00';
                return val.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
            };

            return {
                form, cashForm, showCashModal, dashboard, sortedTransactions, sortedAdjustments,
                addTransaction, removeTransaction, addCashAdjustment, removeAdjustment,
                formatCurrency, fetchData, saveData, isLoading, loadingMsg, unsavedChanges
            };
        }
    }).mount('#app');
</script>
</body>
</html>
