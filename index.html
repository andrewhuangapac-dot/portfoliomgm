<!DOCTYPE html>
<html lang="zh-TW" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ç¾è‚¡é‡åŒ–æˆ°æƒ…å®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; transition: background-color 0.3s; }
        .text-up { color: #10b981; } .text-down { color: #ef4444; }
        .progress-bar-bg { background: #e2e8f0; border-radius: 4px; height: 5px; width: 100%; overflow: hidden; }
        .dark .progress-bar-bg { background: #334155; }
        .sidebar-item.active { border-left: 4px solid #6366f1; background: rgba(99, 102, 241, 0.1); font-weight: 900; }
        .layout-container { display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 220px; flex-shrink: 0; overflow-y: auto; border-right: 1px solid #e2e8f0; }
        .dark .sidebar { border-right-color: #334155; }
        .main-content { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200">
<div id="app" class="layout-container">
    <div class="sidebar bg-white dark:bg-slate-900 p-4">
        <div class="mb-8"><h1 class="text-xl font-black">Quant Terminal</h1><span class="text-[10px] font-black text-indigo-500 uppercase">v5.0 Stable Matrix</span></div>
        <div @click="currentTab = 'å…¨å±€'" class="sidebar-item cursor-pointer px-3 py-2.5 rounded-lg mb-4 flex items-center gap-2" :class="{'active': currentTab === 'å…¨å±€'}">ğŸŒ å…¨å±€ç¸½è¦½</div>
        <div class="text-[10px] font-black text-slate-400 mb-2 px-3 uppercase tracking-widest">è¡Œæ¥­æ¿å¡Š</div>
        <div v-for="sector in sectorList" :key="sector.name" @click="currentTab = sector.name" class="sidebar-item cursor-pointer px-3 py-2.5 rounded-lg mb-1 flex justify-between items-center" :class="{'active': currentTab === sector.name}">
            <span class="text-xs font-bold">{{ sector.name }}</span><span class="text-[9px] bg-slate-100 dark:bg-slate-800 px-1.5 rounded">{{ sector.count }}</span>
        </div>
    </div>

    <div class="main-content no-scrollbar pb-24">
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div><h2 class="text-2xl font-black tracking-tight">{{ currentTab }}</h2><p v-if="isSyncing" class="text-blue-500 text-[10px] animate-pulse font-black uppercase">ğŸ”„ Syncing Backend...</p></div>
            <div class="flex gap-2">
                <button @click="runAutoSectorMap" :disabled="isReorganizing" class="px-3 py-1.5 bg-indigo-600 text-white rounded-xl text-xs font-black shadow-lg">âœ¨ AI æ™ºèƒ½åˆ†é¡</button>
                <button @click="toggleDarkMode" class="px-3 py-1.5 bg-slate-200 dark:bg-slate-800 rounded-xl text-xs font-bold">ğŸŒ“</button>
                <button @click="fetchData(true)" class="px-3 py-1.5 bg-white dark:bg-slate-800 border rounded-xl text-xs font-bold">ğŸ”„ åŒæ­¥</button>
            </div>
        </header>

        <div v-if="currentTab === 'å…¨å±€'">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
                <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm"><p class="text-[10px] text-slate-400 font-black uppercase">å¯ç”¨ç¾é‡‘</p><p class="text-lg font-black mt-1">${{ formatCurrency(dashboard.cash) }}</p></div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm"><p class="text-[10px] text-slate-400 font-black uppercase">æŒå€‰æˆæœ¬</p><p class="text-lg font-black mt-1">${{ formatCurrency(dashboard.investedAmount) }}</p></div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm"><p class="text-[10px] text-slate-400 font-black uppercase">æœªå¯¦ç¾æç›Š</p><p class="text-lg font-black mt-1" :class="dashboard.totalUnrealized >= 0 ? 'text-up' : 'text-down'">${{ formatCurrency(dashboard.totalUnrealized) }}</p></div>
                <div class="bg-slate-900 dark:bg-black p-4 rounded-3xl shadow-xl flex flex-col justify-center"><p class="text-[10px] text-slate-400 font-bold uppercase">ç¸½è³‡ç”¢ (NAV)</p><p class="text-2xl font-black text-white mt-1">${{ formatCurrency(dashboard.totalNav) }}</p></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white dark:bg-slate-800 p-5 rounded-[2rem] border shadow-sm">
                    <h3 class="text-[11px] font-black uppercase text-slate-400 mb-4 tracking-widest">æ ¸å¿ƒæŒå€‰ Top 5</h3>
                    <div class="flex flex-col lg:flex-row items-center gap-6">
                        <div class="relative w-40 h-40 shrink-0"><canvas id="allocationChart"></canvas></div>
                        <div class="flex-1 w-full space-y-2">
                            <div v-for="(h, i) in top5Holdings" :key="h.symbol" class="flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-900 rounded-xl">
                                <div class="flex items-center gap-2"><span class="text-[10px] font-black text-white bg-indigo-600 px-1.5 py-0.5 rounded">{{i+1}}</span><span class="font-black text-xs uppercase">{{ h.symbol }}</span></div>
                                <div class="text-right"><span class="text-[11px] font-bold block">{{ h.weight }}%</span><span class="text-[9px] font-mono" :class="h.unrealizedPnL >= 0 ? 'text-up' : 'text-down'">${{ formatCurrency(h.unrealizedPnL, 0) }}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-[2rem] border shadow-sm"><h3 class="text-[11px] font-black uppercase text-slate-400 mb-2">NAV æ­·å²æ›²ç·š</h3><div class="relative h-48"><canvas id="navChart"></canvas></div></div>
            </div>
            
            <div class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] border shadow-sm mb-6">
                <h3 class="font-black text-xs uppercase text-slate-500 mb-4 tracking-widest">ğŸš€ åŸ·è¡Œäº¤æ˜“</h3>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                    <input type="date" v-model="form.date" class="bg-slate-50 dark:bg-slate-900 border p-3 rounded-xl text-sm outline-none">
                    <select v-model="form.type" class="bg-slate-50 dark:bg-slate-900 border p-3 rounded-xl text-sm font-black outline-none"><option value="buy">è²·å…¥</option><option value="sell">è³£å‡º</option></select>
                    <input type="text" v-model="form.symbol" placeholder="ä»£è™Ÿ" class="bg-slate-50 dark:bg-slate-900 border p-3 rounded-xl text-sm uppercase font-black md:col-span-2">
                    <input type="number" step="0.01" v-model.number="form.price" placeholder="åƒ¹æ ¼" class="bg-slate-50 dark:bg-slate-900 border p-3 rounded-xl text-sm font-mono">
                    <input type="number" v-model.number="form.shares" placeholder="è‚¡æ•¸" class="bg-slate-50 dark:bg-slate-900 border p-3 rounded-xl text-sm font-mono">
                    <button @click="addTransaction" class="col-span-2 md:col-span-6 bg-blue-600 text-white p-3.5 rounded-2xl font-black">å¯«å…¥è³‡æ–™åº«</button>
                </div>
            </div>
        </div>

        <div v-show="currentTab !== 'å…¨å±€'">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                <div class="lg:col-span-3 bg-slate-100 dark:bg-slate-800 p-5 rounded-[2rem] border flex flex-col">
                    <div class="flex justify-between items-center mb-4"><span class="text-xs font-black text-indigo-600 uppercase">ğŸ‘‘ æ¿å¡ŠåŸºæº– ETF (90D)</span><span class="text-[10px] text-slate-500 bg-white dark:bg-slate-900 px-3 py-1 rounded-lg">{{ getSectorInfo(currentTab).desc }}</span></div>
                    <div class="flex-1 relative w-full h-32 bg-white dark:bg-slate-900 rounded-xl border flex items-center justify-center">
                        <span v-if="isFetchingHistory" class="text-xs text-slate-400 animate-pulse font-black uppercase">Retrieving Data...</span>
                        <canvas v-else id="benchmarkChart"></canvas>
                        <div v-if="!isFetchingHistory && benchmarkHistory.pctChange !== undefined" class="absolute top-3 left-4"><span class="font-black text-lg">{{ benchmarkHistory.symbol }}</span><span class="ml-2 font-mono text-sm font-black" :class="benchmarkHistory.pctChange >= 0 ? 'text-up' : 'text-down'">{{ benchmarkHistory.pctChange >= 0 ? '+' : '' }}{{ benchmarkHistory.pctChange }}%</span></div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-[2rem] border lg:col-span-1 flex flex-col">
                    <h3 class="text-[11px] font-black uppercase text-slate-500 mb-3 tracking-widest">ğŸ† å¸‚å ´è¡Œæ¥­å¼·å‹¢è‚¡</h3>
                    <div class="flex-1 flex flex-col gap-2">
                        <div v-for="(sym, i) in getSectorGainers(currentTab)" :key="sym" class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-900 rounded-xl"><span class="font-black text-sm flex items-center gap-2"><span class="text-[10px] bg-slate-200 dark:bg-slate-700 px-1.5 rounded text-slate-500 font-mono">{{i+1}}</span> {{ sym }}</span><span class="text-[10px] text-slate-400 font-black">Alpha</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-slate-800 rounded-[2rem] border shadow-sm mb-6">
            <div class="p-5 bg-slate-50 dark:bg-slate-900 border-b flex justify-between items-center"><span class="font-black text-xs uppercase text-slate-500">ğŸ’¼ {{ currentTab }} æŒå€‰é›·é”</span><button v-if="currentTab === 'å…¨å±€'" @click="scanAllQuantRisk" :disabled="isScanningAll" class="bg-indigo-600 text-white text-[11px] font-black px-4 py-2 rounded-xl">ğŸš€ å§”å“¡æœƒæ·±åº¦æƒæ</button></div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm min-w-[1000px]"><thead class="bg-slate-50 dark:bg-slate-900 text-[10px] font-bold text-left"><tr><th class="p-4">æ¨™çš„</th><th class="p-4 text-right">ç¾åƒ¹</th><th class="p-4 text-right">æœªå¯¦ç¾æç›Š</th><th class="p-4">ğŸ¯ æ•˜äº‹èˆ‡å‚¬åŒ–</th><th class="p-4">ğŸ›¡ï¸ è¡Œå‹•æŒ‡ä»¤</th></tr></thead><tbody class="divide-y">
                    <tr v-for="h in filteredHoldings" :key="h.symbol" class="hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                        <td class="p-4 font-black text-lg">{{ h.symbol }}<div class="text-[9px] text-slate-400">{{ h.shares }} è‚¡</div></td>
                        <td class="p-4 text-right font-mono font-bold">${{ formatCurrency(h.currentPrice, 2) }}</td>
                        <td class="p-4 text-right font-black font-mono" :class="h.unrealizedPnL >= 0 ? 'text-up' : 'text-down'">${{ formatCurrency(h.unrealizedPnL, 0) }}</td>
                        <td class="p-4 w-56"><div v-if="quantData[h.symbol]"><div class="flex justify-between text-[9px] font-bold mb-0.5"><span>æ•˜äº‹</span><span>{{quantData[h.symbol].narrative_score}}%</span></div><div class="progress-bar-bg mb-2"><div class="h-full bg-blue-500" :style="{width: quantData[h.symbol].narrative_score+'%'}"></div></div><div class="flex justify-between text-[9px] font-bold mb-0.5"><span>å‚¬åŒ–åŠ‘</span><span>{{quantData[h.symbol].catalyst_prob}}%</span></div><div class="progress-bar-bg"><div class="h-full bg-red-500" :style="{width: quantData[h.symbol].catalyst_prob+'%'}"></div></div></div><span v-else class="text-[10px] text-slate-400 italic">ç­‰å¾…æƒæ...</span></td>
                        <td class="p-4 w-48"><div v-if="quantData[h.symbol]"><div class="text-[10px] font-black text-amber-600 bg-amber-50 dark:bg-amber-900/30 p-2 rounded-lg leading-snug">{{quantData[h.symbol].action_zone}}</div></div><span v-else class="text-[10px] text-slate-400 italic">-</span></td>
                    </tr>
                </tbody></table>
            </div>
        </div>

        <div v-show="currentTab !== 'å…¨å±€'" class="bg-white dark:bg-slate-800 rounded-[2rem] border p-5 mb-6">
            <h3 class="font-black text-xs uppercase text-slate-500 mb-4 flex items-center gap-2 tracking-widest">ğŸ“° æ¿å¡Šå‚¬åŒ–åŠ‘æµ (æ¯æŒè‚¡ 5 å‰‡)</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <a v-for="(news, i) in sectorNews" :key="i" :href="news.link" target="_blank" class="block p-4 bg-slate-50 dark:bg-slate-900/50 hover:bg-slate-100 rounded-2xl border transition">
                    <div class="flex items-start gap-3"><span class="bg-indigo-600 text-white px-2 py-0.5 rounded text-[10px] font-black shrink-0">{{ news.symbol }}</span><div><p class="text-sm font-bold text-slate-800 dark:text-slate-200 leading-snug">{{ news.title }}</p><p class="text-[10px] text-slate-400 mt-2 uppercase font-mono">{{ new Date(news.pubDate).toLocaleDateString() }}</p></div></div>
                </a>
            </div>
        </div>
    </div>

    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end">
        <div v-if="showCopilot" class="bg-white dark:bg-slate-800 w-[350px] h-[450px] mb-4 rounded-3xl shadow-2xl border flex flex-col overflow-hidden">
            <div class="bg-slate-900 p-4 flex justify-between items-center text-white font-black">ğŸ¤– Qwen Copilot<button @click="showCopilot = false">&times;</button></div>
            <div class="flex-1 p-4 overflow-y-auto bg-slate-50 dark:bg-slate-900 text-sm no-scrollbar" id="chat-box">
                <div v-for="(msg, i) in chatHistory" :key="i" class="mb-3" :class="msg.role==='user'?'text-right':'text-left'"><div class="inline-block p-3 rounded-2xl" :class="msg.role==='user'?'bg-blue-600 text-white':'bg-white dark:bg-slate-800 border'" v-html="marked.parse(msg.text)"></div></div>
                <div v-if="isChatting" class="text-blue-500 font-black text-[9px] animate-pulse">COMMITTEE DISCUSSING...</div>
            </div>
            <div class="p-3 bg-white dark:bg-slate-800 border-t flex gap-2"><input v-model="chatInput" @keyup.enter="sendChat" placeholder="è©¢å•ç­–ç•¥..." class="flex-1 bg-slate-50 dark:bg-slate-900 border rounded-xl px-3 outline-none text-sm"><button @click="sendChat" class="bg-slate-900 text-white rounded-xl px-4 py-2 font-black">â†’</button></div>
        </div>
        <button @click="showCopilot = !showCopilot" class="w-14 h-14 bg-slate-900 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition focus:outline-none">ğŸ’¬</button>
    </div>
</div>

<script>
const { createApp, reactive, computed, onMounted, ref, watch, nextTick } = Vue;

const API_URL = 'https://script.google.com/macros/s/AKfycbyMq3XEjv4xWYmeeEPGZj4IV-3YPbtLW80y6XROe0oucOzbtinBoJ09vGytM_6YurE7/exec'; 

createApp({
    setup() {
        const transactions = ref([]); const marketData = ref({}); const navHistoryData = ref([]); 
        const quantData = reactive({}); const isSyncing = ref(false); const isScanningAll = ref(false); const isReorganizing = ref(false);
        const isFetchingHistory = ref(false); const benchmarkHistory = reactive({ symbol: '', prices: [], pctChange: 0 });
        let benchChartInstance, pieChart, lineChart;
        const password = ref(localStorage.getItem('p_pass') || '');
        const form = reactive({ date: new Date().toISOString().split('T')[0], type: 'buy', symbol: '', price: '', shares: '' });
        const searchQuery = ref(''); const currentTab = ref('å…¨å±€');
        const showCopilot = ref(false); const chatInput = ref(''); const chatHistory = ref([]); const isChatting = ref(false);
        const aiSectorMap = ref({}); const dynamicBenchmarks = ref({}); const sectorNews = ref([]); const isFetchingNews = ref(false);

        const getSectorETF = (s) => (dynamicBenchmarks.value[s]?.etf) || null;
        const getSectorGainers = (s) => (dynamicBenchmarks.value[s]?.top_gainers) || [];
        const getSectorInfo = (s) => (dynamicBenchmarks.value[s]?.desc) ? { desc: dynamicBenchmarks.value[s].desc } : { desc: 'è«‹é»æ“Š [AIæ™ºèƒ½åˆ†é¡]' };

        const fetchData = async (force) => {
            if (!password.value) { const p = prompt('å¯†ç¢¼:'); if(p) { password.value = p; localStorage.setItem('p_pass', p); } else return; }
            isSyncing.value = true;
            try {
                const res = await fetch(`${API_URL}?action=read&password=${encodeURIComponent(password.value)}`);
                const d = await res.json();
                transactions.value = d.transactions||[]; marketData.value = d.marketData||{}; navHistoryData.value = d.navHistory||[]; 
                aiSectorMap.value = d.aiSectorMap||{}; dynamicBenchmarks.value = d.dynamicBenchmarks||{}; Object.assign(quantData, d.quantData||{});
                localStorage.setItem('app_cache', JSON.stringify({transactions: d.transactions, marketData: d.marketData, aiSectorMap: d.aiSectorMap, dynamicBenchmarks: d.dynamicBenchmarks}));
            } catch (e) { if(force) alert("åŒæ­¥å¤±æ•—"); } finally { isSyncing.value = false; }
        };

        onMounted(() => { 
            const c = localStorage.getItem('app_cache'); if(c){ const p=JSON.parse(c); transactions.value=p.transactions||[]; marketData.value=p.marketData||{}; aiSectorMap.value=p.aiSectorMap||{}; dynamicBenchmarks.value=p.dynamicBenchmarks||{}; }
            if(password.value) fetchData(false); if(localStorage.getItem('theme')==='dark') document.documentElement.classList.add('dark');
        });

        const dashboard = computed(() => {
            let cash = 100000, holdings = {}, investedAmount = 0, totalUnrealized = 0;
            transactions.value.forEach(t => {
                const s = t.symbol.toUpperCase(); const sect = aiSectorMap.value[s] || 'ğŸ“ æœªåˆ†é¡';
                if(!holdings[s]) holdings[s] = {symbol:s, sector:sect, shares:0, totalCost:0};
                if(t.type==='buy') { holdings[s].shares += t.shares; holdings[s].totalCost += t.price*t.shares; cash -= t.price*t.shares; }
                else { holdings[s].shares -= t.shares; holdings[s].totalCost -= (holdings[s].totalCost/holdings[s].shares||0)*t.shares; cash += t.price*t.shares; }
            });
            Object.keys(holdings).forEach(s => {
                const h = holdings[s]; if(h.shares > 0) {
                    const cur = marketData.value[s]?.price || 0; h.currentPrice = cur;
                    h.unrealizedPnL = (cur * h.shares) - h.totalCost; h.unrealizedPnLPercent = ((h.unrealizedPnL/h.totalCost)*100).toFixed(2);
                    investedAmount += h.totalCost; totalUnrealized += h.unrealizedPnL;
                }
            });
            return { cash, holdings, investedAmount, totalUnrealized, totalNav: cash + investedAmount + totalUnrealized };
        });

        const top5Holdings = computed(() => {
            if(!dashboard.value.totalNav) return [];
            return Object.values(dashboard.value.holdings).filter(h => h.shares > 0)
                .map(h => ({ symbol: h.symbol, val: h.shares*h.currentPrice, weight: ((h.shares*h.currentPrice)/dashboard.value.totalNav*100).toFixed(1), unrealizedPnL: h.unrealizedPnL }))
                .sort((a,b) => b.val - a.val).slice(0, 5);
        });

        const sectorList = computed(() => {
            const s = {}; Object.values(dashboard.value.holdings).forEach(h => { if(h.shares > 0) s[h.sector] = (s[h.sector]||0) + 1; });
            return Object.keys(s).map(n => ({ name: n, count: s[n] })).sort((a,b)=>b.count-a.count);
        });

        const filteredHoldings = computed(() => {
            const all = Object.values(dashboard.value.holdings).filter(h => h.shares > 0);
            return currentTab.value === 'å…¨å±€' ? all : all.filter(h => h.sector === currentTab.value);
        });

        const currentSectorStats = computed(() => {
            if (currentTab.value === 'å…¨å±€' || !filteredHoldings.value.length) return null;
            let tv = 0, tn = 0, tc = 0, count = 0;
            filteredHoldings.value.forEach(h => {
                tv += h.shares * h.currentPrice;
                if (quantData[h.symbol]) { tn += quantData[h.symbol].narrative_score; tc += quantData[h.symbol].catalyst_prob; count++; }
            });
            return { weightPercent: ((tv/dashboard.value.totalNav)*100).toFixed(1), avgNarrative: count?Math.round(tn/count):0, avgCatalyst: count?Math.round(tc/count):0 };
        });

        const renderChart = () => {
            if(currentTab.value!=='å…¨å±€') return;
            setTimeout(() => {
                const ctxP = document.getElementById('allocationChart'); if(ctxP) { if(pieChart) pieChart.destroy(); pieChart = new Chart(ctxP, { type:'doughnut', data:{ labels: top5Holdings.value.map(h=>h.symbol), datasets:[{data:top5Holdings.value.map(h=>h.val), backgroundColor:['#6366f1','#10b981','#f59e0b','#ef4444','#ec4899']}] }, options:{ cutout:'80%', plugins:{legend:{display:false}} } }); }
                const ctxL = document.getElementById('navChart'); if(ctxL) { if(lineChart) lineChart.destroy(); lineChart = new Chart(ctxL, { type:'line', data:{ labels:navHistoryData.value.map(h=>h.date), datasets:[{data:navHistoryData.value.map(h=>h.nav), borderColor:'#8b5cf6', fill:false, tension:0.4}] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} } }); }
            }, 200);
        };
        watch(() => [dashboard.value.holdings, currentTab.value], renderChart, { deep: true });

        watch(currentTab, async (newTab) => {
            if(newTab==='å…¨å±€') return;
            const etf = getSectorETF(newTab);
            if(etf) {
                isFetchingHistory.value = true;
                try {
                    const res = await fetch(`${API_URL}?action=get_history&symbols=${encodeURIComponent(JSON.stringify([etf]))}&password=${encodeURIComponent(password.value)}`);
                    const d = await res.json();
                    if(d.data[etf]) { benchmarkHistory.symbol=etf; benchmarkHistory.prices=d.data[etf].prices; benchmarkHistory.pctChange=d.data[etf].pctChange; 
                        nextTick(() => {
                            const ctx = document.getElementById('benchmarkChart'); if(!ctx) return;
                            if(benchChartInstance) benchChartInstance.destroy();
                            const color = benchmarkHistory.pctChange >= 0 ? '#10b981' : '#ef4444';
                            benchChartInstance = new Chart(ctx, { type: 'line', data: { labels: benchmarkHistory.prices.map((_,i)=>i), datasets:[{data:benchmarkHistory.prices, borderColor:color, backgroundColor:color+'1A', fill:true, pointRadius:0, tension:0.1}] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false},y:{display:false}}, layout:{padding:{top:40}} } });
                        });
                    }
                } catch(e) {} finally { isFetchingHistory.value = false; }
            }
            sectorNews.value = []; isFetchingNews.value = true;
            try {
                for(const h of filteredHoldings.value) {
                    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent('https://news.google.com/rss/search?q='+h.symbol+'+stock+news&hl=en-US&gl=US&ceid=US:en')}`);
                    const d = await res.json(); if(d.items) d.items.slice(0,5).forEach(item => sectorNews.value.push({symbol:h.symbol, title:item.title, link:item.link, pubDate:item.pubDate}));
                }
                sectorNews.value.sort((a,b)=>new Date(b.pubDate)-new Date(a.pubDate));
            } catch(e) {} finally { isFetchingNews.value = false; }
        });

        const scanAllQuantRisk = async () => {
            isScanningAll.value = true;
            const syms = Object.keys(dashboard.value.holdings).filter(s => dashboard.value.holdings[s].shares > 0);
            for(const s of syms) {
                quantData[s] = {action_zone: 'ğŸš€ Agent æ¿€è¾¯ä¸­...'};
                const r = await fetch(`${API_URL}?action=quant_scan_all&symbols=${encodeURIComponent(JSON.stringify([s]))}&password=${encodeURIComponent(password.value)}`);
                const d = await r.json(); if(d.status==='success') quantData[s] = d.data[s];
            }
            isScanningAll.value = false;
        };

        const sendChat = async () => {
            if(!chatInput.value.trim() || isChatting.value) return;
            const text = chatInput.value; chatHistory.value.push({role:'user', text}); chatInput.value=''; isChatting.value=true;
            try {
                const r = await fetch(`${API_URL}?action=copilot&msg=${encodeURIComponent(text)}&context=NAV:${dashboard.value.totalNav}&password=${encodeURIComponent(password.value)}`);
                const d = await r.json(); chatHistory.value.push({role:'ai', text: d.reply});
            } catch(e) { chatHistory.value.push({role:'ai', text: 'è¶…æ™‚'}); } finally { isChatting.value = false; }
        };

        const runAutoSectorMap = async () => {
            isReorganizing.value = true;
            try { await fetch(`${API_URL}?action=auto_sector_map&password=${encodeURIComponent(password.value)}`); await fetchData(false); }
            catch(e) {} finally { isReorganizing.value = false; }
        };

        return {
            dashboard, form, transactions, quantData, isSyncing, isScanningAll, isReorganizing, currentTab, sectorList, filteredHoldings, 
            currentSectorStats, getSectorETF, getSectorGainers, getSectorInfo, sectorNews, isFetchingNews, isFetchingHistory, benchmarkHistory, top5Holdings,
            showCopilot, chatInput, chatHistory, isChatting,
            fetchData, saveData, toggleDarkMode: () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark')?'dark':'light'); renderChart(); },
            addTransaction: () => { if(form.symbol) { transactions.value.push({id:Date.now(), ...form, symbol:form.symbol.toUpperCase()}); form.symbol=''; } },
            removeTransaction: (id) => { transactions.value = transactions.value.filter(t=>t.id!==id); },
            runAutoSectorMap, scanAllQuantRisk, sendChat, formatCurrency: (v,d=0)=> (v||0).toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d}), marked
        };
    }
}).mount('#app');
</script>
</body>
</html>
