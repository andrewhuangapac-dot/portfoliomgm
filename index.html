<!DOCTYPE html>
<html lang="zh-TW" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç¾è‚¡é‡åŒ–æˆ°æƒ…å®¤ v4.6 (AI æ™ºèƒ½åˆ†é¡ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s ease; }
        .text-up { color: #10b981; } .text-down { color: #ef4444; } 
        .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .markdown-content p { margin-bottom: 12px; } .markdown-content h3 { font-weight: 900; margin-top: 16px; margin-bottom: 8px; color: #0f172a; }
        .dark .markdown-content h3 { color: #f8fafc; } .markdown-content ul { list-style-type: disc; padding-left: 20px; }
        .progress-bar-bg { background: #e2e8f0; border-radius: 4px; height: 5px; width: 100%; overflow: hidden; }
        .dark .progress-bar-bg { background: #334155; }
        .progress-fill-red { background: linear-gradient(90deg, #ef4444, #f97316); }
        .progress-fill-blue { background: linear-gradient(90deg, #3b82f6, #0ea5e9); }
        .progress-fill-green { background: linear-gradient(90deg, #10b981, #14b8a6); }
        .progress-fill-purple { background: linear-gradient(90deg, #8b5cf6, #c084fc); }
        .sidebar-item { transition: all 0.2s ease-in-out; border-left: 4px solid transparent; }
        .sidebar-item.active { border-left-color: #6366f1; background-color: rgba(99, 102, 241, 0.1); color: #4f46e5; font-weight: 900; }
        .dark .sidebar-item.active { color: #818cf8; background-color: rgba(99, 102, 241, 0.2); }
        .layout-container { display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 220px; flex-shrink: 0; overflow-y: auto; border-right: 1px solid #e2e8f0; }
        .dark .sidebar { border-right-color: #334155; }
        .main-content { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
        @media (max-width: 1024px) {
            .layout-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid #e2e8f0; display: flex; overflow-x: auto; white-space: nowrap; padding-bottom: 0.5rem; }
            .sidebar-item { border-left: none; border-bottom: 3px solid transparent; padding: 0.5rem 1rem; }
            .sidebar-item.active { border-left-color: transparent; border-bottom-color: #6366f1; }
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200">
<div id="app" class="layout-container">
    
    <div class="sidebar bg-white dark:bg-slate-900 p-4 no-scrollbar z-10 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
        <div class="mb-8 hidden lg:block">
            <h1 class="text-xl font-black tracking-tight leading-none">Quant<br><span class="text-indigo-600 dark:text-indigo-400">Terminal</span></h1>
            <span class="text-[9px] bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 px-1.5 py-0.5 rounded font-black tracking-widest uppercase mt-1 inline-block">v4.6 AI Matrix</span>
        </div>
        
        <div class="text-[10px] font-black uppercase text-slate-400 mb-2 px-3 tracking-widest hidden lg:block">æŠ•è³‡çµ„åˆè¦–è§’</div>
        <div @click="currentTab = 'å…¨å±€'" class="sidebar-item cursor-pointer px-3 py-2.5 rounded-lg mb-1 lg:mb-4 flex items-center gap-2" :class="{'active': currentTab === 'å…¨å±€'}">
            <span class="text-lg">ğŸŒ</span> <span class="text-sm">å…¨å±€ç¸½è¦½</span>
        </div>

        <div class="text-[10px] font-black uppercase text-slate-400 mb-2 px-3 tracking-widest hidden lg:block">è¡Œæ¥­æ¿å¡Šæ‹†è§£</div>
        <div v-for="sector in sectorList" :key="sector.name" @click="currentTab = sector.name" class="sidebar-item cursor-pointer px-3 py-2.5 rounded-lg mb-1 flex justify-between items-center" :class="{'active': currentTab === sector.name}">
            <div class="flex items-center gap-2 truncate"><span class="text-xs font-bold truncate">{{ sector.name }}</span></div>
            <span class="text-[9px] bg-slate-100 dark:bg-slate-800 px-1.5 rounded text-slate-500 font-mono">{{ sector.count }}</span>
        </div>
    </div>

    <div class="main-content no-scrollbar pb-24">
        
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h2 class="text-2xl font-black tracking-tight">{{ currentTab === 'å…¨å±€' ? 'å…¨å±€æˆ°ç•¥ç¸½è¦½' : currentTab }}</h2>
                <p v-if="isSyncing" class="text-blue-500 text-xs mt-1 animate-pulse font-bold tracking-widest uppercase">ğŸ”„ Syncing Backend...</p>
                <p v-else class="text-slate-500 dark:text-slate-400 text-xs mt-1 font-bold flex items-center gap-1">AI Intelligence <span v-if="Object.keys(aiSectorMap).length > 0" class="bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 px-1.5 py-0.5 rounded text-[9px] ml-1">AI æ™ºèƒ½åˆ†é¡ä¸­</span></p>
            </div>
            <div class="flex flex-wrap gap-2">
                <button @click="runAutoSectorMap" :disabled="isReorganizing" class="px-3 py-1.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl text-xs font-black shadow-lg flex items-center gap-1 hover:scale-105 transition">
                    <span v-if="isReorganizing" class="animate-pulse">â³ é‡çµ„ä¸­...</span>
                    <span v-else>ğŸ§  AI è‡ªå‹•åˆ†é¡</span>
                </button>
                <button @click="runStressTest" class="px-3 py-1.5 bg-gradient-to-r from-red-600 to-orange-600 text-white rounded-xl text-xs font-black shadow-lg flex items-center gap-1 hover:scale-105 transition"><span class="text-sm">ğŸ’¥</span> å£“åŠ›æ¸¬è©¦</button>
                <button @click="toggleDarkMode" class="px-3 py-1.5 bg-slate-200 dark:bg-slate-800 rounded-xl text-xs font-bold shadow-sm">ğŸŒ“</button>
                <button @click="fetchData(true)" class="px-3 py-1.5 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl shadow-sm text-xs font-bold">ğŸ”„ åŒæ­¥</button>
                <button @click="saveData" class="px-3 py-1.5 bg-slate-900 dark:bg-black text-white rounded-xl shadow-lg text-xs font-bold">ğŸ’¾ å„²å­˜æ·¨å€¼</button>
            </div>
        </header>

        <div v-if="currentTab === 'å…¨å±€'">
            <div class="grid grid-cols-2 lg:grid-cols-7 gap-3 mb-6">
                <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700"><p class="text-[10px] text-slate-400 font-black uppercase">å¯ç”¨ç¾é‡‘</p><p class="text-lg lg:text-xl font-black mt-1">${{ formatCurrency(dashboard?.cash) }} <span @click="showCashModal=true" class="text-[10px] text-blue-500 cursor-pointer underline ml-1">èª¿ç¯€</span></p></div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700"><p class="text-[10px] text-slate-400 font-black uppercase">æŒå€‰ç¸½æˆæœ¬</p><p class="text-lg lg:text-xl font-black mt-1">${{ formatCurrency(dashboard?.investedAmount) }}</p></div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700"><p class="text-[10px] text-slate-400 font-black uppercase">å·²å¯¦ç¾æç›Š</p><p class="text-lg lg:text-xl font-black mt-1" :class="(dashboard?.totalRealized || 0) >= 0 ? 'text-up' : 'text-down'">{{ (dashboard?.totalRealized || 0) >= 0 ? '+' : '' }}${{ formatCurrency(dashboard?.totalRealized) }}</p></div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700"><p class="text-[10px] text-slate-400 font-black uppercase">æœªå¯¦ç¾æç›Š</p><p class="text-lg lg:text-xl font-black mt-1" :class="(dashboard?.totalUnrealized || 0) >= 0 ? 'text-up' : 'text-down'">{{ (dashboard?.totalUnrealized || 0) >= 0 ? '+' : '' }}${{ formatCurrency(dashboard?.totalUnrealized) }}</p></div>
                <div class="bg-emerald-50 dark:bg-emerald-900/30 p-4 rounded-3xl shadow-sm border border-emerald-100 dark:border-emerald-800"><p class="text-[10px] text-emerald-600 dark:text-emerald-400 font-black uppercase">é ä¼°å¹´é ˜è‚¡æ¯</p><p class="text-lg lg:text-xl font-black mt-1 text-emerald-700 dark:text-emerald-300">${{ formatCurrency(dashboard?.totalDividend, 0) }}</p></div>
                <div class="bg-slate-900 dark:bg-black p-4 rounded-3xl shadow-xl col-span-2 flex flex-col justify-center"><p class="text-[10px] text-slate-400 font-bold uppercase">ç¸½è³‡ç”¢æ·¨å€¼ (NAV)</p><p class="text-2xl lg:text-3xl font-black text-white mt-1">${{ formatCurrency(dashboard?.totalNav) }}</p></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white dark:bg-slate-800 p-5 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm"><h3 class="text-[11px] font-black uppercase text-slate-400 mb-2">è³‡ç”¢æ¿å¡Šé…ç½®</h3><div class="relative w-full h-48"><canvas id="allocationChart"></canvas></div></div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm"><h3 class="text-[11px] font-black uppercase text-slate-400 mb-2">ç¸½è³‡ç”¢èµ°å‹¢ (Equity Curve)</h3><div class="relative w-full h-48"><canvas id="navChart"></canvas></div></div>
            </div>
            
            <div class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm mb-6">
                <h3 class="font-black text-xs uppercase text-slate-500 mb-4">ğŸš€ å¿«é€ŸåŸ·è¡Œäº¤æ˜“</h3>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                    <input type="date" v-model="form.date" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm outline-none md:col-span-1 col-span-2">
                    <select v-model="form.type" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm font-black outline-none"><option value="buy">è²·å…¥</option><option value="sell">è³£å‡º</option></select>
                    <input type="text" v-model="form.symbol" placeholder="ç›´æ¥è¼¸å…¥ä»£è™Ÿå³å¯" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm uppercase font-black outline-none md:col-span-2 col-span-2">
                    <input type="number" step="0.01" v-model.number="form.price" placeholder="åƒ¹æ ¼" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm font-mono outline-none">
                    <input type="number" v-model.number="form.shares" placeholder="è‚¡æ•¸" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm font-mono outline-none">
                    <button @click="addTransaction" class="col-span-2 md:col-span-6 bg-blue-600 text-white p-3.5 rounded-2xl font-black hover:bg-blue-700 transition shadow-lg">ç¢ºèªå¯«å…¥è³‡æ–™åº«</button>
                </div>
            </div>
        </div>

        <div v-show="currentTab !== 'å…¨å±€'">
            
            <div class="bg-slate-100 dark:bg-slate-800/60 p-5 rounded-[2rem] mb-6 border border-slate-200 dark:border-slate-700 shadow-sm">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-2">
                    <span class="text-xs font-black text-indigo-600 dark:text-indigo-400 uppercase tracking-widest flex items-center gap-2">ğŸ‘‘ åŸºæº–å°æ¨™èˆ‡é¾é ­ (è¿‘3å€‹æœˆå‹•èƒ½èµ°å‹¢)</span>
                    <span class="text-[10px] text-slate-500 bg-white dark:bg-slate-900 px-3 py-1 rounded-lg border border-slate-200 dark:border-slate-700">{{ getSectorInfo(currentTab).desc }}</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div id="tv-widget-0" class="h-[120px] rounded-xl overflow-hidden bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-sm pointer-events-none"></div>
                    <div id="tv-widget-1" class="h-[120px] rounded-xl overflow-hidden bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-sm pointer-events-none"></div>
                    <div id="tv-widget-2" class="h-[120px] rounded-xl overflow-hidden bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-sm pointer-events-none"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6" v-if="currentSectorStats">
                <div class="bg-gradient-to-br from-indigo-50 to-blue-50 dark:from-indigo-900/30 dark:to-blue-900/20 p-5 rounded-[2rem] border border-indigo-100 dark:border-indigo-800/50 shadow-sm flex flex-col justify-center"><p class="text-[10px] text-indigo-500 dark:text-indigo-400 font-black uppercase tracking-widest mb-1">æ¿å¡Šè³‡é‡‘æ¬Šé‡</p><p class="text-3xl font-black text-indigo-700 dark:text-indigo-300">{{ currentSectorStats.weightPercent || 0 }}%</p><p class="text-xs font-bold text-indigo-600/70 dark:text-indigo-400/70 mt-1">å¸‚å€¼ ${{ formatCurrency(currentSectorStats.totalValue || 0) }}</p></div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm flex flex-col justify-center"><p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">æ¿å¡Šå¹³å‡æ•˜äº‹å…±è­˜</p><p class="text-3xl font-black" :class="(currentSectorStats.avgNarrative || 0) > 70 ? 'text-blue-500' : 'text-slate-600'">{{ currentSectorStats.avgNarrative || 0 }}<span class="text-sm ml-1 text-slate-400">/100</span></p></div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm flex flex-col justify-center"><p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">æ¿å¡Šå¹³å‡ç·Šç¼ºå‹•èƒ½</p><p class="text-3xl font-black" :class="(currentSectorStats.avgShortage || 0) > 70 ? 'text-purple-500' : 'text-slate-600'">{{ currentSectorStats.avgShortage || 0 }}<span class="text-sm ml-1 text-slate-400">/100</span></p></div>
            </div>
        </div>

        <div class="bg-white dark:bg-slate-800 rounded-[2rem] border border-slate-100 dark:border-slate-700 overflow-hidden shadow-sm mb-6">
            <div class="p-5 bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <span class="font-black text-xs uppercase text-slate-500">ğŸ’¼ {{ currentTab === 'å…¨å±€' ? 'å››å¤§æ”¯æŸ±é‡åŒ–é›·é” (å…¨æŒå€‰)' : currentTab + ' æ¿å¡Šé›·é”' }}</span>
                <button v-if="currentTab === 'å…¨å±€'" @click="scanAllQuantRisk" :disabled="isScanningAll" class="bg-indigo-600 hover:bg-indigo-700 text-white text-[11px] font-black px-4 py-2 rounded-xl shadow-lg transition flex items-center gap-2"><span v-if="isScanningAll" class="animate-pulse">â³ è™›æ“¬å§”å“¡æœƒè¾¯è«–ä¸­...</span><span v-else>ğŸš€ åŸ·è¡Œå…¨æŒå€‰æ·±åº¦æƒæ (é˜²è¶…æ™‚æ©Ÿåˆ¶)</span></button>
            </div>
            <div class="overflow-x-auto no-scrollbar">
                <table class="w-full text-sm min-w-[1000px]">
                    <thead class="bg-slate-50 dark:bg-slate-900 text-slate-400 text-[10px] uppercase font-bold">
                        <tr><th class="p-4 text-left">æ¨™çš„ (æ¿å¡Š)</th><th class="p-4 text-right">å‡åƒ¹ / ç¾åƒ¹</th><th class="p-4 text-right">æœªå¯¦ç¾æç›Š</th><th class="p-4 text-left w-56">ğŸ¯ ç­–ç•¥æ ¸å¿ƒ (æ•˜äº‹ & å‚¬åŒ–åŠ‘)</th><th class="p-4 text-left w-56">ğŸ”¥ å‹•èƒ½èˆ‡å¥—åˆ© (ç·Šç¼º & éŒ¯å®šåƒ¹)</th><th class="p-4 text-left w-48">ğŸ›¡ï¸ ATR å‹•æ…‹é˜²å®ˆå¸¶</th><th class="p-4 text-center">AIæ·±åº¦</th></tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50 dark:divide-slate-700">
                        <tr v-for="h in (filteredHoldings || [])" :key="h.symbol" class="hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                            <td class="p-4 font-black text-lg">{{ h.symbol }}<div class="mt-0.5"><span class="text-[9px] bg-slate-100 dark:bg-slate-800 text-slate-500 px-1.5 py-0.5 rounded mr-1">{{ h.sector }}</span><span class="text-[10px] font-normal text-slate-400">{{ h.shares }} è‚¡</span></div></td>
                            <td class="p-4 text-right font-mono text-slate-500 dark:text-slate-400">${{ formatCurrency(h.avgCost, 2) }}<span class="block text-[12px] font-bold text-blue-500 dark:text-blue-400">${{ formatCurrency(h.currentPrice, 2) }}</span></td>
                            <td class="p-4 text-right font-black font-mono" :class="h.unrealizedPnL >= 0 ? 'text-up' : 'text-down'">${{ formatCurrency(h.unrealizedPnL, 0) }}<span class="block text-[10px] opacity-70">{{ h.unrealizedPnLPercent }}%</span></td>
                            <td class="p-4"><div v-if="quantData && quantData[h.symbol]"><div class="flex justify-between text-[9px] font-bold text-slate-500 mb-0.5"><span>æ•˜äº‹é–‰ç’°</span><span>{{quantData[h.symbol].narrative_score}}%</span></div><div class="progress-bar-bg mb-2"><div class="h-full progress-fill-blue" :style="{width: quantData[h.symbol].narrative_score + '%'}"></div></div><div class="flex justify-between text-[9px] font-bold text-slate-500 mb-0.5" :class="quantData[h.symbol].catalyst_prob > 65 ? 'text-red-500' : ''"><span>ç¡¬å‚¬åŒ–åŠ‘æ©Ÿç‡</span><span>{{quantData[h.symbol].catalyst_prob}}%</span></div><div class="progress-bar-bg"><div class="h-full" :class="quantData[h.symbol].catalyst_prob > 65 ? 'progress-fill-red' : 'progress-fill-blue'" :style="{width: quantData[h.symbol].catalyst_prob + '%'}"></div></div></div><span v-else class="text-[10px] text-slate-400 italic">å¾…æƒæ...</span></td>
                            <td class="p-4"><div v-if="quantData && quantData[h.symbol]"><div class="flex justify-between text-[9px] font-bold text-slate-500 mb-0.5"><span>è¡Œæ¥­ç·Šç¼ºå‹•èƒ½</span><span>{{quantData[h.symbol].shortage_momentum}}%</span></div><div class="progress-bar-bg mb-2"><div class="h-full progress-fill-purple" :style="{width: quantData[h.symbol].shortage_momentum + '%'}"></div></div><div class="flex justify-between text-[9px] font-bold text-slate-500 mb-0.5"><span>éŒ¯å®šåƒ¹ä¿®å¾©ç©ºé–“</span><span>{{quantData[h.symbol].mispricing_gap}}%</span></div><div class="progress-bar-bg"><div class="h-full progress-fill-green" :style="{width: quantData[h.symbol].mispricing_gap + '%'}"></div></div></div><span v-else class="text-[10px] text-slate-400 italic">å¾…æƒæ...</span></td>
                            <td class="p-4"><div v-if="quantData && quantData[h.symbol]"><div class="text-[10px] font-bold text-slate-500 mb-1">ATR æ³¢å‹•: <span class="font-mono">{{quantData[h.symbol].atr_percent}}%</span></div><div class="text-[10px] font-black text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/30 p-1.5 rounded-lg leading-snug">{{quantData[h.symbol].action_zone}}</div></div><span v-else class="text-[10px] text-slate-400 italic">å¾…æƒæ...</span></td>
                            <td class="p-4 text-center"><button @click="openAIModal(h.symbol)" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-[10px] font-black px-3 py-1.5 rounded-xl hover:bg-slate-200 transition">åˆ†æ</button></td>
                        </tr>
                        <tr v-if="(!filteredHoldings || filteredHoldings.length === 0)"><td colspan="7" class="p-8 text-center text-slate-400 text-xs font-bold uppercase tracking-widest">æ­¤æ¿å¡Šç›®å‰ç„¡æŒå€‰</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div v-show="currentTab !== 'å…¨å±€'" class="bg-white dark:bg-slate-800 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm p-5 mb-6">
            <h3 class="font-black text-xs uppercase text-slate-500 mb-4 flex items-center gap-2">ğŸ“° æ¿å¡Šæœ€æ–°å‚¬åŒ–åŠ‘ (Live News Feed) <span v-if="isFetchingNews" class="animate-pulse text-[10px] text-blue-500">Retrieving...</span></h3>
            <div class="space-y-3">
                <a v-for="(news, i) in sectorNews" :key="i" :href="news.link" target="_blank" class="block p-4 bg-slate-50 dark:bg-slate-900/50 hover:bg-slate-100 dark:hover:bg-slate-900 rounded-xl transition border border-slate-100 dark:border-slate-800">
                    <div class="flex items-start gap-3"><span class="bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 px-2 py-0.5 rounded text-[10px] font-black shrink-0">{{ news.symbol }}</span><div><p class="text-sm font-bold leading-snug text-slate-800 dark:text-slate-200">{{ news.title }}</p><p class="text-[10px] text-slate-400 mt-1 font-mono">{{ new Date(news.pubDate).toLocaleString() }}</p></div></div>
                </a>
                <div v-if="!isFetchingNews && sectorNews.length === 0" class="text-center text-slate-400 text-[10px] py-4 uppercase tracking-widest">æš«ç„¡æœ€æ–°æ–°è</div>
            </div>
        </div>

        <div v-show="currentTab === 'å…¨å±€'" class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-3">
                <div class="bg-white dark:bg-slate-800 rounded-[2rem] border border-slate-100 dark:border-slate-700 overflow-hidden shadow-sm">
                    <div class="p-5 bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700 flex justify-between items-center"><span class="font-black text-xs uppercase text-slate-500">ğŸ“œ æ­·å²äº¤æ˜“ç´€éŒ„</span><input v-model="searchQuery" type="text" placeholder="ğŸ” æœå°‹ä»£è™Ÿ..." class="text-xs p-1.5 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 outline-none w-28 text-center font-bold"></div>
                    <div class="overflow-y-auto no-scrollbar max-h-[600px]">
                        <table class="w-full text-sm min-w-[500px]">
                            <thead class="bg-slate-50 dark:bg-slate-900 text-[10px] text-slate-400 uppercase font-bold sticky top-0 z-10">
                                <tr><th class="p-4 text-left">æ—¥æœŸ</th><th class="p-4 text-left">æ¨™çš„</th><th class="p-4 text-center">æ“ä½œ</th><th class="p-4 text-right">å–®åƒ¹</th><th class="p-4 text-right">è‚¡æ•¸</th><th class="p-4 text-right">å¯¦ç¾æç›Š</th><th class="p-4"></th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50 dark:divide-slate-700">
                                <tr v-for="t in filteredTransactions" :key="t.id" class="hover:bg-slate-50 dark:hover:bg-slate-700 transition h-[51px]">
                                    <td class="p-4 text-[10px] text-slate-400 font-mono">{{ t.date }}</td><td class="p-4 font-black uppercase">{{ t.symbol }}</td>
                                    <td class="p-4 text-center"><span :class="t.type==='buy'?'text-blue-500 bg-blue-50 dark:bg-blue-900/50':'text-amber-500 bg-amber-50 dark:bg-amber-900/50'" class="px-2 py-0.5 rounded-lg text-[9px] font-black uppercase">{{ t.type }}</span></td>
                                    <td class="p-4 text-right font-mono">${{ formatCurrency(t.price, 2) }}</td><td class="p-4 text-right font-mono">{{ t.shares }}</td>
                                    <td class="p-4 text-right font-black font-mono" :class="t.realizedPnL >= 0 ? 'text-up' : 'text-down'"><span v-if="t.type.toLowerCase()==='sell'">${{ formatCurrency(t.realizedPnL, 0) }}</span><span v-else class="text-slate-300 dark:text-slate-600">-</span></td>
                                    <td class="p-4 text-center"><button @click="removeTransaction(t.id)" class="text-slate-300 dark:text-slate-600 hover:text-red-500 font-black">Ã—</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-white dark:bg-slate-800 shadow-2xl rounded-[2rem] border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <div class="p-5 bg-slate-900 dark:bg-black text-white font-black text-xs uppercase flex justify-between"><span>ğŸ“¢ æˆ°ç•¥å…¬å‘Šç™¼å¸ƒ</span></div>
                    <div class="p-5 space-y-3 bg-slate-50 dark:bg-slate-800">
                        <div class="flex gap-2"><input v-model="recForm.symbol" placeholder="ä»£è™Ÿ" class="w-1/2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm uppercase font-black outline-none"><select v-model="recForm.type" class="w-1/2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm font-black outline-none"><option value="New">å»ºå€‰</option><option value="Add">åŠ ç¢¼</option><option value="Reduce">æ¸›ç¢¼</option><option value="Clear">æ¸…å€‰</option></select></div>
                        <div class="flex gap-2"><input v-model.number="recForm.price" type="number" step="0.01" placeholder="ç›®æ¨™åƒ¹æ ¼" class="w-1/2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm font-mono outline-none"><input v-model.number="recForm.count" type="number" placeholder="AIä¿¡å¿ƒ" class="w-1/2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm font-mono outline-none"></div>
                        <button @click="generateAnalysis" :disabled="isGeneratingAnalysis" class="w-full py-2.5 bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300 rounded-xl text-[11px] font-black border border-purple-200 dark:border-purple-800 hover:bg-purple-200 dark:hover:bg-purple-800 transition">{{ isGeneratingAnalysis ? 'â³ AI æ·±åº¦é‹ç®—ä¸­...' : 'âœ¨ è‡ªå‹•ç”Ÿæˆ AI è§€é»' }}</button>
                        <textarea v-model="recForm.analysis" rows="3" placeholder="æ•˜äº‹é‚è¼¯æˆ–å‚¬åŒ–åŠ‘èªªæ˜..." class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-[11px] outline-none"></textarea>
                        <button @click="addRecommendation" class="w-full bg-slate-800 hover:bg-slate-700 text-white py-3 rounded-xl font-black text-xs shadow-lg transition">ç™¼å¸ƒè‡³å°å¤–çœ‹æ¿</button>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm overflow-hidden">
                    <div class="p-5 bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700 font-black text-xs uppercase text-slate-500">å·²ç™¼å¸ƒå…¬å‘Šç´€éŒ„</div>
                    <div class="divide-y divide-slate-50 dark:divide-slate-700 max-h-[300px] overflow-y-auto no-scrollbar">
                        <div v-for="r in sortedRecommendations" :key="r.id" class="p-4 relative">
                            <button @click="removeRecommendation(r.id)" class="absolute top-4 right-4 text-slate-300 hover:text-red-500">Ã—</button>
                            <p class="font-black text-sm">{{ r.symbol }} <span class="text-[9px] text-slate-400 font-mono ml-1">{{ r.date }}</span></p>
                            <div class="flex justify-between items-center mt-1"><span class="text-[10px] font-bold" :class="getRecTypeClass(r.type)">{{ getRecTypeLabel(r.type) }} @ ${{ r.price }}</span><span class="text-[9px] bg-orange-100 dark:bg-orange-900/50 text-orange-700 dark:text-orange-400 px-1.5 rounded-full font-bold">AI: {{ r.count }}</span></div>
                            <div v-if="r.analysis" class="mt-2"><button @click="r.showDetails = !r.showDetails" class="text-[9px] text-blue-500 font-black hover:underline">{{ r.showDetails ? 'éš±è—åˆ†æ â–²' : 'æŸ¥çœ‹è§€é» â–¼' }}</button><div v-if="r.showDetails" class="mt-2 text-[11px] bg-slate-50 dark:bg-slate-900 p-3 rounded-xl leading-relaxed markdown-content border border-slate-100 dark:border-slate-700" v-html="r.analysis ? marked.parse(r.analysis) : ''"></div></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm overflow-hidden">
                    <div class="p-5 bg-slate-50 dark:bg-slate-900 font-black text-xs uppercase text-slate-500">ğŸ“ˆ æ¯æœˆç²åˆ©</div>
                    <div class="max-h-48 overflow-y-auto divide-y divide-slate-50 dark:divide-slate-700 no-scrollbar">
                        <div v-for="s in monthlyStats" :key="s.month" class="p-4 flex justify-between text-sm"><span class="font-bold text-slate-500 uppercase">{{ s.month }}</span><span :class="s.pnl >= 0 ? 'text-up' : 'text-down'" class="font-black font-mono">{{ s.pnl >= 0 ? '+' : '' }}${{ formatCurrency(s.pnl, 0) }}</span></div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-slate-800 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm overflow-hidden">
                    <div class="p-5 bg-slate-50 dark:bg-slate-900 font-black text-xs uppercase text-slate-500">ğŸ’µ ç¾é‡‘æµ</div>
                    <div class="max-h-48 overflow-y-auto divide-y divide-slate-50 dark:divide-slate-700 no-scrollbar">
                        <div v-for="c in sortedCash" :key="c.id" class="p-4 flex justify-between text-sm"><div class="max-w-[60%]"><p class="font-black truncate text-xs">{{ c.note }}</p><p class="text-[10px] text-slate-400 font-mono">{{ c.date }}</p></div><span :class="c.amount >= 0 ? 'text-blue-500' : 'text-red-500'" class="font-black font-mono text-xs">{{ c.amount >= 0 ? '+' : '' }}${{ formatCurrency(c.amount, 0) }}</span></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end">
        <div v-if="showCopilot" class="bg-white dark:bg-slate-800 w-[350px] h-[450px] mb-4 rounded-3xl shadow-2xl border border-slate-200 dark:border-slate-700 flex flex-col overflow-hidden transition-all">
            <div class="bg-gradient-to-r from-slate-900 to-indigo-900 p-4 flex justify-between items-center text-white"><span class="font-black text-sm flex items-center gap-2">ğŸ¤– AI Copilot</span><button @click="showCopilot = false" class="hover:text-slate-300 text-xl leading-none">&times;</button></div>
            <div class="flex-1 p-4 overflow-y-auto bg-slate-50 dark:bg-slate-900 flex flex-col gap-3 text-sm no-scrollbar" id="chat-box">
                <div class="bg-white dark:bg-slate-800 p-3 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 dark:border-slate-700 text-slate-700 dark:text-slate-300 w-[85%] markdown-content">Bossï¼Œå››å¤§æ”¯æŸ±åˆ†æå¼•æ“å·²å°±ç·’ã€‚</div>
                <div v-for="(msg, i) in chatHistory" :key="i" class="flex flex-col w-[85%]" :class="msg.role==='user'?'self-end items-end':'self-start'"><div class="p-3 rounded-2xl shadow-sm border text-[13px]" :class="msg.role==='user'?'bg-blue-600 text-white rounded-tr-none border-blue-700':'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-tl-none border-slate-100 dark:border-slate-700 markdown-content'" v-html="msg.role==='ai'? marked.parse(msg.text) : msg.text"></div></div>
                <div v-if="isChatting" class="self-start bg-white dark:bg-slate-800 p-3 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 dark:border-slate-700 w-[60%]"><span class="animate-pulse font-bold text-blue-500 text-[10px] tracking-widest uppercase">Thinking...</span></div>
            </div>
            <div class="p-3 bg-white dark:bg-slate-800 border-t dark:border-slate-700 flex gap-2"><input v-model="chatInput" @keyup.enter="sendChat" placeholder="è©¢å•è¡Œæƒ…æˆ–ç­–ç•¥..." class="flex-1 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl px-3 outline-none text-sm"><button @click="sendChat" class="bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl px-4 py-2 font-black text-sm">â†’</button></div>
        </div>
        <button @click="showCopilot = !showCopilot" class="w-14 h-14 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition duration-300 focus:outline-none">ğŸ’¬</button>
    </div>
    
    <div v-if="showAIModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-2 z-[60] transition-opacity"><div class="bg-white dark:bg-slate-800 rounded-[2.5rem] w-full max-w-3xl max-h-[85vh] overflow-hidden flex flex-col shadow-2xl border border-slate-200 dark:border-slate-700"><div class="p-5 bg-gradient-to-r from-slate-900 to-indigo-900 text-white flex justify-between items-center font-black"><span class="text-sm uppercase tracking-widest flex items-center gap-2">ğŸ›¡ï¸ Quantum Analysis <span class="text-[10px] bg-white/20 px-2 rounded">{{ selectedSymbol }}</span></span><button @click="showAIModal=false" class="w-8 h-8 flex items-center justify-center bg-white/20 hover:bg-white/30 rounded-full transition">&times;</button></div><div class="p-6 overflow-y-auto flex-1 no-scrollbar bg-slate-50 dark:bg-slate-800"><div v-if="aiLoading" class="flex flex-col items-center py-20"><div class="loader mb-4 border-t-indigo-500 border-4 w-12 h-12"></div><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest italic animate-pulse">Deep Thinking in Progress...</p></div><div v-else class="text-slate-700 dark:text-slate-300 markdown-content" v-html="marked.parse(aiContent || '')"></div></div></div></div>
    <div v-if="showCashModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[60] p-4"><div class="bg-white dark:bg-slate-800 p-6 rounded-3xl w-full max-w-xs shadow-2xl border border-slate-100 dark:border-slate-700"><h3 class="font-black mb-4 uppercase text-xs border-b dark:border-slate-700 pb-2">Cash Adjustment</h3><div class="space-y-4"><input type="date" v-model="cashForm.date" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm outline-none"><input type="number" v-model.number="cashForm.amount" placeholder="é‡‘é¡ (è² æ•¸ç‚ºæ‰£æ¬¾)" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm font-mono outline-none"><input type="text" v-model="cashForm.note" placeholder="å‚™è¨»" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm font-black outline-none"><div class="flex gap-2 pt-2"><button @click="addCashAdjustment" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-black text-xs">ç¢ºèª</button><button @click="showCashModal=false" class="flex-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 py-3 rounded-xl font-black text-xs">å–æ¶ˆ</button></div></div></div></div>
</div>

<script>
const { createApp, reactive, computed, onMounted, ref, watch, nextTick } = Vue;

const API_URL = 'https://script.google.com/macros/s/AKfycbwG1iFU375TspCZ5q8ti2Ua08Pz8Llkq2yH1qZYtL-2nPr9Rs_b-Nf_ysFcASQSqXTr/exec'; 

createApp({
    setup() {
        const transactions = ref([]); const marketData = ref({}); const cashAdjustments = ref([]); const recommendations = ref([]);
        const navHistoryData = ref([]); const quantData = reactive({});
        const isSyncing = ref(false); const isScanningAll = ref(false); const isReorganizing = ref(false);
        
        const safeGetLocal = (key, defaultVal = '') => { try { return localStorage.getItem(key) || defaultVal; } catch(e) { return defaultVal; } };
        const safeSetLocal = (key, val) => { try { localStorage.setItem(key, val); } catch(e) {} };
        
        const password = ref(safeGetLocal('p_pass'));
        const form = reactive({ date: new Date().toISOString().split('T')[0], type: 'buy', symbol: '', price: '', shares: '' });
        const recForm = reactive({ symbol: '', type: 'New', price: '', count: 1, analysis: '' });
        const searchQuery = ref(''); const showCashModal = ref(false); const showAIModal = ref(false); 
        const aiLoading = ref(false); const selectedSymbol = ref(''); const aiContent = ref('');
        const cashForm = reactive({ date: new Date().toISOString().split('T')[0], amount: '', note: '' });
        const isGeneratingAnalysis = ref(false);
        const showCopilot = ref(false); const chatInput = ref(''); const chatHistory = ref([]); const isChatting = ref(false);

        const currentTab = ref('å…¨å±€');
        const sectorNews = ref([]);
        const isFetchingNews = ref(false);

        // ğŸŸ¢ æ ¸å¿ƒæ•¸æ“šåº«ï¼šæ¥æ”¶å¾Œç«¯ AI çš„åˆ†é¡èˆ‡å°æ¨™
        const aiSectorMap = ref({});
        const dynamicBenchmarks = ref({});

        const getSectorSymbols = (sectorName) => {
            return (dynamicBenchmarks.value[sectorName] && dynamicBenchmarks.value[sectorName].symbols) ? dynamicBenchmarks.value[sectorName].symbols : [];
        };
        const getSectorInfo = (sectorName) => { 
            return (dynamicBenchmarks.value[sectorName] && dynamicBenchmarks.value[sectorName].desc) ? { desc: dynamicBenchmarks.value[sectorName].desc } : { desc: 'ç­‰å¾… AI æƒæå°æ¨™è³‡è¨Š...' }; 
        };

        onMounted(() => { 
            const cached = safeGetLocal('app_cache');
            if (cached) {
                try {
                    const p = JSON.parse(cached);
                    transactions.value = p.transactions||[]; marketData.value = p.marketData||{}; cashAdjustments.value = p.cashAdjustments||[]; recommendations.value = p.recommendations||[]; navHistoryData.value = p.navHistory||[];
                    if (p.quantData) Object.assign(quantData, p.quantData); 
                    if (p.aiSectorMap) aiSectorMap.value = p.aiSectorMap;
                    if (p.dynamicBenchmarks) dynamicBenchmarks.value = p.dynamicBenchmarks; 
                } catch(e) {}
            }
            if (password.value) fetchData(false); 
            if(safeGetLocal('theme') === 'dark') document.documentElement.classList.add('dark');
        });

        // ğŸŸ¢ è§¸ç™¼ AI æ™ºèƒ½é‡çµ„
        const runAutoSectorMap = async () => {
            if (!checkPassword()) return;
            if (!confirm('å°‡å‹•ç”¨ AI é‡æ–°æƒæä¸¦å®šç¾©æ‚¨ç›®å‰æŒå€‰çš„è¡Œæ¥­æ¿å¡Šèˆ‡åŸºæº–å°æ¨™ã€‚\n(å¤§ç´„éœ€è¦ 10~20 ç§’ï¼Œè«‹ç¨å€™)')) return;
            
            isReorganizing.value = true;
            try {
                const res = await fetch(`${API_URL}?action=auto_sector_map&password=${encodeURIComponent(password.value)}`);
                const data = await res.json();
                if (data.status === 'error') throw new Error(data.message);
                alert(data.message);
                await fetchData(false); // é‡æ•´å¾Œé‡æ–°è¼‰å…¥æ–°è³‡æ–™
            } catch (e) {
                alert(`AI é‡çµ„å¤±æ•—: ${e.message}`);
            } finally {
                isReorganizing.value = false;
            }
        };

        const renderTVWidgets = () => {
            const symbols = getSectorSymbols(currentTab.value);
            const isDark = document.documentElement.classList.contains('dark');
            symbols.forEach((sym, i) => {
                const container = document.getElementById(`tv-widget-${i}`);
                if(container) {
                    container.innerHTML = '';
                    if(!sym) return; // å¦‚æœæ²’æœ‰å°æ¨™å‰‡ä¸ç•«
                    const script = document.createElement('script');
                    script.src = "https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js";
                    script.async = true;
                    script.innerHTML = JSON.stringify({ "symbol": sym, "width": "100%", "height": "100%", "locale": "tw", "dateRange": "3M", "colorTheme": isDark ? "dark" : "light", "isTransparent": true, "autosize": true, "largeChartUrl": "" });
                    container.appendChild(script);
                }
            });
        };

        const toggleDarkMode = () => { document.documentElement.classList.toggle('dark'); safeSetLocal('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); renderChart(); if(currentTab.value !== 'å…¨å±€') setTimeout(renderTVWidgets, 50); };
        const checkPassword = () => { if (!password.value) { const p = prompt('è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼:'); if (p) { password.value = p; safeSetLocal('p_pass', p); return true; } return false; } return true; };

        const fetchData = async (forceAlert = false) => {
            if (!checkPassword()) return;
            isSyncing.value = true;
            try {
                const res = await fetch(`${API_URL}?action=read&password=${encodeURIComponent(password.value)}`);
                const data = await res.json();
                if (data.status === 'error') throw new Error(data.message);
                transactions.value = data.transactions || []; marketData.value = data.marketData || {}; cashAdjustments.value = data.cashAdjustments || []; navHistoryData.value = data.navHistory || []; recommendations.value = (data.recommendations || []).map(r=>({...r, showDetails:false}));
                if (data.quantData) { Object.keys(quantData).forEach(k => delete quantData[k]); Object.assign(quantData, data.quantData); }
                
                if (data.dynamicBenchmarks) dynamicBenchmarks.value = data.dynamicBenchmarks;
                if (data.aiSectorMap) aiSectorMap.value = data.aiSectorMap;

                safeSetLocal('app_cache', JSON.stringify({transactions: transactions.value, marketData: marketData.value, cashAdjustments: cashAdjustments.value, recommendations: recommendations.value, navHistory: navHistoryData.value, quantData: quantData, dynamicBenchmarks: dynamicBenchmarks.value, aiSectorMap: aiSectorMap.value}));
            } catch (e) { if(forceAlert) alert(`åŒæ­¥å¤±æ•—: ${e.message}`); } finally { isSyncing.value = false; }
        };

        const saveData = async () => {
            if (!checkPassword()) return;
            if (!confirm('ç¢ºèªå„²å­˜ä¸¦è¨˜éŒ„ç•¶å‰æ·¨å€¼å—ï¼Ÿ\n(æ‚¨çš„é‡åŒ–æƒæçµæœä¹Ÿå°‡åŒæ­¥å‚™ä»½è‡³é›²ç«¯)')) return;
            try {
                const cleanRecs = recommendations.value.map(({showDetails, ...rest}) => rest);
                const payload = { transactions: transactions.value, cashAdjustments: cashAdjustments.value, recommendations: cleanRecs, currentNav: dashboard.value.totalNav, quantData: quantData };
                const res = await fetch(`${API_URL}?action=save&password=${encodeURIComponent(password.value)}`, { method: 'POST', body: JSON.stringify(payload) });
                const d = await res.json();
                if(d.status === 'error') throw new Error(d.message);
                alert('å„²å­˜èˆ‡æ·¨å€¼å¿«ç…§è¨˜éŒ„æˆåŠŸï¼'); fetchData(false);
            } catch(e) { alert(`å„²å­˜å¤±æ•—: ${e.message}`); }
        };

        // ğŸŸ¢ å¾¹åº•ç°¡åŒ–çš„è§£æé‚è¼¯ï¼šå…¨é  AI çµ¦çš„å­—å…¸
        const parsedTransactions = computed(() => {
            return (transactions.value || []).map(t => {
                let cleanSymbol = (t.symbol || '').toUpperCase(); let sector = 'ğŸ“ æœªåˆ†é¡';
                
                // å¦‚æœæ‚¨ä¾ç„¶æœ‰ä½¿ç”¨ "æ¨™ç±¤:ä»£è™Ÿ" çš„ç¿’æ…£ï¼Œä¿ç•™è¦†è“‹æ¬Š
                if (cleanSymbol.includes(':')) { 
                    const parts = cleanSymbol.split(':'); sector = parts[0].trim(); cleanSymbol = parts[1].trim(); 
                } else if (aiSectorMap.value[cleanSymbol]) { 
                    sector = aiSectorMap.value[cleanSymbol]; 
                }
                return { ...t, cleanSymbol, sector };
            });
        });

        const dashboard = computed(() => {
            let cash = 0, holdings = {}, investedAmount = 0, totalRealized = 0, totalUnrealized = 0, totalDividend = 0;
            (cashAdjustments.value || []).forEach(a => cash += Number(a.amount));
            [...parsedTransactions.value].sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(t => {
                const sym = t.cleanSymbol;
                if(!holdings[sym]) holdings[sym] = {symbol: sym, sector: t.sector, shares:0, totalCost:0, avgCost:0, currentPrice:0, dayChange:0, yieldPct:0, unrealizedPnL:0};
                const amt = Number(t.price) * Number(t.shares);
                if ((t.type || '').toLowerCase() === 'buy') { cash -= amt; holdings[sym].totalCost += amt; holdings[sym].shares += Number(t.shares); holdings[sym].sector = t.sector; } 
                else { cash += amt; const c = holdings[sym].avgCost * Number(t.shares); totalRealized += (amt - c); holdings[sym].totalCost -= c; holdings[sym].shares -= Number(t.shares); }
                if(holdings[sym].shares > 0) holdings[sym].avgCost = holdings[sym].totalCost / holdings[sym].shares;
            });
            for(let s in holdings) {
                if(holdings[s].shares > 0) {
                    investedAmount += holdings[s].totalCost; holdings[s].currentPrice = (marketData.value || {})[s]?.price || 0; holdings[s].dayChange = (marketData.value || {})[s]?.change || 0; holdings[s].yieldPct = (marketData.value || {})[s]?.yield || 0; 
                    holdings[s].unrealizedPnL = (holdings[s].currentPrice * holdings[s].shares) - holdings[s].totalCost;
                    holdings[s].unrealizedPnLPercent = holdings[s].totalCost > 0 ? ((holdings[s].unrealizedPnL / holdings[s].totalCost) * 100).toFixed(2) : 0;
                    totalUnrealized += holdings[s].unrealizedPnL; totalDividend += (holdings[s].shares * holdings[s].currentPrice * (holdings[s].yieldPct / 100)); 
                }
            }
            return { cash, holdings, investedAmount, totalRealized, totalUnrealized, totalDividend, totalNav: cash + investedAmount + totalUnrealized };
        });

        const sectorList = computed(() => {
            if (!dashboard.value || !dashboard.value.holdings) return [];
            const sectors = {};
            Object.values(dashboard.value.holdings).forEach(h => { if (h.shares > 0) sectors[h.sector] = (sectors[h.sector] || 0) + 1; });
            return Object.keys(sectors).map(name => ({ name, count: sectors[name] })).sort((a, b) => {
                if(a.name.includes('æœªåˆ†é¡')) return 1; if(b.name.includes('æœªåˆ†é¡')) return -1;
                return b.count - a.count;
            });
        });

        const filteredHoldings = computed(() => {
            if (!dashboard.value || !dashboard.value.holdings) return [];
            const allHoldings = Object.values(dashboard.value.holdings).filter(h => h.shares > 0);
            if (currentTab.value === 'å…¨å±€') return allHoldings;
            return allHoldings.filter(h => h.sector === currentTab.value);
        });

        const currentSectorStats = computed(() => {
            if (currentTab.value === 'å…¨å±€' || !filteredHoldings.value) return { totalValue: 0, weightPercent: 0, avgNarrative: 0, avgShortage: 0 };
            let totalValue = 0; let totalNarrative = 0; let totalShortage = 0; let countWithData = 0;
            filteredHoldings.value.forEach(h => {
                const val = h.shares * h.currentPrice; totalValue += val;
                if (quantData && quantData[h.symbol]) { totalNarrative += Number(quantData[h.symbol].narrative_score || 0); totalShortage += Number(quantData[h.symbol].shortage_momentum || 0); countWithData++; }
            });
            const weightPercent = (dashboard.value && dashboard.value.totalNav > 0) ? ((totalValue / dashboard.value.totalNav) * 100).toFixed(1) : 0;
            const avgNarrative = countWithData > 0 ? Math.round(totalNarrative / countWithData) : 0;
            const avgShortage = countWithData > 0 ? Math.round(totalShortage / countWithData) : 0;
            return { totalValue, weightPercent, avgNarrative, avgShortage };
        });

        watch(currentTab, async (newTab) => {
            if (newTab === 'å…¨å±€') { sectorNews.value = []; return; }
            nextTick(renderTVWidgets);

            sectorNews.value = []; isFetchingNews.value = true;
            const topSymbols = [...filteredHoldings.value].sort((a,b) => (b.shares*b.currentPrice) - (a.shares*a.currentPrice)).slice(0, 3).map(h => h.symbol);
            try {
                for (const sym of topSymbols) {
                    const rssUrl = encodeURIComponent(`https://news.google.com/rss/search?q=${sym}+stock+news&hl=en-US&gl=US&ceid=US:en`);
                    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${rssUrl}`);
                    const data = await res.json();
                    if (data.status === 'ok' && data.items) {
                        data.items.slice(0, 2).forEach(item => { sectorNews.value.push({ symbol: sym, title: item.title, link: item.link, pubDate: item.pubDate }); });
                    }
                }
                sectorNews.value.sort((a,b) => new Date(b.pubDate) - new Date(a.pubDate));
            } catch(e) {} finally { isFetchingNews.value = false; }
        });

        const scanAllQuantRisk = async () => {
            const now = Date.now(); let history = [];
            try { history = JSON.parse(safeGetLocal('quant_scan_history', '[]')); } catch(e){}
            history = history.filter(time => now - time < 86400000);
            if (history.length >= 3) { alert("â›” é »ç‡é™åˆ¶ï¼šæ‚¨åœ¨éå» 24 å°æ™‚å…§å·²é” 3 æ¬¡æƒæä¸Šé™ã€‚"); return; }
            if (history.length > 0) { const timeSinceLast = now - Math.max(...history); const sixHours = 6 * 60 * 60 * 1000; if (timeSinceLast < sixHours) { alert(`â›” å†·å»é™åˆ¶ï¼šè·é›¢ä¸‹æ¬¡å¯ç”¨æƒæé‚„éœ€ç­‰å¾…ç´„ ${((sixHours - timeSinceLast) / 3600000).toFixed(1)} å°æ™‚ã€‚`); return; } }
            if (!checkPassword()) return;

            isScanningAll.value = true;
            const symbols = Object.keys(dashboard.value.holdings).filter(s => dashboard.value.holdings[s].shares > 0);
            symbols.forEach(sym => { quantData[sym] = { catalyst_prob: 0, narrative_score: 0, shortage_momentum: 0, mispricing_gap: 0, atr_percent: '...', action_zone: 'â³ æº–å‚™æ’éšŠæƒæ...' }; });

            const chunkSize = 1; let hasError = false;
            for (let i = 0; i < symbols.length; i += chunkSize) {
                const chunk = symbols.slice(i, i + chunkSize);
                chunk.forEach(sym => { quantData[sym].action_zone = 'ğŸš€ è™›æ“¬å§”å“¡æœƒè¾¯è«–ä¸­...'; });
                try {
                    const r = await fetch(`${API_URL}?action=quant_scan_all&symbols=${encodeURIComponent(JSON.stringify(chunk))}&password=${encodeURIComponent(password.value)}`);
                    const d = await r.json();
                    if (d.status === 'success') { Object.keys(d.data).forEach(sym => { quantData[sym] = d.data[sym]; }); } else { throw new Error(d.message); }
                } catch(e) { chunk.forEach(sym => { quantData[sym].action_zone = 'âš ï¸ é€£ç·šä¸­æ–·'; }); hasError = true; }
            }
            
            isScanningAll.value = false;
            if (!hasError) { 
                history.push(Date.now()); safeSetLocal('quant_scan_history', JSON.stringify(history));
                safeSetLocal('app_cache', JSON.stringify({transactions: transactions.value, marketData: marketData.value, cashAdjustments: cashAdjustments.value, recommendations: recommendations.value, navHistory: navHistoryData.value, quantData: quantData, dynamicBenchmarks: dynamicBenchmarks.value, aiSectorMap: aiSectorMap.value}));
                alert("âœ… æƒæå®Œæˆï¼è¨˜å¾—é»æ“Šã€Œå„²å­˜æ·¨å€¼ã€å‚™ä»½ã€‚"); 
            } else { alert("âš ï¸ éƒ¨åˆ†æƒæéŒ¯èª¤ã€‚"); }
        };

        const sendChat = async () => {
            if(!chatInput.value.trim() || isChatting.value) return;
            const text = chatInput.value; chatHistory.value.push({ role: 'user', text }); chatInput.value = ''; isChatting.value = true;
            nextTick(() => { const b = document.getElementById('chat-box'); b.scrollTop = b.scrollHeight; });
            let pStr = `ç¾é‡‘: $${dashboard.value.cash.toFixed(0)}\næŒå€‰: `;
            Object.keys(dashboard.value.holdings).forEach(s => { if(dashboard.value.holdings[s].shares > 0) pStr += `${s}(${dashboard.value.holdings[s].shares}è‚¡), `; });
            try {
                const r = await fetch(`${API_URL}?action=copilot&msg=${encodeURIComponent(text)}&context=${encodeURIComponent(pStr)}&password=${encodeURIComponent(password.value)}`);
                const d = await r.json(); chatHistory.value.push({ role: 'ai', text: d.reply });
            } catch(e) { chatHistory.value.push({ role: 'ai', text: 'é€£ç·šä¸­æ–·ï¼Œè«‹é‡è©¦ã€‚' }); }
            finally { isChatting.value = false; nextTick(() => { const b = document.getElementById('chat-box'); b.scrollTop = b.scrollHeight; }); }
        };

        const reviewPortfolio = async () => { selectedSymbol.value = "Portfolio Review"; showAIModal.value = true; aiLoading.value = true; aiContent.value = ''; let pStr = `ç¸½è³‡é‡‘: $${dashboard.value.totalNav.toFixed(0)}\n`; Object.keys(dashboard.value.holdings).forEach(s => { const h = dashboard.value.holdings[s]; if(h.shares > 0) pStr += `- ${s}: ä½”æ¯” ${((h.shares*h.currentPrice)/dashboard.value.totalNav*100).toFixed(1)}%\n`; }); try { const r = await fetch(`${API_URL}?action=review_portfolio&portfolio=${encodeURIComponent(pStr)}&password=${encodeURIComponent(password.value)}`); const d = await r.json(); aiContent.value = d.analysis; } catch(e) { aiContent.value = `âŒ å¥æª¢å¤±æ•—: ${e.message}`; } finally { aiLoading.value = false; } };
        const runStressTest = async () => { 
            if (!checkPassword()) return;
            selectedSymbol.value = "Stress Test / VaR"; showAIModal.value = true; aiLoading.value = true; aiContent.value = ''; 
            let pStr = `ç¸½è³‡ç”¢: $${dashboard.value.totalNav.toFixed(0)} (ç¾é‡‘: $${dashboard.value.cash.toFixed(0)})\n`; 
            Object.keys(dashboard.value.holdings).forEach(s => { const h = dashboard.value.holdings[s]; if(h.shares > 0) pStr += `- ${s}: ${h.shares}è‚¡, ç¾å€¼ $${(h.shares*h.currentPrice).toFixed(0)}, ä½”æ¯” ${((h.shares*h.currentPrice)/dashboard.value.totalNav*100).toFixed(1)}%\n`; }); 
            try { const r = await fetch(`${API_URL}?action=stress_test&portfolio=${encodeURIComponent(pStr)}&password=${encodeURIComponent(password.value)}`); const d = await r.json(); aiContent.value = d.analysis; } catch(e) { aiContent.value = `âŒ æ¸¬è©¦å¤±æ•—: ${e.message}`; } finally { aiLoading.value = false; } 
        };
        const openAIModal = async (s) => { selectedSymbol.value = s; showAIModal.value = true; aiLoading.value = true; aiContent.value = ''; try { const r = await fetch(`${API_URL}?action=analyze&symbol=${encodeURIComponent(s)}&password=${encodeURIComponent(password.value)}`); const d = await r.json(); aiContent.value = d.analysis; } catch(e) { aiContent.value = `âŒ è®€å–å¤±æ•—: ${e.message}`; } finally { aiLoading.value = false; } };
        const generateAnalysis = async () => { if (!recForm.symbol) return alert('è«‹å…ˆè¼¸å…¥ä»£è™Ÿï¼'); if (!checkPassword()) return; isGeneratingAnalysis.value = true; try { const r = await fetch(`${API_URL}?action=analyze&symbol=${encodeURIComponent(recForm.symbol)}&password=${encodeURIComponent(password.value)}`); const d = await r.json(); recForm.analysis = d.analysis; } catch(e) { alert(`AI ç”Ÿæˆå¤±æ•—`); } finally { isGeneratingAnalysis.value = false; } };

        let pieChart = null; let lineChart = null;
        const renderChart = () => {
            if (currentTab.value !== 'å…¨å±€') return;
            setTimeout(() => {
                const isDark = document.documentElement.classList.contains('dark'); const txtColor = isDark ? '#cbd5e1' : '#64748b';
                const ctxPie = document.getElementById('allocationChart'); 
                if(ctxPie && dashboard.value && dashboard.value.holdings) {
                    if(pieChart) pieChart.destroy();
                    const validHoldings = Object.entries(dashboard.value.holdings).filter(([k, v]) => v.shares > 0);
                    if(validHoldings.length > 0) { pieChart = new Chart(ctxPie, { type: 'doughnut', data: { labels: validHoldings.map(h => h[0]), datasets: [{ data: validHoldings.map(h => h[1].totalCost), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#f43f5e', '#14b8a6'], borderWidth: isDark? 0 : 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '75%' } }); }
                }
                const ctxLine = document.getElementById('navChart');
                if(ctxLine && navHistoryData.value && navHistoryData.value.length > 0) {
                    if(lineChart) lineChart.destroy();
                    const history = [...navHistoryData.value].sort((a,b) => new Date(a.date) - new Date(b.date));
                    lineChart = new Chart(ctxLine, { type: 'line', data: { labels: history.map(h => h.date.substring(5)), datasets: [{ label: 'NAV', data: history.map(h => h.nav), borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', borderWidth: 3, fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: txtColor } }, y: { ticks: { color: txtColor } } } } });
                }
            }, 50);
        };
        watch(() => [dashboard.value?.holdings, navHistoryData.value, currentTab.value], renderChart, { deep: true });

        const addTransaction = () => { if(!form.symbol) return; transactions.value.push({id:Date.now(), ...form, symbol: form.symbol.toUpperCase()}); form.symbol=''; form.price=''; form.shares=''; };
        const removeTransaction = (id) => { if(confirm('åˆªé™¤äº¤æ˜“ï¼Ÿ')) transactions.value = transactions.value.filter(t=>t.id!==id); };
        const addCashAdjustment = () => { if(!cashForm.amount) return; cashAdjustments.value.push({id:Date.now(), ...cashForm}); showCashModal.value=false; cashForm.amount=''; cashForm.note=''; };
        const addRecommendation = () => { if(!recForm.symbol) return; const newRec = { id:Date.now(), date:new Date().toISOString().split('T')[0], symbol:recForm.symbol.toUpperCase(), type:recForm.type, price:recForm.price, count:recForm.count, analysis:recForm.analysis }; recommendations.value.push({...newRec, showDetails:false}); recForm.symbol=''; recForm.analysis=''; recForm.count=1; };
        const removeRecommendation = (id) => { if(confirm('åˆªé™¤å…¬å‘Šï¼Ÿ')) recommendations.value = recommendations.value.filter(r=>r.id!==id); };
        const formatCurrency = (v, d=0) => (v||0).toLocaleString('en-US', {minimumFractionDigits:d, maximumFractionDigits:d});
        const getRecTypeLabel = (type) => { const map = { 'Buy': 'è²·å…¥', 'Sell': 'è³£å‡º', 'New': 'å»ºå€‰', 'Add': 'åŠ ç¢¼', 'Reduce': 'æ¸›ç¢¼', 'Clear': 'æ¸…å€‰' }; return map[type] || type; };
        const getRecTypeClass = (type) => { const map = { 'Buy': 'text-green-500', 'Sell': 'text-red-500', 'New': 'text-blue-500 dark:text-blue-400', 'Add': 'text-green-500', 'Reduce': 'text-red-500', 'Clear': 'text-amber-500' }; return map[type] || 'text-slate-500'; };

        const sortedTransactions = computed(() => {
            const h = {};
            return [...(transactions.value || [])].sort((a,b)=>new Date(a.date)-new Date(b.date)).map(t => {
                const sym = (t.symbol || '').toUpperCase(); if(!h[sym]) h[sym] = {s:0, c:0, avg:0};
                let pnl = 0; 
                if((t.type || '').toLowerCase()==='buy'){ h[sym].c += Number(t.price)*Number(t.shares); h[sym].s += Number(t.shares); h[sym].avg = h[sym].c/h[sym].s; } 
                else { pnl = (Number(t.price) - h[sym].avg)*Number(t.shares); h[sym].c -= h[sym].avg*Number(t.shares); h[sym].s -= Number(t.shares); }
                return {...t, realizedPnL: pnl};
            }).reverse();
        });
        const filteredTransactions = computed(() => { if(!searchQuery.value) return sortedTransactions.value; return sortedTransactions.value.filter(t => (t.symbol || '').includes(searchQuery.value.toUpperCase())); });
        const monthlyStats = computed(() => { const s = {}; sortedTransactions.value.forEach(t => { if((t.type || '').toLowerCase()==='sell' && t.realizedPnL) { const m = t.date.substring(0,7); s[m] = (s[m]||0) + t.realizedPnL; } }); return Object.keys(s).sort().reverse().map(m => ({ month: m, pnl: s[m] })); });

        return { 
            dashboard, form, cashForm, recForm, transactions, cashAdjustments, recommendations, sortedTransactions, filteredTransactions, searchQuery, monthlyStats, quantData,
            sortedCash: computed(()=>[...cashAdjustments.value].reverse()), sortedRecommendations: computed(()=>[...recommendations.value].reverse()), 
            fetchData, saveData, toggleDarkMode, reviewPortfolio, runStressTest, openAIModal, generateAnalysis, addRecommendation, addTransaction, removeTransaction, addCashAdjustment, removeRecommendation, 
            scanAllQuantRisk, isScanningAll, isGeneratingAnalysis, showAIModal, showCashModal, aiLoading, aiContent, selectedSymbol, formatCurrency, isSyncing, marked, getRecTypeLabel, getRecTypeClass,
            showCopilot, chatInput, chatHistory, sendChat, isChatting, currentTab, sectorList, filteredHoldings, currentSectorStats, getSectorInfo, sectorNews, isFetchingNews, dynamicBenchmarks, aiSectorMap, runAutoSectorMap, isReorganizing 
        };
    }
}).mount('#app');
</script>
</body>
</html>
