<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ç¾è‚¡AIå»ºè­°">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2534/2534433.png">

    <title>ç¾è‚¡ AI æŠ•è³‡å»ºè­°</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    
    <style>
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f1f5f9;
            margin: 0;
            overscroll-behavior-y: none; /* é˜²æ­¢æ‰‹æ©Ÿç€è¦½å™¨æ©¡çš®ç­‹å›å½ˆ */
        }

        /* é ‚éƒ¨å°èˆªåˆ—ï¼šé©æ‡‰æ‰‹æ©ŸåŠ‰æµ· */
        .app-header {
            padding-top: calc(var(--safe-top) + 1rem);
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        /* å…§å®¹å®¹å™¨ï¼šé›»è…¦ç‰ˆå±…ä¸­ï¼Œæ‰‹æ©Ÿç‰ˆæ»¿ç‰ˆ */
        .app-container {
            max-width: 600px; /* é›»è…¦ç‰ˆå¯¬åº¦é™åˆ¶ï¼Œç¶­æŒ App æ„Ÿ */
            margin: 0 auto;
            min-height: 100vh;
            background-color: #f8fafc;
            box-shadow: 0 0 50px rgba(0,0,0,0.05);
        }

        /* éš±è—æ²è»¸ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* æŒ‰éˆ•è§¸æ§æ•ˆæœ */
        .btn-tap:active { transform: scale(0.97); opacity: 0.9; }

        /* Markdown æ’ç‰ˆå„ªåŒ– */
        .markdown-content p { margin-bottom: 0.75rem; }
        .markdown-content ul { list-style-type: disc; padding-left: 1.25rem; margin-bottom: 0.75rem; }
    </style>
</head>
<body class="no-scrollbar">

    <div class="app-container flex flex-col">
        
        <header class="app-header px-6 pb-6 text-white shrink-0">
            <div class="flex justify-between items-end">
                <div>
                    <h1 id="app-display-name" class="text-2xl font-black tracking-tight">ç¾è‚¡ AI æŠ•è³‡å»ºè­°</h1>
                    <p class="text-slate-400 text-[10px] mt-1 font-bold flex items-center gap-1 uppercase tracking-wider">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        Real-time Gemini Analysis
                    </p>
                </div>
                <div class="text-right">
                    <span class="text-[10px] bg-blue-500/20 text-blue-400 px-2 py-1 rounded-lg border border-blue-500/30 font-black">LIVE</span>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto px-4 py-6 space-y-6" style="padding-bottom: calc(var(--safe-bottom) + 2rem);">
            
            <section>
                <h2 class="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3 ml-1">ç•¶å‰æŒæœ‰æ¨™çš„</h2>
                <div id="holdings-container" class="flex flex-wrap gap-2">
                    <div class="w-full py-6 text-center text-slate-300 animate-pulse italic">åŒæ­¥é›²ç«¯æ•¸æ“šä¸­...</div>
                </div>
            </section>

            <section>
                <div class="flex justify-between items-center mb-3 ml-1">
                    <h2 class="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em]">ğŸ“¢ æœ€æ–°æ“ä½œå»ºè­°</h2>
                    <span class="text-[9px] font-bold text-slate-300 bg-slate-100 px-2 py-0.5 rounded">è¿‘ 7 æ—¥</span>
                </div>
                <div id="rec-list" class="space-y-4">
                    </div>
            </section>

            <footer class="pt-10 pb-4 text-center">
                <div class="w-12 h-1 bg-slate-200 mx-auto rounded-full mb-4"></div>
                <p class="text-[10px] font-bold text-slate-300 uppercase tracking-widest">Powered by Gemini 1.5 Pro</p>
                <p class="text-[9px] text-slate-200 mt-1">Smart Investment Terminal</p>
            </footer>
        </main>
    </div>

<script>
(function() {
    // ============================================================
    // ğŸ”´ è«‹å¡«å…¥æ‚¨çš„ Apps Script ç¶²å€
    // ============================================================
    const API_URL = 'https://script.google.com/macros/s/AKfycbyXBfSISMPrZtiSt24Wsao-9V7bN5SZ_FjENs48tRiOixqzgxrac0tMa1n9F-Ril6ad/exec'; 
    const PAGE_TITLE = 'ç¾è‚¡ AI æŠ•è³‡å»ºè­°';
    // ============================================================

    const DAYS_LIMIT = 7;
    document.getElementById('app-display-name').innerText = PAGE_TITLE;
    document.title = PAGE_TITLE;

    fetch(API_URL + '?action=public_board')
        .then(res => res.json())
        .then(json => {
            // 1. æ¸²æŸ“æŒå€‰ (iOS åœ“è§’æŒ‰éˆ•é¢¨æ ¼)
            const holdingsBox = document.getElementById('holdings-container');
            if (json.holdings && json.holdings.length > 0) {
                holdingsBox.innerHTML = json.holdings.map(sym => `
                    <a href="https://www.google.com/finance/quote/${sym}:NASDAQ" target="_blank" 
                       class="btn-tap no-underline bg-white text-blue-600 border border-slate-100 px-4 py-2.5 rounded-2xl text-sm font-black shadow-sm flex items-center gap-1 transition-all active:bg-slate-50">
                       ${sym} <span class="text-[10px] opacity-20">â†—</span>
                    </a>
                `).join('');
            } else {
                holdingsBox.innerHTML = '<div class="w-full py-8 text-center text-slate-300 text-sm bg-white rounded-3xl border border-dashed italic">ç›®å‰å¸³æˆ¶ç„¡æŒå€‰æ¨™çš„</div>';
            }

            // 2. æ¸²æŸ“å»ºè­°åˆ—è¡¨ (iOS Card é¢¨æ ¼)
            const list = document.getElementById('rec-list');
            if (!json.data || json.data.length === 0) { renderEmpty(list, "æš«ç„¡å…¬é–‹å»ºè­°"); return; }

            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - DAYS_LIMIT);
            cutoff.setHours(0, 0, 0, 0);

            const validData = json.data
                .filter(item => new Date(item.date) >= cutoff)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (validData.length === 0) { renderEmpty(list, `è¿‘ ${DAYS_LIMIT} æ—¥ç„¡æ–°å»ºè­°`); return; }
            
            list.innerHTML = validData.map((item, index) => {
                const isBuy = item.type === 'Buy';
                const color = isBuy ? 'text-green-600' : 'text-red-600';
                const bg = isBuy ? 'bg-green-50' : 'bg-red-50';
                const formattedPrice = item.price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const uniqueId = `analysis-v16-${index}`;

                return `
                <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-50">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-slate-900 text-white flex items-center justify-center font-black text-lg shadow-lg shadow-slate-200">
                                ${item.symbol.substring(0,1)}
                            </div>
                            <div>
                                <h3 class="font-black text-xl text-slate-800 leading-tight">${item.symbol}</h3>
                                <p class="text-[11px] text-slate-400 font-bold uppercase tracking-tighter">${item.date}</p>
                            </div>
                        </div>
                        <div class="${bg} ${color} px-4 py-1.5 rounded-full text-[11px] font-black uppercase tracking-widest border border-current opacity-80">
                            ${isBuy ? 'è²·å…¥ Buy' : 'è³£å‡º Sell'}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 bg-slate-50 rounded-[1.5rem] p-4">
                        <div>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-tighter mb-1">å»ºè­°åƒ¹æ ¼</p>
                            <p class="text-xl font-black text-slate-700 leading-none">$${formattedPrice}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-tighter mb-1">AI åˆ†ææ•¸</p>
                            <p class="text-xl font-black text-orange-500 leading-none">${item.count} æ¬¡</p>
                        </div>
                    </div>

                    ${item.analysis ? `
                    <div class="mt-5">
                        <button onclick="toggleCard('${uniqueId}', this)" class="btn-tap w-full py-3 bg-slate-100 text-slate-600 rounded-2xl text-[11px] font-black uppercase tracking-widest flex items-center justify-center gap-2 transition-all">
                            <span>æŸ¥çœ‹ AI è§€é»è§£è®€</span> <span class="text-lg leading-none">+</span>
                        </button>
                        <div id="${uniqueId}" class="hidden mt-4 p-5 bg-white rounded-2xl text-[13px] text-slate-600 leading-relaxed markdown-content text-justify border border-slate-100 shadow-inner">
                            ${marked.parse(item.analysis)}
                        </div>
                    </div>` : ''}
                </div>`;
            }).join('');
        })
        .catch(err => {
            renderEmpty(document.getElementById('rec-list'), "ç¶²è·¯åŒæ­¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        });

    function renderEmpty(element, message) {
        element.innerHTML = `<div class="py-16 text-center text-slate-300 text-sm font-bold bg-white rounded-[2rem] border-2 border-dashed border-slate-100">${message}</div>`;
    }
})();

// å…¨åŸŸå¡ç‰‡åˆ‡æ›
function toggleCard(id, btn) {
    const el = document.getElementById(id);
    const isHidden = el.classList.contains('hidden');
    
    if(isHidden) {
        el.classList.remove('hidden');
        btn.querySelector('span:first-child').innerText = 'æ”¶èµ·å…§å®¹æ‘˜è¦';
        btn.querySelector('span:last-child').innerText = 'âˆ’';
        btn.classList.replace('bg-slate-100', 'bg-blue-600');
        btn.classList.replace('text-slate-600', 'text-white');
    } else {
        el.classList.add('hidden');
        btn.querySelector('span:first-child').innerText = 'æŸ¥çœ‹ AI è§€é»è§£è®€';
        btn.querySelector('span:last-child').innerText = '+';
        btn.classList.replace('bg-blue-600', 'bg-slate-100');
        btn.classList.replace('text-white', 'text-slate-600');
    }
}
</script>
</body>
</html>
