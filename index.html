<!DOCTYPE html>
<html lang="zh-TW" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç¾è‚¡ç®¡ç†çµ‚ç«¯ Pro Max</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s ease; }
        .text-up { color: #10b981; } .text-down { color: #ef4444; } 
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        button:active { transform: scale(0.97); opacity: 0.8; }
        @media (min-width: 1024px) { .app-container { max-width: 1300px; margin: 0 auto; } }

        .markdown-content { font-size: 14px; line-height: 1.7; }
        .markdown-content p { margin-bottom: 12px; }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { font-weight: 900; margin-top: 16px; margin-bottom: 8px; color: #0f172a; }
        .dark .markdown-content h1, .dark .markdown-content h2, .dark .markdown-content h3 { color: #f8fafc; }
        .markdown-content ul { list-style-type: disc; padding-left: 20px; margin-bottom: 12px; }
        .markdown-content strong { font-weight: 900; color: #1e293b; background: rgba(59, 130, 246, 0.1); padding: 0 4px; border-radius: 4px; }
        .dark .markdown-content strong { color: #93c5fd; background: rgba(59, 130, 246, 0.2); }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 p-3 md:p-8">
<div id="app" class="app-container pb-24">
    
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 px-1">
        <div>
            <h1 class="text-2xl font-black tracking-tight flex items-center gap-2">
                Quantum Terminal <span class="text-[10px] bg-indigo-600 text-white px-2 py-0.5 rounded font-bold">v3.3</span>
            </h1>
            <p v-if="isSyncing" class="text-blue-500 text-xs mt-1 animate-pulse font-bold tracking-widest uppercase">ğŸ”„ Syncing Backend...</p>
            <p v-else class="text-green-500 dark:text-green-400 text-xs mt-1 font-bold tracking-widest uppercase">âœ“ System Online</p>
        </div>
        <div class="flex w-full md:w-auto gap-2 flex-wrap">
            <button @click="reviewPortfolio" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl text-sm font-black shadow-lg shadow-purple-500/30 flex items-center gap-1"><span class="text-lg">ğŸ§ </span> AI å…¨å±€çµ„åˆå¥æª¢</button>
            <button @click="toggleDarkMode" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 rounded-xl text-sm font-bold shadow-sm">ğŸŒ“</button>
            <button @click="fetchData(true)" class="flex-1 md:flex-none px-4 py-2 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl shadow-sm text-sm font-bold">ğŸ”„ åŒæ­¥</button>
            <button @click="saveData" class="flex-1 md:flex-none px-4 py-2 bg-slate-900 dark:bg-black text-white rounded-xl shadow-lg text-sm font-bold">ğŸ’¾ ç´€éŒ„æ·¨å€¼èˆ‡å„²å­˜</button>
        </div>
    </header>

    <div class="grid grid-cols-2 md:grid-cols-7 gap-3 mb-6">
        <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl border border-slate-100 dark:border-slate-700 shadow-sm">
            <p class="text-[10px] text-slate-400 font-black uppercase">å¯ç”¨ç¾é‡‘</p>
            <p class="text-lg md:text-xl font-black mt-1">${{ formatCurrency(dashboard.cash) }} <span @click="showCashModal=true" class="text-[10px] text-blue-500 cursor-pointer underline ml-1">èª¿ç¯€</span></p>
        </div>
        <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl border border-slate-100 dark:border-slate-700 shadow-sm">
            <p class="text-[10px] text-slate-400 font-black uppercase">æŒå€‰ç¸½æˆæœ¬</p>
            <p class="text-lg md:text-xl font-black mt-1">${{ formatCurrency(dashboard.investedAmount) }}</p>
        </div>
        
        <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl border border-slate-100 dark:border-slate-700 shadow-sm">
            <p class="text-[10px] text-slate-400 font-black uppercase">å·²å¯¦ç¾æç›Š</p>
            <p class="text-lg md:text-xl font-black mt-1" :class="dashboard.totalRealized >= 0 ? 'text-up' : 'text-down'">{{ dashboard.totalRealized >= 0 ? '+' : '' }}${{ formatCurrency(dashboard.totalRealized) }}</p>
        </div>

        <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl border border-slate-100 dark:border-slate-700 shadow-sm">
            <p class="text-[10px] text-slate-400 font-black uppercase">æœªå¯¦ç¾æç›Š</p>
            <p class="text-lg md:text-xl font-black mt-1" :class="dashboard.totalUnrealized >= 0 ? 'text-up' : 'text-down'">{{ dashboard.totalUnrealized >= 0 ? '+' : '' }}${{ formatCurrency(dashboard.totalUnrealized) }}</p>
        </div>
        <div class="bg-emerald-50 dark:bg-emerald-900/30 p-4 rounded-3xl border border-emerald-100 dark:border-emerald-800 shadow-sm">
            <p class="text-[10px] text-emerald-600 dark:text-emerald-400 font-black uppercase">é ä¼°å¹´é ˜è‚¡æ¯</p>
            <p class="text-lg md:text-xl font-black mt-1 text-emerald-700 dark:text-emerald-300">${{ formatCurrency(dashboard.totalDividend, 0) }}</p>
        </div>
        <div class="bg-slate-900 dark:bg-black p-4 rounded-3xl shadow-xl col-span-2 text-center md:text-left flex flex-col justify-center">
            <p class="text-[10px] text-slate-400 font-bold uppercase">ç¸½è³‡ç”¢æ·¨å€¼ (NAV)</p>
            <p class="text-2xl font-black text-white mt-1">${{ formatCurrency(dashboard.totalNav) }}</p>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white dark:bg-slate-800 p-5 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm">
            <h3 class="text-[11px] font-black uppercase text-slate-400 mb-2">è³‡ç”¢æ¿å¡Šé…ç½® (Allocation)</h3>
            <div class="relative w-full h-48"><canvas id="allocationChart"></canvas></div>
        </div>
        <div class="bg-white dark:bg-slate-800 p-5 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm">
            <h3 class="text-[11px] font-black uppercase text-slate-400 mb-2 flex justify-between">
                <span>ç¸½è³‡ç”¢èµ°å‹¢ (Equity Curve)</span>
                <span class="text-[9px] text-blue-500">é»æ“Šå„²å­˜è‡ªå‹•ç´€éŒ„å¿«ç…§</span>
            </h3>
            <div class="relative w-full h-48"><canvas id="navChart"></canvas></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <div class="lg:col-span-3 space-y-6">
            
            <div class="bg-white dark:bg-slate-800 rounded-[2rem] border border-slate-100 dark:border-slate-700 overflow-hidden shadow-sm">
                <div class="p-5 bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700 font-black text-xs uppercase text-slate-500">ğŸ’¼ ç•¶å‰æŒå€‰æ˜ç´°</div>
                <div class="overflow-x-auto no-scrollbar">
                    <table class="w-full text-sm min-w-[700px]">
                        <thead class="bg-slate-50 dark:bg-slate-900 text-slate-400 text-[10px] uppercase font-bold">
                            <tr>
                                <th class="p-4 text-left">æ¨™çš„</th><th class="p-4 text-right">å‡åƒ¹</th><th class="p-4 text-right">ç¾åƒ¹ / æ—¥æ¼²è·Œ</th>
                                <th class="p-4 text-right text-emerald-500">æ®–åˆ©ç‡ (Yield)</th><th class="p-4 text-right">ç¸½æˆæœ¬</th>
                                <th class="p-4 text-right">æœªå¯¦ç¾æç›Š</th><th class="p-4 text-center">AI</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50 dark:divide-slate-700">
                            <tr v-for="(h, sym) in dashboard.holdings" :key="sym" v-show="h.shares > 0" class="hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                                <td class="p-4 font-black">{{ sym }} <span class="block text-[10px] font-normal text-slate-400">{{ h.shares }} è‚¡</span></td>
                                <td class="p-4 text-right font-mono text-slate-500 dark:text-slate-400">${{ formatCurrency(h.avgCost, 2) }}</td>
                                <td class="p-4 text-right font-mono text-blue-500 dark:text-blue-400">
                                    ${{ formatCurrency(h.currentPrice, 2) }}
                                    <span class="block text-[10px]" :class="h.dayChange >= 0 ? 'text-up' : 'text-down'">{{ h.dayChange >= 0 ? 'â–²' : 'â–¼' }}{{ h.dayChange }}%</span>
                                </td>
                                <td class="p-4 text-right font-mono text-emerald-600 dark:text-emerald-400 font-bold">{{ h.yieldPct > 0 ? h.yieldPct + '%' : '-' }}</td>
                                <td class="p-4 text-right font-mono text-slate-500 dark:text-slate-400">${{ formatCurrency(h.totalCost, 0) }}</td>
                                <td class="p-4 text-right font-black font-mono" :class="h.unrealizedPnL >= 0 ? 'text-up' : 'text-down'">
                                    ${{ formatCurrency(h.unrealizedPnL, 0) }}<span class="block text-[10px] opacity-70">{{ h.unrealizedPnLPercent }}%</span>
                                </td>
                                <td class="p-4 text-center"><button @click="openAIModal(sym)" class="bg-blue-50 dark:bg-blue-900 text-blue-600 dark:text-blue-300 text-[10px] font-black px-3 py-1.5 rounded-xl">è§£è®€</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <input type="date" v-model="form.date" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm col-span-2 md:col-span-1 outline-none">
                    <select v-model="form.type" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm font-black outline-none"><option value="buy">è²·å…¥ Buy</option><option value="sell">è³£å‡º Sell</option></select>
                    <input type="text" v-model="form.symbol" placeholder="ä»£è™Ÿ" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm uppercase font-black outline-none">
                    <input type="number" step="0.01" v-model.number="form.price" placeholder="åƒ¹æ ¼" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm font-mono outline-none">
                    <input type="number" v-model.number="form.shares" placeholder="è‚¡æ•¸" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm font-mono outline-none">
                    <button @click="addTransaction" class="col-span-2 md:col-span-5 bg-blue-600 text-white p-3.5 rounded-2xl font-black hover:bg-blue-700 transition">æ–°å¢ç´€éŒ„</button>
                </div>
            </div>
            
            <div class="bg-white dark:bg-slate-800 rounded-[2rem] border border-slate-100 dark:border-slate-700 overflow-hidden shadow-sm">
                <div class="p-5 bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700 flex justify-between items-center">
                    <span class="font-black text-xs uppercase text-slate-500">æ­·å²äº¤æ˜“ (14ç­†æ»¾å‹•)</span>
                    <input v-model="searchQuery" type="text" placeholder="ğŸ” æœå°‹ä»£è™Ÿ..." class="text-xs p-1.5 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 outline-none w-28 text-center font-bold">
                </div>
                <div class="overflow-y-auto no-scrollbar max-h-[720px]">
                    <table class="w-full text-sm min-w-[500px]">
                        <thead class="bg-slate-50 dark:bg-slate-900 text-[10px] text-slate-400 uppercase font-bold sticky top-0 z-10">
                            <tr><th class="p-4 text-left">æ—¥æœŸ</th><th class="p-4 text-left">æ¨™çš„</th><th class="p-4 text-center">æ“ä½œ</th><th class="p-4 text-right">å–®åƒ¹</th><th class="p-4 text-right">è‚¡æ•¸</th><th class="p-4 text-right">å¯¦ç¾æç›Š</th><th class="p-4"></th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50 dark:divide-slate-700">
                            <tr v-for="t in filteredTransactions" :key="t.id" class="hover:bg-slate-50 dark:hover:bg-slate-700 transition h-[51px]">
                                <td class="p-4 text-[10px] text-slate-400 font-mono">{{ t.date }}</td><td class="p-4 font-black uppercase">{{ t.symbol }}</td>
                                <td class="p-4 text-center"><span :class="t.type==='buy'?'text-blue-500 bg-blue-50 dark:bg-blue-900/50':'text-amber-500 bg-amber-50 dark:bg-amber-900/50'" class="px-2 py-0.5 rounded-lg text-[9px] font-black uppercase">{{ t.type }}</span></td>
                                <td class="p-4 text-right font-mono">${{ formatCurrency(t.price, 2) }}</td><td class="p-4 text-right font-mono">{{ t.shares }}</td>
                                <td class="p-4 text-right font-black font-mono" :class="t.realizedPnL >= 0 ? 'text-up' : 'text-down'"><span v-if="t.type.toLowerCase()==='sell'">${{ formatCurrency(t.realizedPnL, 0) }}</span><span v-else class="text-slate-300 dark:text-slate-600">-</span></td>
                                <td class="p-4 text-center"><button @click="removeTransaction(t.id)" class="text-slate-300 dark:text-slate-600 hover:text-red-500 font-black">Ã—</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-white dark:bg-slate-800 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm overflow-hidden">
                <div class="p-5 bg-slate-50 dark:bg-slate-900 font-black text-xs uppercase text-slate-500">ğŸ“ˆ æ¯æœˆç²åˆ©</div>
                <div class="max-h-48 overflow-y-auto divide-y divide-slate-50 dark:divide-slate-700 no-scrollbar">
                    <div v-for="s in monthlyStats" :key="s.month" class="p-4 flex justify-between text-sm">
                        <span class="font-bold text-slate-500 uppercase">{{ s.month }}</span><span :class="s.pnl >= 0 ? 'text-up' : 'text-down'" class="font-black font-mono">{{ s.pnl >= 0 ? '+' : '' }}${{ formatCurrency(s.pnl, 0) }}</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-slate-800 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm overflow-hidden">
                <div class="p-5 bg-slate-50 dark:bg-slate-900 font-black text-xs uppercase text-slate-500">ğŸ’µ ç¾é‡‘æµ</div>
                <div class="max-h-48 overflow-y-auto divide-y divide-slate-50 dark:divide-slate-700 no-scrollbar">
                    <div v-for="c in sortedCash" :key="c.id" class="p-4 flex justify-between text-sm"><div class="max-w-[60%]"><p class="font-black truncate text-xs">{{ c.note }}</p><p class="text-[10px] text-slate-400 font-mono">{{ c.date }}</p></div><span :class="c.amount >= 0 ? 'text-blue-500' : 'text-red-500'" class="font-black font-mono text-xs">{{ c.amount >= 0 ? '+' : '' }}${{ formatCurrency(c.amount, 0) }}</span></div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 rounded-[2rem] shadow-2xl border border-slate-100 dark:border-slate-700 overflow-hidden">
                <div class="p-5 bg-slate-900 dark:bg-black text-white font-black text-xs uppercase">ğŸ“¢ AI ç™¼å¸ƒçµ‚ç«¯</div>
                <div class="p-5 border-b dark:border-slate-700 space-y-3 bg-slate-50 dark:bg-slate-800">
                    <input v-model="recForm.symbol" placeholder="ä»£è™Ÿ" class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm uppercase font-black outline-none">
                    <div class="flex gap-2">
                        <select v-model="recForm.type" class="w-1/2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm font-black outline-none"><option value="Buy">è²·å…¥</option><option value="Sell">è³£å‡º</option></select>
                        <input v-model.number="recForm.price" type="number" step="0.01" placeholder="åƒ¹æ ¼" class="w-1/2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm font-mono outline-none">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-slate-400 font-black uppercase">AI æ•¸:</span>
                        <input v-model.number="recForm.count" type="number" class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-2 rounded-xl text-xs font-mono outline-none">
                    </div>
                    <button @click="generateAnalysis" :disabled="isGeneratingAnalysis" class="w-full py-2.5 bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300 rounded-xl text-[10px] font-black border border-purple-200 dark:border-purple-800">
                        {{ isGeneratingAnalysis ? 'ğŸ§  Gemini æ€è€ƒä¸­...' : 'âœ¨ è‡ªå‹•ç”Ÿæˆ AI è§€é»' }}
                    </button>
                    <textarea v-model="recForm.analysis" rows="2" placeholder="åˆ†æå…§å®¹..." class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-[10px] outline-none"></textarea>
                    
                    <button @click="addRecommendation" class="w-full mt-2 bg-blue-600 text-white py-3 rounded-xl font-black text-xs shadow-lg shadow-blue-500/30">ç¢ºèªç™¼å¸ƒ</button>
                </div>
                
                <div class="divide-y divide-slate-50 dark:divide-slate-700 max-h-80 overflow-y-auto no-scrollbar">
                    <div v-for="r in sortedRecommendations" :key="r.id" class="p-4 relative">
                        <button @click="removeRecommendation(r.id)" class="absolute top-4 right-4 text-slate-300 hover:text-red-500">Ã—</button>
                        <p class="font-black text-sm">{{ r.symbol }} <span class="text-[9px] text-slate-400 font-mono ml-1">{{ r.date }}</span></p>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-[10px] font-bold" :class="r.type==='Buy'?'text-green-500':'text-red-500'">{{ r.type==='Buy'?'è²·å…¥':'è³£å‡º' }} @ ${{ r.price }}</span>
                            <span class="text-[9px] bg-orange-100 dark:bg-orange-900/50 text-orange-700 dark:text-orange-400 px-1.5 rounded-full font-bold">AI: {{ r.count }}</span>
                        </div>
                        <div v-if="r.analysis" class="mt-2">
                            <button @click="r.showDetails = !r.showDetails" class="text-[9px] text-blue-500 font-black hover:underline">{{ r.showDetails ? 'éš±è—åˆ†æ â–²' : 'æŸ¥çœ‹è§€é» â–¼' }}</button>
                            <div v-if="r.showDetails" class="mt-2 text-[11px] bg-slate-50 dark:bg-slate-900 p-3 rounded-xl leading-relaxed markdown-content border border-slate-100 dark:border-slate-700" v-html="marked.parse(r.analysis)"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div v-if="showAIModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-2 z-[60] transition-opacity">
        <div class="bg-white dark:bg-slate-800 rounded-[2.5rem] w-full max-w-3xl max-h-[85vh] overflow-hidden flex flex-col shadow-2xl border border-slate-200 dark:border-slate-700">
            <div class="p-5 bg-gradient-to-r from-slate-900 to-indigo-900 text-white flex justify-between items-center font-black">
                <span class="text-sm uppercase tracking-widest flex items-center gap-2">ğŸ§  Quantum Analysis <span class="text-[10px] bg-white/20 px-2 rounded">{{ selectedSymbol }}</span></span>
                <button @click="showAIModal=false" class="w-8 h-8 flex items-center justify-center bg-white/20 hover:bg-white/30 rounded-full transition">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 no-scrollbar bg-slate-50 dark:bg-slate-800">
                <div v-if="aiLoading" class="flex flex-col items-center py-20">
                    <div class="loader mb-4 border-t-indigo-500 border-4 w-12 h-12"></div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest italic animate-pulse">Deep Thinking in Progress...</p>
                </div>
                <div v-else class="text-slate-700 dark:text-slate-300 markdown-content" v-html="marked.parse(aiContent || 'æ²’æœ‰ç²å–åˆ°åˆ†æçµæœã€‚')"></div>
            </div>
        </div>
    </div>

    <div v-if="showCashModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[60] p-4">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl w-full max-w-xs shadow-2xl border border-slate-100 dark:border-slate-700">
            <h3 class="font-black mb-4 uppercase text-xs border-b dark:border-slate-700 pb-2">Cash Adjustment</h3>
            <div class="space-y-4">
                <input type="date" v-model="cashForm.date" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm outline-none">
                <input type="number" v-model.number="cashForm.amount" placeholder="é‡‘é¡ (è² æ•¸ç‚ºæ‰£æ¬¾)" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm font-mono outline-none">
                <input type="text" v-model="cashForm.note" placeholder="å‚™è¨»" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm font-black outline-none">
                <div class="flex gap-2 pt-2">
                    <button @click="addCashAdjustment" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-black text-xs">ç¢ºèª</button>
                    <button @click="showCashModal=false" class="flex-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 py-3 rounded-xl font-black text-xs">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
const { createApp, reactive, computed, onMounted, ref, watch } = Vue;

// ğŸ”´ å¿…å¡«ï¼šè«‹å¡«å…¥æ‚¨çš„ Apps Script ç¶²å€
const API_URL = 'https://script.google.com/macros/s/AKfycbwnZjrQSJP3q-sV7-CwsBdPEa6kHNa1kanPnhDlKxeNSjyaygQawjJnpV0N012Xz1C_/exec'; 

createApp({
    setup() {
        const transactions = ref([]); const marketData = ref({}); const cashAdjustments = ref([]); const recommendations = ref([]);
        const navHistoryData = ref([]); 
        const isSyncing = ref(false); const password = ref(localStorage.getItem('p_pass') || '');
        const form = reactive({ date: new Date().toISOString().split('T')[0], type: 'buy', symbol: '', price: '', shares: '' });
        
        // å·²ç§»é™¤æ¨æ’­ç›¸é—œè®Šæ•¸
        const recForm = reactive({ symbol: '', type: 'Buy', price: '', count: 1, analysis: '' });

        const searchQuery = ref(''); const showCashModal = ref(false); const showAIModal = ref(false); 
        const aiLoading = ref(false); const selectedSymbol = ref(''); const aiContent = ref('');
        const cashForm = reactive({ date: new Date().toISOString().split('T')[0], amount: '', note: '' });
        const isGeneratingAnalysis = ref(false);

        onMounted(() => { 
            const cached = localStorage.getItem('app_cache');
            if (cached) {
                try {
                    const p = JSON.parse(cached);
                    transactions.value = p.transactions||[]; marketData.value = p.marketData||{}; cashAdjustments.value = p.cashAdjustments||[]; recommendations.value = p.recommendations||[]; navHistoryData.value = p.navHistory||[];
                } catch(e) {}
            }
            if (password.value) fetchData(false); 
            if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
        });

        const toggleDarkMode = () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            renderChart(); 
        };

        const checkPassword = () => {
            if (!password.value) { const p = prompt('è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼:'); if (p) { password.value = p; localStorage.setItem('p_pass', p); return true; } return false; }
            return true;
        };

        const fetchData = async (forceAlert = false) => {
            if (!checkPassword()) return;
            isSyncing.value = true;
            try {
                const res = await fetch(`${API_URL}?action=read&password=${encodeURIComponent(password.value)}`);
                const data = await res.json();
                if (data.status === 'error') throw new Error(data.message);
                transactions.value = data.transactions || []; marketData.value = data.marketData || {}; 
                cashAdjustments.value = data.cashAdjustments || []; navHistoryData.value = data.navHistory || [];
                recommendations.value = (data.recommendations || []).map(r=>({...r, showDetails:false}));
                localStorage.setItem('app_cache', JSON.stringify({transactions: transactions.value, marketData: marketData.value, cashAdjustments: cashAdjustments.value, recommendations: recommendations.value, navHistory: navHistoryData.value}));
            } catch (e) { if(forceAlert) alert(`åŒæ­¥å¤±æ•—: ${e.message}`); } finally { isSyncing.value = false; }
        };

        // å·²ç§»é™¤æ¨æ’­ç›¸é—œåƒæ•¸å‚³é
        const saveData = async () => {
            if (!checkPassword()) return;
            if (!confirm('ç¢ºèªå„²å­˜ä¸¦è¨˜éŒ„ç•¶å‰æ·¨å€¼å—ï¼Ÿ')) return;
            try {
                const cleanRecs = recommendations.value.map(({showDetails, ...rest}) => rest);
                const payload = { 
                    transactions: transactions.value, cashAdjustments: cashAdjustments.value, recommendations: cleanRecs,
                    currentNav: dashboard.value.totalNav
                };
                const res = await fetch(`${API_URL}?action=save&password=${encodeURIComponent(password.value)}`, { method: 'POST', body: JSON.stringify(payload) });
                const d = await res.json();
                if(d.status === 'error') throw new Error(d.message);
                
                alert('å„²å­˜èˆ‡æ·¨å€¼å¿«ç…§è¨˜éŒ„æˆåŠŸï¼'); fetchData(false);
            } catch(e) { alert(`å„²å­˜å¤±æ•—: ${e.message}`); }
        };

        const dashboard = computed(() => {
            let cash = 0, holdings = {}, investedAmount = 0, totalRealized = 0, totalUnrealized = 0, totalDividend = 0;
            cashAdjustments.value.forEach(a => cash += Number(a.amount));
            [...transactions.value].sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(t => {
                const sym = t.symbol.toUpperCase();
                if(!holdings[sym]) holdings[sym] = {shares:0, totalCost:0, avgCost:0, currentPrice:0, dayChange:0, yieldPct:0, unrealizedPnL:0};
                const amt = Number(t.price) * Number(t.shares);
                if (t.type.toLowerCase() === 'buy') { cash -= amt; holdings[sym].totalCost += amt; holdings[sym].shares += Number(t.shares); } 
                else { cash += amt; const c = holdings[sym].avgCost * Number(t.shares); totalRealized += (amt - c); holdings[sym].totalCost -= c; holdings[sym].shares -= Number(t.shares); }
                if(holdings[sym].shares > 0) holdings[sym].avgCost = holdings[sym].totalCost / holdings[sym].shares;
            });
            for(let s in holdings) {
                if(holdings[s].shares > 0) {
                    investedAmount += holdings[s].totalCost;
                    holdings[s].currentPrice = marketData.value[s]?.price || 0;
                    holdings[s].dayChange = marketData.value[s]?.change || 0; 
                    holdings[s].yieldPct = marketData.value[s]?.yield || 0; 
                    holdings[s].unrealizedPnL = (holdings[s].currentPrice * holdings[s].shares) - holdings[s].totalCost;
                    holdings[s].unrealizedPnLPercent = holdings[s].totalCost > 0 ? ((holdings[s].unrealizedPnL / holdings[s].totalCost) * 100).toFixed(2) : 0;
                    totalUnrealized += holdings[s].unrealizedPnL;
                    totalDividend += (holdings[s].shares * holdings[s].currentPrice * (holdings[s].yieldPct / 100)); 
                }
            }
            return { cash, holdings, investedAmount, totalRealized, totalUnrealized, totalDividend, totalNav: cash + investedAmount + totalUnrealized };
        });

        const sortedTransactions = computed(() => {
            const h = {};
            return [...transactions.value].sort((a,b)=>new Date(a.date)-new Date(b.date)).map(t => {
                const sym = t.symbol.toUpperCase(); if(!h[sym]) h[sym] = {s:0, c:0, avg:0};
                let pnl = 0; 
                if(t.type.toLowerCase()==='buy'){ 
                    h[sym].c += Number(t.price)*Number(t.shares); 
                    h[sym].s += Number(t.shares); 
                    h[sym].avg = h[sym].c/h[sym].s; 
                } else { 
                    pnl = (Number(t.price) - h[sym].avg)*Number(t.shares); 
                    h[sym].c -= h[sym].avg*Number(t.shares); 
                    h[sym].s -= Number(t.shares); 
                }
                return {...t, realizedPnL: pnl};
            }).reverse();
        });

        let pieChart = null; let lineChart = null;
        const renderChart = () => {
            const isDark = document.documentElement.classList.contains('dark');
            const txtColor = isDark ? '#cbd5e1' : '#64748b';
            
            const ctxPie = document.getElementById('allocationChart'); 
            if(ctxPie) {
                if(pieChart) pieChart.destroy();
                const validHoldings = Object.entries(dashboard.value.holdings).filter(([k, v]) => v.shares > 0);
                if(validHoldings.length > 0) {
                    pieChart = new Chart(ctxPie, {
                        type: 'doughnut',
                        data: { labels: validHoldings.map(h => h[0]), datasets: [{ data: validHoldings.map(h => h[1].totalCost), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'], borderWidth: isDark? 0 : 2 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '75%' }
                    });
                }
            }

            const ctxLine = document.getElementById('navChart');
            if(ctxLine && navHistoryData.value.length > 0) {
                if(lineChart) lineChart.destroy();
                const history = [...navHistoryData.value].sort((a,b) => new Date(a.date) - new Date(b.date));
                lineChart = new Chart(ctxLine, {
                    type: 'line',
                    data: { labels: history.map(h => h.date.substring(5)), datasets: [{ label: 'NAV', data: history.map(h => h.nav), borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', borderWidth: 3, fill: true, tension: 0.4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: txtColor } }, y: { ticks: { color: txtColor } } } }
                });
            }
        };
        watch(() => [dashboard.value.holdings, navHistoryData.value], renderChart, { deep: true });

        const reviewPortfolio = async () => {
            if (!checkPassword()) return;
            selectedSymbol.value = "Portfolio Holistic Review"; 
            showAIModal.value = true; aiLoading.value = true; aiContent.value = '';
            
            let pStr = `ç¸½è³‡é‡‘: $${dashboard.value.totalNav.toFixed(0)} (ç¾é‡‘: $${dashboard.value.cash.toFixed(0)})\n`;
            Object.keys(dashboard.value.holdings).forEach(s => {
                const h = dashboard.value.holdings[s];
                if(h.shares > 0) pStr += `- ${s}: ä½”æ¯” ${((h.shares*h.currentPrice)/dashboard.value.totalNav*100).toFixed(1)}%, æˆæœ¬ $${h.totalCost.toFixed(0)}\n`;
            });

            try {
                const r = await fetch(`${API_URL}?action=review_portfolio&portfolio=${encodeURIComponent(pStr)}&password=${encodeURIComponent(password.value)}`);
                const d = await r.json();
                if (d.status === 'error') throw new Error(d.message);
                aiContent.value = d.analysis;
            } catch(e) { aiContent.value = `âŒ å¥æª¢å¤±æ•—: ${e.message}`; } finally { aiLoading.value = false; }
        };

        const openAIModal = async (s) => { 
            selectedSymbol.value = s; showAIModal.value = true; aiLoading.value = true; aiContent.value = '';
            try {
                const r = await fetch(`${API_URL}?action=analyze&symbol=${s}&password=${encodeURIComponent(password.value)}`);
                const d = await r.json(); aiContent.value = d.analysis;
            } catch(e) { aiContent.value = `âŒ è®€å–å¤±æ•—: ${e.message}`; } finally { aiLoading.value = false; }
        };

        const generateAnalysis = async () => {
            if (!recForm.symbol) return alert('è«‹å…ˆè¼¸å…¥ä»£è™Ÿï¼'); if (!checkPassword()) return;
            isGeneratingAnalysis.value = true;
            try {
                const r = await fetch(`${API_URL}?action=analyze&symbol=${recForm.symbol}&password=${encodeURIComponent(password.value)}`);
                const d = await r.json(); recForm.analysis = d.analysis;
            } catch(e) { alert(`AI ç”Ÿæˆå¤±æ•—`); } finally { isGeneratingAnalysis.value = false; }
        };

        // å·²ç§»é™¤æ¨æ’­é‚è¼¯
        const addRecommendation = () => { 
            if(!recForm.symbol) return; 
            const newRec = { id:Date.now(), date:new Date().toISOString().split('T')[0], symbol:recForm.symbol.toUpperCase(), type:recForm.type, price:recForm.price, count:recForm.count, analysis:recForm.analysis };
            recommendations.value.push({...newRec, showDetails:false}); 
            
            recForm.symbol=''; recForm.analysis=''; recForm.count=1; 
        };
        
        const filteredTransactions = computed(() => { if(!searchQuery.value) return sortedTransactions.value; return sortedTransactions.value.filter(t => t.symbol.includes(searchQuery.value.toUpperCase())); });
        const exportCSV = () => { const header = "\uFEFFDate,Symbol,Type,Price,Shares\n"; const rows = sortedTransactions.value.map(t => `${t.date},${t.symbol},${t.type},${t.price},${t.shares}`).join("\n"); const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([header + rows], { type: 'text/csv;charset=utf-8;' })); link.download = "trading_history.csv"; link.click(); };
        const addTransaction = () => { if(!form.symbol) return; transactions.value.push({id:Date.now(), ...form, symbol: form.symbol.toUpperCase()}); form.symbol=''; form.price=''; form.shares=''; };
        const removeTransaction = (id) => { if(confirm('åˆªé™¤äº¤æ˜“ï¼Ÿ')) transactions.value = transactions.value.filter(t=>t.id!==id); };
        const addCashAdjustment = () => { if(!cashForm.amount) return; cashAdjustments.value.push({id:Date.now(), ...cashForm}); showCashModal.value=false; cashForm.amount=''; cashForm.note=''; };
        const removeRecommendation = (id) => { if(confirm('åˆªé™¤å…¬å‘Šï¼Ÿ')) recommendations.value = recommendations.value.filter(r=>r.id!==id); };
        const formatCurrency = (v, d=0) => (v||0).toLocaleString('en-US', {minimumFractionDigits:d, maximumFractionDigits:d});
        
        const monthlyStats = computed(() => { const s = {}; sortedTransactions.value.forEach(t => { if(t.type.toLowerCase()==='sell' && t.realizedPnL) { const m = t.date.substring(0,7); s[m] = (s[m]||0) + t.realizedPnL; } }); return Object.keys(s).sort().reverse().map(m => ({ month: m, pnl: s[m] })); });

        return { 
            dashboard, form, cashForm, recForm, transactions, cashAdjustments, recommendations, sortedTransactions, filteredTransactions, searchQuery, monthlyStats,
            sortedCash: computed(()=>[...cashAdjustments.value].reverse()), sortedRecommendations: computed(()=>[...recommendations.value].reverse()), 
            fetchData, saveData, toggleDarkMode, exportCSV, reviewPortfolio, openAIModal, generateAnalysis, addRecommendation, addTransaction, removeTransaction, addCashAdjustment, removeRecommendation,
            showAIModal, showCashModal, aiLoading, aiContent, selectedSymbol, isGeneratingAnalysis, formatCurrency, isSyncing, marked
        };
    }
}).mount('#app');
</script>
</body>
</html>
