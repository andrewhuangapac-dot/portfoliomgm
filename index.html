<!DOCTYPE html>
<html lang="zh-TW" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç¾è‚¡é‡åŒ–æˆ°æƒ…å®¤ v5.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s ease; }
        .text-up { color: #10b981; } .text-down { color: #ef4444; } 
        .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .markdown-content p { margin-bottom: 12px; } .markdown-content h3 { font-weight: 900; margin-top: 16px; margin-bottom: 8px; color: #0f172a; }
        .dark .markdown-content h3 { color: #f8fafc; } .markdown-content ul { list-style-type: disc; padding-left: 20px; }
        .sidebar-item { transition: all 0.2s ease-in-out; border-left: 4px solid transparent; }
        .sidebar-item.active { border-left-color: #6366f1; background-color: rgba(99, 102, 241, 0.1); color: #4f46e5; font-weight: 900; }
        .dark .sidebar-item.active { color: #818cf8; background-color: rgba(99, 102, 241, 0.2); }
        .layout-container { display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 220px; flex-shrink: 0; overflow-y: auto; border-right: 1px solid #e2e8f0; }
        .dark .sidebar { border-right-color: #334155; }
        .main-content { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
        
        @media (max-width: 1024px) {
            .layout-container { flex-direction: column; }
            .sidebar { 
                width: 100%; height: auto; border-right: none; display: flex; overflow-x: auto; white-space: nowrap; 
                padding: calc(16px + env(safe-area-inset-top, 40px)) 16px 16px 16px; gap: 12px; 
                -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory; 
                background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05);
                position: sticky; top: 0; z-index: 40;
            }
            .dark .sidebar { background: rgba(15, 23, 42, 0.85); border-bottom-color: rgba(255,255,255,0.05); }
            .sidebar-item { scroll-snap-align: start; border-left: none !important; border-bottom: none !important; padding: 10px 20px !important; border-radius: 9999px !important; background: #f1f5f9; margin: 0 !important; flex-shrink: 0; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
            .dark .sidebar-item { background: #1e293b; }
            .sidebar-item.active { background: #6366f1 !important; color: #ffffff !important; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
            .sidebar-item.active span:last-child { background: rgba(255,255,255,0.2) !important; color: white !important; }
        }
        details { outline: none; }
        details summary { cursor: pointer; list-style: none; user-select: none; }
        details summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: slideDown 0.3s ease-in-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200">
<div id="app" class="layout-container">
    
    <div class="sidebar bg-white dark:bg-slate-900 p-4 no-scrollbar z-10 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
        <div class="mb-8 hidden lg:block">
            <h1 class="text-xl font-black tracking-tight leading-none">Quant<br><span class="text-indigo-600 dark:text-indigo-400">Terminal</span></h1>
            <span class="text-[9px] bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 px-1.5 py-0.5 rounded font-black tracking-widest uppercase mt-1 inline-block">v5.0 Stable</span>
        </div>
        
        <div class="text-[10px] font-black uppercase text-slate-400 mb-2 px-3 tracking-widest hidden lg:block">æŠ•è³‡çµ„åˆè¦–è§’</div>
        <div @click="currentTab = 'å…¨å±€'" class="sidebar-item cursor-pointer px-3 py-2.5 rounded-lg mb-1 lg:mb-4 flex items-center gap-2" :class="{'active': currentTab === 'å…¨å±€'}">
            <span class="text-lg">ğŸŒ</span> <span class="text-sm">å…¨å±€ç¸½è¦½</span>
        </div>

        <div class="text-[10px] font-black uppercase text-slate-400 mb-2 px-3 tracking-widest hidden lg:block">è¡Œæ¥­æ¿å¡Šæ‹†è§£</div>
        <div v-for="sector in sectorList" :key="sector.name" @click="currentTab = sector.name" class="sidebar-item cursor-pointer px-3 py-2.5 rounded-lg mb-1 flex justify-between items-center" :class="{'active': currentTab === sector.name}">
            <div class="flex items-center gap-2 truncate"><span class="text-xs font-bold truncate">{{ sector.name }}</span></div>
            <span class="text-[9px] bg-slate-100 dark:bg-slate-800 px-1.5 rounded text-slate-500 font-mono">{{ sector.count }}</span>
        </div>
    </div>

    <div class="main-content no-scrollbar pb-24">
        
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h2 class="text-2xl font-black tracking-tight">{{ currentTab === 'å…¨å±€' ? 'å…¨å±€æˆ°ç•¥ç¸½è¦½' : currentTab }}</h2>
                <p v-if="isSyncing" class="text-blue-500 text-xs mt-1 animate-pulse font-bold tracking-widest uppercase">ğŸ”„ Syncing Backend...</p>
                <p v-else class="text-slate-500 dark:text-slate-400 text-xs mt-1 font-bold flex items-center gap-1">Qwen3.5-Plus <span v-if="Object.keys(aiSectorMap).length > 0" class="bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 px-1.5 py-0.5 rounded text-[9px] ml-1">AI æ™ºèƒ½é‹ä½œä¸­</span></p>
            </div>
            <div class="flex flex-wrap gap-2">
                <button @click="runAutoSectorMap" :disabled="isReorganizing" class="px-3 py-1.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl text-xs font-black shadow-lg flex items-center gap-1 hover:scale-105 transition">
                    <span v-if="isReorganizing" class="animate-pulse">â³ é‡çµ„ä¸­...</span>
                    <span v-else>âœ¨ AI æ™ºèƒ½åˆ†é¡</span>
                </button>
                <button @click="toggleDarkMode" class="px-3 py-1.5 bg-slate-200 dark:bg-slate-800 rounded-xl text-xs font-bold shadow-sm">ğŸŒ“</button>
                <button @click="fetchData(true)" class="px-3 py-1.5 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl shadow-sm text-xs font-bold">ğŸ”„ åŒæ­¥</button>
                <button @click="saveData" class="px-3 py-1.5 bg-slate-900 dark:bg-black text-white rounded-xl shadow-lg text-xs font-bold">ğŸ’¾ å„²å­˜</button>
            </div>
        </header>

        <div v-if="currentTab === 'å…¨å±€'">
            <div class="grid grid-cols-2 lg:grid-cols-7 gap-3 mb-6">
                <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700"><p class="text-[10px] text-slate-400 font-black uppercase">å¯ç”¨ç¾é‡‘</p><p class="text-lg lg:text-xl font-black mt-1">${{ formatCurrency(dashboard?.cash) }} <span @click="showCashModal=true" class="text-[10px] text-blue-500 cursor-pointer underline ml-1">èª¿ç¯€</span></p></div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700"><p class="text-[10px] text-slate-400 font-black uppercase">æŒå€‰ç¸½æˆæœ¬</p><p class="text-lg lg:text-xl font-black mt-1">${{ formatCurrency(dashboard?.investedAmount) }}</p></div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700"><p class="text-[10px] text-slate-400 font-black uppercase">å·²å¯¦ç¾æç›Š</p><p class="text-lg lg:text-xl font-black mt-1" :class="(dashboard?.totalRealized || 0) >= 0 ? 'text-up' : 'text-down'">{{ (dashboard?.totalRealized || 0) >= 0 ? '+' : '' }}${{ formatCurrency(dashboard?.totalRealized) }}</p></div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700"><p class="text-[10px] text-slate-400 font-black uppercase">æœªå¯¦ç¾æç›Š</p><p class="text-lg lg:text-xl font-black mt-1" :class="(dashboard?.totalUnrealized || 0) >= 0 ? 'text-up' : 'text-down'">{{ (dashboard?.totalUnrealized || 0) >= 0 ? '+' : '' }}${{ formatCurrency(dashboard?.totalUnrealized) }}</p></div>
                <div class="bg-slate-900 dark:bg-black p-4 rounded-3xl shadow-xl col-span-3 flex flex-col justify-center"><p class="text-[10px] text-slate-400 font-bold uppercase">ç¸½è³‡ç”¢æ·¨å€¼ (NAV)</p><p class="text-2xl lg:text-3xl font-black text-white mt-1">${{ formatCurrency(dashboard?.totalNav) }}</p></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white dark:bg-slate-800 p-5 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm"><h3 class="text-[11px] font-black uppercase text-slate-400 mb-2">è³‡ç”¢æ¿å¡Šé…ç½®</h3><div class="relative w-full h-48"><canvas id="allocationChart"></canvas></div></div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm"><h3 class="text-[11px] font-black uppercase text-slate-400 mb-2">ç¸½è³‡ç”¢èµ°å‹¢ (Equity Curve)</h3><div class="relative w-full h-48"><canvas id="navChart"></canvas></div></div>
            </div>
            
            <div class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm mb-6">
                <h3 class="font-black text-xs uppercase text-slate-500 mb-4">ğŸš€ å¿«é€ŸåŸ·è¡Œäº¤æ˜“</h3>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                    <input type="date" v-model="form.date" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm outline-none md:col-span-1 col-span-2">
                    <select v-model="form.type" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm font-black outline-none"><option value="buy">è²·å…¥</option><option value="sell">è³£å‡º</option></select>
                    <input type="text" v-model="form.symbol" placeholder="è¼¸å…¥ä»£è™Ÿ" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm uppercase font-black outline-none md:col-span-2 col-span-2">
                    <input type="number" step="0.01" v-model.number="form.price" placeholder="åƒ¹æ ¼" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm font-mono outline-none">
                    <input type="number" v-model.number="form.shares" placeholder="è‚¡æ•¸" class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm font-mono outline-none">
                    <button @click="addTransaction" class="col-span-2 md:col-span-6 bg-blue-600 text-white p-3.5 rounded-2xl font-black hover:bg-blue-700 transition shadow-lg">ç¢ºèªå¯«å…¥</button>
                </div>
            </div>
        </div>

        <div v-show="currentTab !== 'å…¨å±€'">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                <div class="lg:col-span-3 bg-slate-100 dark:bg-slate-800/60 p-5 rounded-[2rem] border border-slate-200 dark:border-slate-700 shadow-sm flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xs font-black text-indigo-600 dark:text-indigo-400 uppercase tracking-widest flex items-center gap-2">ğŸ‘‘ æ¿å¡ŠåŸºæº– ETF å‹•èƒ½</span>
                        <span class="text-[10px] text-slate-500 bg-white dark:bg-slate-900 px-3 py-1 rounded-lg border border-slate-200 dark:border-slate-700">{{ getSectorInfo(currentTab).desc }}</span>
                    </div>
                    <div class="flex-1 bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden flex flex-col justify-center p-6 min-h-[128px]">
                        <div v-if="isFetchingHistory" class="text-xs text-slate-400 animate-pulse text-center w-full">æŠ“å–æ­·å²å ±åƒ¹ä¸­...</div>
                        <div v-else-if="benchmarkHistory.symbol" class="flex items-center justify-between">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">åŸºæº–æ¨™çš„</span>
                                <span class="font-black text-3xl">{{ benchmarkHistory.symbol }}</span>
                            </div>
                            <div class="flex gap-8 text-right">
                                <div class="flex flex-col">
                                    <span class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">è¿‘ 30 å¤©</span>
                                    <span class="font-black text-2xl font-mono" :class="benchmarkHistory.pct30d >= 0 ? 'text-up' : 'text-down'">{{ benchmarkHistory.pct30d >= 0 ? '+' : '' }}{{ benchmarkHistory.pct30d }}%</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">è¿‘ 90 å¤©</span>
                                    <span class="font-black text-2xl font-mono" :class="benchmarkHistory.pct90d >= 0 ? 'text-up' : 'text-down'">{{ benchmarkHistory.pct90d >= 0 ? '+' : '' }}{{ benchmarkHistory.pct90d }}%</span>
                                </div>
                            </div>
                        </div>
                        <div v-else class="text-xs text-slate-400 text-center w-full">æš«ç„¡ ETF æ•¸æ“š</div>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 p-5 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm lg:col-span-1 flex flex-col">
                    <h3 class="text-[11px] font-black uppercase text-slate-500 mb-3 tracking-widest flex items-center gap-1">ğŸ† æ¿å¡Š Alpha å¼·å‹¢è‚¡</h3>
                    <div class="flex-1 flex flex-col gap-2 justify-center">
                        <div v-if="isFetchingHistory" class="text-xs text-slate-400 animate-pulse text-center w-full py-4">æŠ“å–ä¸­...</div>
                        <template v-else>
                            <div v-for="(sym, i) in getSectorGainers(currentTab)" :key="sym" class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-100 dark:border-slate-800">
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] bg-slate-200 dark:bg-slate-700 px-1.5 rounded text-slate-500 font-mono">{{i+1}}</span> 
                                    <span class="font-black text-sm uppercase">{{ sym }}</span>
                                </div>
                                <div class="flex flex-col items-end">
                                    <span class="text-[9px] text-slate-400 mb-0.5 tracking-widest">30å¤© / 90å¤©</span>
                                    <div class="text-[11px] font-black font-mono flex gap-1.5">
                                        <span :class="(sectorGainersData[sym]?.pct30d || 0) >= 0 ? 'text-up' : 'text-down'">{{ (sectorGainersData[sym]?.pct30d || 0) >= 0 ? '+' : '' }}{{ sectorGainersData[sym]?.pct30d || '...' }}%</span>
                                        <span class="text-slate-300 dark:text-slate-600">/</span>
                                        <span :class="(sectorGainersData[sym]?.pct90d || 0) >= 0 ? 'text-up' : 'text-down'">{{ (sectorGainersData[sym]?.pct90d || 0) >= 0 ? '+' : '' }}{{ sectorGainersData[sym]?.pct90d || '...' }}%</span>
                                    </div>
                                </div>
                            </div>
                            <div v-if="getSectorGainers(currentTab).length === 0" class="text-xs text-slate-400 text-center py-4">è«‹é»æ“Šä¸Šæ–¹ [AIæ™ºèƒ½åˆ†é¡] å°‹æ‰¾</div>
                        </template>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" v-if="currentSectorStats">
                <div class="bg-gradient-to-br from-indigo-50 to-blue-50 dark:from-indigo-900/30 dark:to-blue-900/20 p-5 rounded-[2rem] border border-indigo-100 dark:border-indigo-800/50 shadow-sm flex flex-col justify-center"><p class="text-[10px] text-indigo-500 dark:text-indigo-400 font-black uppercase tracking-widest mb-1">æ¿å¡Šè³‡é‡‘æ¬Šé‡</p><p class="text-3xl font-black text-indigo-700 dark:text-indigo-300">{{ currentSectorStats.weightPercent || 0 }}%</p></div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm flex flex-col justify-center"><p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">æ¿å¡Šç¸½åƒ¹å€¼</p><p class="text-3xl font-black text-slate-700 dark:text-slate-300">${{ formatCurrency(currentSectorStats.totalValue, 0) }}</p></div>
            </div>
        </div>

        <div class="bg-white dark:bg-slate-800 rounded-[2rem] border border-slate-100 dark:border-slate-700 overflow-hidden shadow-sm mb-6">
            <div class="p-5 bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <span class="font-black text-xs uppercase text-slate-500">ğŸ’¼ {{ currentTab === 'å…¨å±€' ? 'æŒå€‰æ¦‚è¦' : currentTab + ' æ¿å¡ŠæŒå€‰æ¦‚è¦' }}</span>
                <span class="text-[10px] font-bold text-slate-400">ğŸ’¡ æ¯æ—¥ç›¤å‰ AI é›·é”å°‡è‡ªå‹•æ¨é€è‡³æ‚¨çš„ Telegram</span>
            </div>
            <div class="overflow-x-auto no-scrollbar">
                <table class="w-full text-sm min-w-[800px]">
                    <thead class="bg-slate-50 dark:bg-slate-900 text-slate-400 text-[10px] uppercase font-bold">
                        <tr>
                            <th class="p-4 text-left">æ¨™çš„</th>
                            <th class="p-4 text-right">æŒè‚¡æ•¸é‡</th>
                            <th class="p-4 text-right">å‡åƒ¹ / ç¾åƒ¹</th>
                            <th class="p-4 text-right">è¿‘90å¤©æ¼²è·Œå¹…</th>
                            <th class="p-4 text-right">æœªå¯¦ç¾æç›Š</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50 dark:divide-slate-700">
                        <tr v-for="h in (filteredHoldings || [])" :key="h.symbol" class="hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                            <td class="p-4 font-black text-lg">{{ h.symbol }}<div class="mt-0.5"><span class="text-[9px] bg-slate-100 dark:bg-slate-800 text-slate-500 px-1.5 py-0.5 rounded mr-1">{{ h.sector }}</span></div></td>
                            <td class="p-4 text-right font-mono font-bold text-slate-600 dark:text-slate-300">{{ h.shares }}</td>
                            <td class="p-4 text-right font-mono text-slate-500 dark:text-slate-400">${{ formatCurrency(h.avgCost, 2) }}<span class="block text-[12px] font-bold text-blue-500 dark:text-blue-400">${{ formatCurrency(h.currentPrice, 2) }}</span></td>
                            <td class="p-4 text-right font-black font-mono" :class="(marketData[h.symbol]?.change90d || 0) >= 0 ? 'text-up' : 'text-down'">
                                {{ (marketData[h.symbol]?.change90d || 0) >= 0 ? '+' : '' }}{{ formatCurrency(marketData[h.symbol]?.change90d, 2) }}%
                            </td>
                            <td class="p-4 text-right font-black font-mono" :class="h.unrealizedPnL >= 0 ? 'text-up' : 'text-down'">
                                ${{ formatCurrency(h.unrealizedPnL, 0) }}<span class="block text-[10px] opacity-70">{{ h.unrealizedPnLPercent }}%</span>
                            </td>
                        </tr>
                        <tr v-if="(!filteredHoldings || filteredHoldings.length === 0)"><td colspan="5" class="p-8 text-center text-slate-400 text-xs font-bold uppercase tracking-widest">æ­¤æ¿å¡Šç›®å‰ç„¡æŒå€‰</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div v-show="currentTab !== 'å…¨å±€'" class="bg-white dark:bg-slate-800 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm p-5 mb-6">
            <h3 class="font-black text-xs uppercase text-slate-500 mb-4 flex items-center gap-2">ğŸ“° æ¿å¡Šæœ€æ–°å‚¬åŒ–åŠ‘ (Live News) <span v-if="isFetchingNews" class="animate-pulse text-[10px] text-blue-500">Retrieving...</span></h3>
            <div class="space-y-3">
                <a v-for="(news, i) in sectorNews" :key="i" :href="news.link" target="_blank" class="block p-4 bg-slate-50 dark:bg-slate-900/50 hover:bg-slate-100 dark:hover:bg-slate-900 rounded-xl transition border border-slate-100 dark:border-slate-800">
                    <div class="flex items-start gap-3"><span class="bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 px-2 py-0.5 rounded text-[10px] font-black shrink-0">{{ news.symbol }}</span><div><p class="text-sm font-bold leading-snug text-slate-800 dark:text-slate-200">{{ news.title }}</p><p class="text-[10px] text-slate-400 mt-1 font-mono">{{ new Date(news.pubDate).toLocaleString() }}</p></div></div>
                </a>
                <div v-if="!isFetchingNews && sectorNews.length === 0" class="text-center text-slate-400 text-[10px] py-4 uppercase tracking-widest">æš«ç„¡æœ€æ–°æ–°è</div>
            </div>
        </div>

        <div v-show="currentTab === 'å…¨å±€'" class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-3">
                <div class="bg-white dark:bg-slate-800 rounded-[2rem] border border-slate-100 dark:border-slate-700 overflow-hidden shadow-sm">
                    <div class="p-5 bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700 flex justify-between items-center"><span class="font-black text-xs uppercase text-slate-500">ğŸ“œ æ­·å²äº¤æ˜“ç´€éŒ„</span><input v-model="searchQuery" type="text" placeholder="ğŸ” æœå°‹ä»£è™Ÿ..." class="text-xs p-1.5 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 outline-none w-28 text-center font-bold"></div>
                    <div class="overflow-y-auto no-scrollbar max-h-[600px]">
                        <table class="w-full text-sm min-w-[500px]">
                            <thead class="bg-slate-50 dark:bg-slate-900 text-[10px] text-slate-400 uppercase font-bold sticky top-0 z-10">
                                <tr><th class="p-4 text-left">æ—¥æœŸ</th><th class="p-4 text-left">æ¨™çš„</th><th class="p-4 text-center">æ“ä½œ</th><th class="p-4 text-right">å–®åƒ¹</th><th class="p-4 text-right">è‚¡æ•¸</th><th class="p-4 text-right">å¯¦ç¾æç›Š</th><th class="p-4"></th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50 dark:divide-slate-700">
                                <tr v-for="t in filteredTransactions" :key="t.id" class="hover:bg-slate-50 dark:hover:bg-slate-700 transition h-[51px]">
                                    <td class="p-4 text-[10px] text-slate-400 font-mono">{{ t.date }}</td><td class="p-4 font-black uppercase">{{ t.symbol }}</td>
                                    <td class="p-4 text-center"><span :class="t.type==='buy'?'text-blue-500 bg-blue-50 dark:bg-blue-900/50':'text-amber-500 bg-amber-50 dark:bg-amber-900/50'" class="px-2 py-0.5 rounded-lg text-[9px] font-black uppercase">{{ t.type }}</span></td>
                                    <td class="p-4 text-right font-mono">${{ formatCurrency(t.price, 2) }}</td><td class="p-4 text-right font-mono">{{ t.shares }}</td>
                                    <td class="p-4 text-right font-black font-mono" :class="t.realizedPnL >= 0 ? 'text-up' : 'text-down'"><span v-if="t.type.toLowerCase()==='sell'">${{ formatCurrency(t.realizedPnL, 0) }}</span><span v-else class="text-slate-300 dark:text-slate-600">-</span></td>
                                    <td class="p-4 text-center"><button @click="removeTransaction(t.id)" class="text-slate-300 dark:text-slate-600 hover:text-red-500 font-black">Ã—</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

           <div class="space-y-6">
                <div class="bg-white dark:bg-slate-800 shadow-2xl rounded-[2rem] border border-slate-100 dark:border-slate-700 overflow-hidden flex flex-col max-h-[800px]">
                    <div class="p-5 bg-slate-900 dark:bg-black text-white font-black text-xs uppercase flex justify-between items-center z-10 shrink-0">
                        <span>ğŸ“¢ æˆ°ç•¥å…¬å‘Šç™¼å¸ƒèˆ‡æ­·å²</span>
                    </div>
                    
                    <div class="p-5 space-y-3 bg-slate-50 dark:bg-slate-800 border-b dark:border-slate-700 shrink-0">
                        <div class="flex gap-2">
                            <input v-model="recForm.symbol" placeholder="ä»£è™Ÿ" class="w-1/2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm uppercase font-black outline-none">
                            <select v-model="recForm.type" class="w-1/2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm font-black outline-none">
                                <option value="New">å»ºå€‰</option><option value="Add">åŠ ç¢¼</option><option value="Reduce">æ¸›ç¢¼</option><option value="Clear">æ¸…å€‰</option>
                            </select>
                        </div>
                        
                        <div class="flex gap-2">
                            <input v-model.number="recForm.price" type="number" step="0.01" placeholder="ç›®æ¨™åƒ¹æ ¼" class="w-1/3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm font-mono outline-none">
                            <input v-model.number="recForm.count" type="number" placeholder="AIä¿¡å¿ƒ" class="w-1/3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm font-mono outline-none">
                            <input v-model.number="recForm.positionPct" type="number" placeholder="ä½”æ¯”(%)" class="w-1/3 bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-200 dark:border-indigo-700 p-3 rounded-xl text-sm font-black text-indigo-700 dark:text-indigo-400 outline-none">
                        </div>
                        
                        <button @click="generateAnalysis" :disabled="isGeneratingAnalysis" class="w-full py-2.5 bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300 rounded-xl text-[11px] font-black border border-purple-200 dark:border-purple-800 hover:bg-purple-200 dark:hover:bg-purple-800 transition">{{ isGeneratingAnalysis ? 'â³ Qwen æ·±åº¦é‹ç®—ä¸­...' : 'âœ¨ è‡ªå‹•ç”Ÿæˆ AI è§€é»' }}</button>
                        <textarea v-model="recForm.analysis" rows="3" placeholder="æ•˜äº‹é‚è¼¯æˆ–å‚¬åŒ–åŠ‘èªªæ˜..." class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-[11px] outline-none"></textarea>
                        <button @click="addRecommendation" class="w-full bg-slate-800 hover:bg-slate-700 text-white py-3 rounded-xl font-black text-xs shadow-lg transition">ç™¼å¸ƒè‡³å°å¤–çœ‹æ¿</button>
                    </div>

                    <div class="flex-1 overflow-y-auto no-scrollbar p-5 bg-white dark:bg-slate-800/50 space-y-4">
                        <div v-if="recommendations.length === 0" class="text-center text-slate-400 text-xs py-4">ç›®å‰å°šç„¡ç™¼å¸ƒç´€éŒ„</div>
                        
                        <div v-for="r in sortedRecommendations" :key="r.id" class="p-4 bg-slate-50 dark:bg-slate-900 rounded-2xl border border-slate-100 dark:border-slate-700 relative group">
                            <button @click="removeRecommendation(r.id)" class="absolute top-3 right-3 text-slate-300 hover:text-red-500 font-bold text-lg leading-none">&times;</button>
                            
                            <div class="flex justify-between items-center mb-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-black text-lg uppercase">{{ r.symbol }}</span>
                                    <span v-if="r.positionPct" class="px-2 py-0.5 rounded text-[10px] font-black text-slate-500 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600">{{ r.positionPct }}%</span>
                                </div>
                                <span class="px-2 py-0.5 rounded text-[9px] font-black uppercase bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 mr-4">{{ r.type }}</span>
                            </div>
                            
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-[10px] text-slate-400 font-mono">{{ r.date }}</span>
                                <span class="text-xs font-bold text-slate-600 dark:text-slate-400 mr-4">@${{ formatCurrency(r.price, 2) }}</span>
                            </div>

                            <details v-if="r.analysis" class="group/analysis outline-none cursor-pointer">
                                <summary class="text-[10px] font-black text-blue-500 hover:text-blue-600 transition outline-none list-none flex items-center gap-1 select-none">
                                    <span class="group-open/analysis:rotate-90 transition-transform duration-200">â–¶</span> æŸ¥çœ‹ AI æ·±åº¦è§£è®€
                                </summary>
                                <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700 text-[11px] text-slate-600 dark:text-slate-400 markdown-content cursor-text" v-html="marked.parse(r.analysis)"></div>
                            </details>
                        </div>
                    </div>
                </div>
        </div>

                <div class="bg-white dark:bg-slate-800 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm overflow-hidden">
                    <div class="p-5 bg-slate-50 dark:bg-slate-900 font-black text-xs uppercase text-slate-500">ğŸ“ˆ æ¯æœˆç²åˆ©</div>
                    <div class="max-h-48 overflow-y-auto divide-y divide-slate-50 dark:divide-slate-700 no-scrollbar">
                        <div v-for="s in monthlyStats" :key="s.month" class="p-4 flex justify-between text-sm"><span class="font-bold text-slate-500 uppercase">{{ s.month }}</span><span :class="s.pnl >= 0 ? 'text-up' : 'text-down'" class="font-black font-mono">{{ s.pnl >= 0 ? '+' : '' }}${{ formatCurrency(s.pnl, 0) }}</span></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end">
        <div v-if="showCopilot" class="bg-white dark:bg-slate-800 w-[350px] h-[450px] mb-4 rounded-3xl shadow-2xl border border-slate-200 dark:border-slate-700 flex flex-col overflow-hidden transition-all">
            <div class="bg-gradient-to-r from-slate-900 to-indigo-900 p-4 flex justify-between items-center text-white"><span class="font-black text-sm flex items-center gap-2">ğŸ¤– Qwen Copilot</span><button @click="showCopilot = false" class="hover:text-slate-300 text-xl leading-none">&times;</button></div>
            <div class="flex-1 p-4 overflow-y-auto bg-slate-50 dark:bg-slate-900 flex flex-col gap-3 text-sm no-scrollbar" id="chat-box">
                <div class="bg-white dark:bg-slate-800 p-3 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 dark:border-slate-700 text-slate-700 dark:text-slate-300 w-[85%] markdown-content">Bossï¼Œå››å¤§æ”¯æŸ±åˆ†æå¼•æ“å·²å°±ç·’ã€‚</div>
                <div v-for="(msg, i) in chatHistory" :key="i" class="flex flex-col w-[85%]" :class="msg.role==='user'?'self-end items-end':'self-start'"><div class="p-3 rounded-2xl shadow-sm border text-[13px]" :class="msg.role==='user'?'bg-blue-600 text-white rounded-tr-none border-blue-700':'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-tl-none border-slate-100 dark:border-slate-700 markdown-content'" v-html="msg.role==='ai'? marked.parse(msg.text) : msg.text"></div></div>
                <div v-if="isChatting" class="self-start bg-white dark:bg-slate-800 p-3 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 dark:border-slate-700 w-[60%]"><span class="animate-pulse font-bold text-blue-500 text-[10px] tracking-widest uppercase">Thinking...</span></div>
            </div>
            <div class="p-3 bg-white dark:bg-slate-800 border-t dark:border-slate-700 flex gap-2"><input v-model="chatInput" @keyup.enter="sendChat" placeholder="è©¢å•è¡Œæƒ…æˆ–ç­–ç•¥..." class="flex-1 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl px-3 outline-none text-sm"><button @click="sendChat" class="bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl px-4 py-2 font-black text-sm">â†’</button></div>
        </div>
        <button @click="showCopilot = !showCopilot" class="w-14 h-14 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition duration-300 focus:outline-none">ğŸ’¬</button>
    </div>
    
    <div v-if="showAIModal" @click.self="showAIModal=false" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-2 z-[60] transition-opacity">
        <div class="bg-white dark:bg-slate-800 rounded-[2.5rem] w-full max-w-3xl max-h-[85vh] overflow-hidden flex flex-col shadow-2xl border border-slate-200 dark:border-slate-700">
            <div class="p-5 bg-gradient-to-r from-slate-900 to-indigo-900 text-white flex justify-between items-center font-black">
                <span class="text-sm uppercase tracking-widest flex items-center gap-2">ğŸ›¡ï¸ Quantum Analysis <span class="text-[10px] bg-white/20 px-2 rounded">{{ selectedSymbol }}</span></span>
                <button @click="showAIModal=false" class="w-8 h-8 flex items-center justify-center bg-white/20 hover:bg-white/30 rounded-full transition">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 no-scrollbar bg-slate-50 dark:bg-slate-800">
                <div v-if="aiLoading" class="flex flex-col items-center py-20">
                    <div class="loader mb-4 border-t-indigo-500 border-4 w-12 h-12 rounded-full animate-spin"></div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest italic animate-pulse">Deep Thinking in Progress...</p>
                </div>
                <div v-else class="text-slate-700 dark:text-slate-300 markdown-content" v-html="marked.parse(aiContent || '')"></div>
            </div>
        </div>
    </div>

    <div v-if="showCashModal" @click.self="showCashModal=false" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[60] p-4 transition-opacity" style="display: none;" :style="{ display: showCashModal ? 'flex' : 'none' }">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl w-full max-w-xs shadow-2xl border border-slate-100 dark:border-slate-700">
            <h3 class="font-black mb-4 uppercase text-xs border-b dark:border-slate-700 pb-2">Cash Adjustment</h3>
            <div class="space-y-4">
                <input type="date" v-model="cashForm.date" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm outline-none">
                <input type="number" v-model.number="cashForm.amount" placeholder="é‡‘é¡ (è² æ•¸ç‚ºæ‰£æ¬¾)" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm font-mono outline-none">
                <input type="text" v-model="cashForm.note" placeholder="å‚™è¨»" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-3 rounded-xl text-sm font-black outline-none">
                <div class="flex gap-2 pt-2">
                    <button @click="addCashAdjustment" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-black text-xs">ç¢ºèª</button>
                    <button @click="showCashModal=false" class="flex-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 py-3 rounded-xl font-black text-xs">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, reactive, computed, onMounted, ref, watch, nextTick } = Vue;

// ğŸš¨ è«‹æ›¿æ›ç‚ºæ‚¨æœ€æ–°éƒ¨ç½²çš„ GAS ç¶²å€
const API_URL = 'https://script.google.com/macros/s/AKfycbzDjY13OL5Dxl2vgz0Wmx8-HRtUjtfeaWcnCVRO9U2GEtHq0Bj6QXwYjMKwqzB9sTph/exec'; 

createApp({
    setup() {
        // --- æ ¸å¿ƒç‹€æ…‹ ---
        const transactions = ref([]); const marketData = ref({}); const cashAdjustments = ref([]); 
        const recommendations = ref([]); const navHistoryData = ref([]); 
        
        // --- UI ç‹€æ…‹ ---
        const isSyncing = ref(false); const isReorganizing = ref(false); const isFetchingHistory = ref(false); 
        const benchmarkHistory = reactive({ symbol: '', pct30d: 0, pct90d: 0 });
        const sectorGainersData = ref({}); 
        
        const password = ref(localStorage.getItem('p_pass') || '');
        const form = reactive({ date: new Date().toISOString().split('T')[0], type: 'buy', symbol: '', price: '', shares: '' });
        
        // ğŸŸ¢ æ“´å……ï¼šåŠ å…¥ positionPct (æŒå€‰ä½”æ¯”)
        const recForm = reactive({ symbol: '', type: 'New', price: '', count: 1, positionPct: '', analysis: '' });
        
        const searchQuery = ref(''); 
        
        // ğŸ›¡ï¸ å¼·åˆ¶è¨­å®šç‚º falseï¼Œç¢ºä¿åˆå§‹ç‹€æ…‹çµ•å°ä¸æœƒè·³å‡º
        const showCashModal = ref(false); 
        const showAIModal = ref(false); 
        
        const aiLoading = ref(false); const selectedSymbol = ref(''); const aiContent = ref('');
        const cashForm = reactive({ date: new Date().toISOString().split('T')[0], amount: '', note: '' });
        const isGeneratingAnalysis = ref(false);

        const showCopilot = ref(false); const chatInput = ref(''); const chatHistory = ref([]); const isChatting = ref(false);
        const currentTab = ref('å…¨å±€'); const sectorNews = ref([]); const isFetchingNews = ref(false);
        const aiSectorMap = ref({}); const dynamicBenchmarks = ref({});

        // --- è¼”åŠ©å‡½æ•¸ ---
        const safeSetLocal = (key, val) => { try { localStorage.setItem(key, val); } catch(e) {} };
        const checkPassword = () => { if (!password.value) { const p = prompt('è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼:'); if (p) { password.value = p; safeSetLocal('p_pass', p); return true; } return false; } return true; };
        const formatCurrency = (v, d=0) => (Number(v)||0).toLocaleString('en-US', {minimumFractionDigits:d, maximumFractionDigits:d});

        const getSectorETF = (sectorName) => { return (dynamicBenchmarks.value[sectorName] && dynamicBenchmarks.value[sectorName].etf) ? dynamicBenchmarks.value[sectorName].etf : null; };
        const getSectorGainers = (sectorName) => { return (dynamicBenchmarks.value[sectorName] && dynamicBenchmarks.value[sectorName].top_gainers) ? dynamicBenchmarks.value[sectorName].top_gainers : []; };
        const getSectorInfo = (sectorName) => { return (dynamicBenchmarks.value[sectorName] && dynamicBenchmarks.value[sectorName].desc) ? { desc: dynamicBenchmarks.value[sectorName].desc } : { desc: 'è«‹é»æ“Šä¸Šæ–¹ [âœ¨ AIæ™ºèƒ½åˆ†é¡] å»ºç«‹è³‡è¨Š' }; };

        // --- åˆå§‹åŒ–è¼‰å…¥ ---
        onMounted(() => { 
            // ğŸ›¡ï¸ é›™é‡ä¿éšªï¼šç¶²é ä¸€è¼‰å…¥å°±å¼·åˆ¶é—œé–‰ modal
            showCashModal.value = false;
            showAIModal.value = false;

            const cached = localStorage.getItem('app_cache');
            if (cached) {
                try {
                    const p = JSON.parse(cached);
                    // ğŸ›¡ï¸ é˜²å‘†ï¼šç¢ºä¿å¿…å®šæ˜¯é™£åˆ—
                    transactions.value = Array.isArray(p.transactions) ? p.transactions : []; 
                    marketData.value = p.marketData||{}; cashAdjustments.value = p.cashAdjustments||[]; 
                    recommendations.value = Array.isArray(p.recommendations) ? p.recommendations : []; 
                    navHistoryData.value = Array.isArray(p.navHistory) ? p.navHistory : [];
                    if (p.aiSectorMap) aiSectorMap.value = p.aiSectorMap;
                    if (p.dynamicBenchmarks) dynamicBenchmarks.value = p.dynamicBenchmarks; 
                } catch(e) {}
            }
            if (password.value) fetchData(false); 
            if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
        });

        // --- API å‘¼å« ---
        const fetchData = async (forceAlert = false) => {
            if (!checkPassword()) return;
            isSyncing.value = true;
            try {
                const res = await fetch(`${API_URL}?action=read&password=${encodeURIComponent(password.value)}`);
                const data = await res.json();
                if (data.status === 'error') throw new Error(data.message);
                
                // ğŸ›¡ï¸ å¼·åˆ¶ç¢ºä¿å¾å¾Œç«¯æ”¶åˆ°çš„æ˜¯é™£åˆ—
                transactions.value = Array.isArray(data.transactions) ? data.transactions : []; 
                marketData.value = data.marketData || {}; 
                cashAdjustments.value = Array.isArray(data.cashAdjustments) ? data.cashAdjustments : []; 
                navHistoryData.value = Array.isArray(data.navHistory) ? data.navHistory : []; 
                recommendations.value = Array.isArray(data.recommendations) ? data.recommendations : [];
                
                if (data.dynamicBenchmarks) dynamicBenchmarks.value = data.dynamicBenchmarks;
                if (data.aiSectorMap) aiSectorMap.value = data.aiSectorMap;
                safeSetLocal('app_cache', JSON.stringify({transactions: transactions.value, marketData: marketData.value, cashAdjustments: cashAdjustments.value, recommendations: recommendations.value, navHistory: navHistoryData.value, dynamicBenchmarks: dynamicBenchmarks.value, aiSectorMap: aiSectorMap.value}));
            } catch (e) { if(forceAlert) alert(`åŒæ­¥å¤±æ•—: ${e.message}`); } finally { isSyncing.value = false; }
        };

        const saveData = async () => {
            if (!checkPassword()) return;
            if (!confirm('ç¢ºèªå„²å­˜ä¸¦è¨˜éŒ„ç•¶å‰æ·¨å€¼å—ï¼Ÿ')) return;
            try {
                const payload = { transactions: transactions.value, cashAdjustments: cashAdjustments.value, recommendations: recommendations.value, currentNav: dashboard.value.totalNav };
                const res = await fetch(`${API_URL}?action=save&password=${encodeURIComponent(password.value)}`, { method: 'POST', body: JSON.stringify(payload) });
                const d = await res.json();
                if(d.status === 'error') throw new Error(d.message);
                alert('å„²å­˜æˆåŠŸï¼'); fetchData(false);
            } catch(e) { alert(`å„²å­˜å¤±æ•—: ${e.message}`); }
        };

        // ğŸ› ï¸ èƒŒæ™¯éœé»˜å­˜æª” (å°ˆä¾›ç™¼å¸ƒæˆ°ç•¥è‡ªå‹•åŒæ­¥ä½¿ç”¨)
        const silentSave = async () => {
            if (!password.value) return;
            try {
                const payload = { transactions: transactions.value, cashAdjustments: cashAdjustments.value, recommendations: recommendations.value };
                await fetch(`${API_URL}?action=save&password=${encodeURIComponent(password.value)}`, { method: 'POST', body: JSON.stringify(payload) });
            } catch(e) {}
        };

        const runAutoSectorMap = async () => {
            if (!checkPassword()) return;
            if (!confirm('å°‡å‹•ç”¨ Qwen é‡æ–°æƒæä¸¦å®šç¾©æ‚¨çš„è¡Œæ¥­æ¿å¡Šã€ETFèˆ‡å¸‚å ´å¼·å‹¢è‚¡ã€‚\n(ç´„éœ€ 15~20 ç§’)')) return;
            isReorganizing.value = true;
            try {
                const res = await fetch(`${API_URL}?action=auto_sector_map&password=${encodeURIComponent(password.value)}`);
                const data = await res.json();
                if (data.status === 'error') throw new Error(data.message);
                alert(data.message); await fetchData(false); 
            } catch (e) { alert(`AI é‡çµ„å¤±æ•—: ${e.message}`); } finally { isReorganizing.value = false; }
        };

        // --- æ ¸å¿ƒè³‡ç”¢è¨ˆç®— ---
        const parsedTransactions = computed(() => {
            return (transactions.value || []).map(t => {
                let cleanSymbol = String(t.symbol || '').toUpperCase().trim(); 
                let sector = 'ğŸ“ æœªåˆ†é¡';
                if (cleanSymbol.includes(':')) { const parts = cleanSymbol.split(':'); sector = parts[0].trim(); cleanSymbol = parts[1].trim(); } 
                else if (aiSectorMap.value[cleanSymbol]) { sector = aiSectorMap.value[cleanSymbol]; }
                return { ...t, cleanSymbol, sector };
            });
        });

        const dashboard = computed(() => {
            let cash = 0, holdings = {}, investedAmount = 0, totalRealized = 0, totalUnrealized = 0;
            (cashAdjustments.value || []).forEach(a => cash += Number(a.amount || 0));
            
            // ğŸ›¡ï¸ å®‰å…¨æ’åºï¼šéæ¿¾ç„¡æ•ˆæ—¥æœŸ
            const safeSortedTxs = [...parsedTransactions.value].sort((a,b) => {
                let dateA = new Date(a.date).getTime(); let dateB = new Date(b.date).getTime();
                if (isNaN(dateA)) dateA = 0; if (isNaN(dateB)) dateB = 0;
                return dateA - dateB;
            });

            safeSortedTxs.forEach(t => {
                const sym = t.cleanSymbol;
                if(!sym) return; 
                if(!holdings[sym]) holdings[sym] = {symbol: sym, sector: t.sector, shares:0, totalCost:0, avgCost:0, currentPrice:0, unrealizedPnL:0};
                
                const amt = Number(t.price || 0) * Number(t.shares || 0);
                const type = String(t.type || '').toLowerCase();
                
                if (type === 'buy' || type === 'new' || type === 'add') { 
                    cash -= amt; holdings[sym].totalCost += amt; holdings[sym].shares += Number(t.shares || 0); holdings[sym].sector = t.sector; 
                } else { 
                    cash += amt; const c = holdings[sym].avgCost * Number(t.shares || 0); totalRealized += (amt - c); holdings[sym].totalCost -= c; holdings[sym].shares -= Number(t.shares || 0); 
                }
                
                if(holdings[sym].shares > 0) holdings[sym].avgCost = holdings[sym].totalCost / holdings[sym].shares;
                else { holdings[sym].avgCost = 0; holdings[sym].totalCost = 0; }
            });

            for(let s in holdings) {
                if(holdings[s].shares > 0) {
                    investedAmount += holdings[s].totalCost; 
                    holdings[s].currentPrice = marketData.value[s] ? (Number(marketData.value[s].price) || 0) : 0; 
                    holdings[s].unrealizedPnL = (holdings[s].currentPrice * holdings[s].shares) - holdings[s].totalCost;
                    holdings[s].unrealizedPnLPercent = holdings[s].totalCost > 0 ? ((holdings[s].unrealizedPnL / holdings[s].totalCost) * 100).toFixed(2) : 0;
                    totalUnrealized += holdings[s].unrealizedPnL; 
                }
            }
            return { cash, holdings, investedAmount, totalRealized, totalUnrealized, totalNav: cash + investedAmount + totalUnrealized };
        });

        const sectorList = computed(() => {
            if (!dashboard.value || !dashboard.value.holdings) return [];
            const sectors = {};
            Object.values(dashboard.value.holdings).forEach(h => { if (h.shares > 0) sectors[h.sector] = (sectors[h.sector] || 0) + 1; });
            return Object.keys(sectors).map(name => ({ name, count: sectors[name] })).sort((a, b) => {
                if(a.name.includes('æœªåˆ†é¡')) return 1; if(b.name.includes('æœªåˆ†é¡')) return -1;
                return b.count - a.count;
            });
        });

        const filteredHoldings = computed(() => {
            if (!dashboard.value || !dashboard.value.holdings) return [];
            const allHoldings = Object.values(dashboard.value.holdings).filter(h => h.shares > 0);
            if (currentTab.value === 'å…¨å±€') return allHoldings;
            return allHoldings.filter(h => h.sector === currentTab.value);
        });

        const currentSectorStats = computed(() => {
            if (currentTab.value === 'å…¨å±€' || !filteredHoldings.value) return null;
            let totalValue = 0;
            filteredHoldings.value.forEach(h => { const val = h.shares * h.currentPrice; totalValue += val; });
            const weightPercent = (dashboard.value && dashboard.value.totalNav > 0) ? ((totalValue / dashboard.value.totalNav) * 100).toFixed(1) : 0;
            return { totalValue, weightPercent };
        });

        // --- è¦–åœ–åˆ‡æ›èˆ‡è³‡æ–™æŠ“å– ---
        watch(currentTab, async (newTab) => {
            if (newTab === 'å…¨å±€') { sectorNews.value = []; return; }
            
            const etf = getSectorETF(newTab);
            const gainers = getSectorGainers(newTab);
            const symbolsToFetch = [];
            if(etf) symbolsToFetch.push(etf);
            if(gainers && gainers.length > 0) symbolsToFetch.push(...gainers);

            if(symbolsToFetch.length > 0) {
                isFetchingHistory.value = true;
                try {
                    const res = await fetch(`${API_URL}?action=get_history&symbols=${encodeURIComponent(JSON.stringify(symbolsToFetch))}&password=${encodeURIComponent(password.value)}`);
                    const data = await res.json();
                    if(data.status === 'success') {
                        if(etf && data.data[etf]) {
                            benchmarkHistory.symbol = etf; 
                            benchmarkHistory.pct30d = data.data[etf].pct30d || 0;
                            benchmarkHistory.pct90d = data.data[etf].pct90d || 0;
                        }
                        sectorGainersData.value = {}; 
                        if(gainers) {
                            gainers.forEach(sym => { if(data.data[sym]) sectorGainersData.value[sym] = data.data[sym]; });
                        }
                    }
                } catch(e) {} finally { isFetchingHistory.value = false; }
            } else { benchmarkHistory.symbol = ''; sectorGainersData.value = {}; }

            sectorNews.value = []; isFetchingNews.value = true;
            const topSymbols = [...filteredHoldings.value].sort((a,b) => (b.shares*b.currentPrice) - (a.shares*a.currentPrice)).slice(0, 3).map(h => h.symbol);
            try {
                for (const sym of topSymbols) {
                    const rssUrl = encodeURIComponent(`https://news.google.com/rss/search?q=${sym}+stock+news&hl=en-US&gl=US&ceid=US:en`);
                    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${rssUrl}`);
                    const data = await res.json();
                    if (data.status === 'ok' && data.items) { data.items.slice(0, 2).forEach(item => { sectorNews.value.push({ symbol: sym, title: item.title, link: item.link, pubDate: item.pubDate }); }); }
                }
                sectorNews.value.sort((a,b) => new Date(b.pubDate) - new Date(a.pubDate));
            } catch(e) {} finally { isFetchingNews.value = false; }
        });

        // --- AI åŠ©ç†èˆ‡åˆ†æ ---
        const sendChat = async () => {
            if(!chatInput.value.trim() || isChatting.value) return;
            const text = chatInput.value; chatHistory.value.push({ role: 'user', text }); chatInput.value = ''; isChatting.value = true;
            nextTick(() => { const b = document.getElementById('chat-box'); b.scrollTop = b.scrollHeight; });
            let pStr = `ç¾é‡‘: $${dashboard.value.cash.toFixed(0)}\næŒå€‰: `;
            Object.keys(dashboard.value.holdings).forEach(s => { if(dashboard.value.holdings[s].shares > 0) pStr += `${s}(${dashboard.value.holdings[s].shares}è‚¡), `; });
            try {
                const r = await fetch(`${API_URL}?action=copilot&msg=${encodeURIComponent(text)}&context=${encodeURIComponent(pStr)}&password=${encodeURIComponent(password.value)}`);
                const d = await r.json(); chatHistory.value.push({ role: 'ai', text: d.reply });
            } catch(e) { chatHistory.value.push({ role: 'ai', text: 'é€£ç·šä¸­æ–·ï¼Œè«‹é‡è©¦ã€‚' }); }
            finally { isChatting.value = false; nextTick(() => { const b = document.getElementById('chat-box'); b.scrollTop = b.scrollHeight; }); }
        };

        const openAIModal = async (s) => { selectedSymbol.value = s; showAIModal.value = true; aiLoading.value = true; aiContent.value = ''; try { const r = await fetch(`${API_URL}?action=analyze&symbol=${encodeURIComponent(s)}&password=${encodeURIComponent(password.value)}`); const d = await r.json(); aiContent.value = d.analysis; } catch(e) { aiContent.value = `âŒ è®€å–å¤±æ•—: ${e.message}`; } finally { aiLoading.value = false; } };
        const generateAnalysis = async () => { if (!recForm.symbol) return alert('è«‹å…ˆè¼¸å…¥ä»£è™Ÿï¼'); if (!checkPassword()) return; isGeneratingAnalysis.value = true; try { const r = await fetch(`${API_URL}?action=analyze&symbol=${encodeURIComponent(recForm.symbol)}&password=${encodeURIComponent(password.value)}`); const d = await r.json(); recForm.analysis = d.report || d.analysis || JSON.stringify(d); } catch(e) { alert(`AI ç”Ÿæˆå¤±æ•—`); } finally { isGeneratingAnalysis.value = false; } };

        // --- åœ–è¡¨æ¸²æŸ“ ---
        let pieChart = null; let lineChart = null;
        const renderChart = () => {
            if (currentTab.value !== 'å…¨å±€') return;
            setTimeout(() => {
                const isDark = document.documentElement.classList.contains('dark'); const txtColor = isDark ? '#cbd5e1' : '#64748b';
                
                const ctxPie = document.getElementById('allocationChart'); 
                if(ctxPie && dashboard.value && dashboard.value.holdings) {
                    if(pieChart) pieChart.destroy();
                    const validHoldings = Object.entries(dashboard.value.holdings).filter(([k, v]) => v.shares > 0);
                    if(validHoldings.length > 0) { pieChart = new Chart(ctxPie, { type: 'doughnut', data: { labels: validHoldings.map(h => h[0]), datasets: [{ data: validHoldings.map(h => h[1].totalCost), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#f43f5e', '#14b8a6'], borderWidth: isDark? 0 : 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '75%' } }); }
                }
                
                const ctxLine = document.getElementById('navChart');
                // ğŸ›¡ï¸ é˜²å‘†ï¼šç¢ºä¿æ­·å²æ·¨å€¼é™£åˆ—å­˜åœ¨å†ç•«åœ–
                if(ctxLine && navHistoryData.value && Array.isArray(navHistoryData.value) && navHistoryData.value.length > 0) {
                    if(lineChart) lineChart.destroy();
                    const history = [...navHistoryData.value].sort((a,b) => {
                        let dateA = new Date(a.date || a.Date).getTime(); let dateB = new Date(b.date || b.Date).getTime();
                        if (isNaN(dateA)) dateA = 0; if (isNaN(dateB)) dateB = 0;
                        return dateA - dateB;
                    });
                    const labels = history.map(h => { let dStr = String(h.date || h.Date || ''); return dStr.length > 5 ? dStr.substring(5) : dStr; });
                    const dataPoints = history.map(h => Number(h.nav || h.NAV || 0));

                    lineChart = new Chart(ctxLine, { type: 'line', data: { labels: labels, datasets: [{ label: 'Total NAV', data: dataPoints, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', borderWidth: 3, fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: txtColor } }, y: { ticks: { color: txtColor } } } } });
                }
            }, 100);
        };
        watch(() => [dashboard.value?.holdings, navHistoryData.value, currentTab.value], renderChart, { deep: true });
        const toggleDarkMode = () => { document.documentElement.classList.toggle('dark'); safeSetLocal('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); renderChart(); };

        // --- è¡¨å–®æ“ä½œ ---
        const addTransaction = () => { if(!form.symbol) return; transactions.value.push({id:Date.now(), ...form, symbol: form.symbol.toUpperCase()}); form.symbol=''; form.price=''; form.shares=''; };
        const removeTransaction = (id) => { if(confirm('åˆªé™¤äº¤æ˜“ï¼Ÿ')) transactions.value = transactions.value.filter(t=>t.id!==id); };
        const addCashAdjustment = () => { if(!cashForm.amount) return; cashAdjustments.value.push({id:Date.now(), ...cashForm}); showCashModal.value=false; cashForm.amount=''; cashForm.note=''; };
        
        // ğŸŸ¢ æ“´å……ï¼šç™¼å¸ƒæˆ°ç•¥æ™‚åŠ å…¥ positionPct ä¸¦éœé»˜å­˜æª”
        const addRecommendation = async () => { 
            if(!recForm.symbol) return; 
            const newRec = { 
                id:Date.now(), date:new Date().toISOString().split('T')[0], 
                symbol:recForm.symbol.toUpperCase(), type:recForm.type, 
                price:recForm.price, count:recForm.count, 
                positionPct:recForm.positionPct, // å¯«å…¥ä½”æ¯”
                analysis:recForm.analysis 
            }; 
            recommendations.value.push(newRec); 
            recForm.symbol=''; recForm.analysis=''; recForm.count=1; recForm.positionPct=''; // æ¸…ç©º
            await silentSave(); 
        };
        const removeRecommendation = async (id) => { if(confirm('åˆªé™¤é€™ç­†æˆ°ç•¥ç™¼å¸ƒï¼Ÿ')) { recommendations.value = recommendations.value.filter(r=>r.id!==id); await silentSave(); } };
        
        // --- ğŸ›¡ï¸ å¼·åŒ–å®¹éŒ¯ç‰ˆï¼šæ­·å²äº¤æ˜“æç›Šèˆ‡æœˆä»½çµ±è¨ˆ ---
        const sortedTransactions = computed(() => {
            let historySim = {};
            
            let txs = [...(transactions.value || [])].sort((a,b) => {
                let dateA = new Date(a.date).getTime(); let dateB = new Date(b.date).getTime();
                if (isNaN(dateA)) dateA = 0; if (isNaN(dateB)) dateB = 0;
                return dateA - dateB;
            });
            
            let enrichedTxs = txs.map(t => {
                const sym = String(t.symbol || '').toUpperCase().trim(); 
                if(!sym) return {...t, realizedPnL: 0};
                
                if(!historySim[sym]) historySim[sym] = { shares: 0, totalCost: 0, avg: 0 };
                
                let currentTxPnL = 0; 
                let type = String(t.type || '').toLowerCase().trim();
                let price = Number(t.price || 0); let shares = Number(t.shares || 0);

                if(type === 'buy' || type === 'add' || type === 'new') { 
                    historySim[sym].totalCost += price * shares; 
                    historySim[sym].shares += shares; 
                    if(historySim[sym].shares > 0) historySim[sym].avg = historySim[sym].totalCost / historySim[sym].shares; 
                } 
                else if (type === 'sell' || type === 'reduce' || type === 'clear') { 
                    currentTxPnL = (price - historySim[sym].avg) * shares; 
                    historySim[sym].totalCost -= historySim[sym].avg * shares; 
                    historySim[sym].shares -= shares; 
                    if(historySim[sym].shares <= 0) { historySim[sym].avg = 0; historySim[sym].totalCost = 0; }
                }
                
                let safeDate = t.date;
                if (!safeDate || safeDate === '') { try { safeDate = new Date(t.id).toISOString().split('T')[0]; } catch(e) { safeDate = 'æœªçŸ¥æ—¥æœŸ'; } }
                return {...t, date: safeDate, realizedPnL: currentTxPnL};
            });
            return enrichedTxs.reverse();
        });

        const filteredTransactions = computed(() => { if(!searchQuery.value) return sortedTransactions.value; return sortedTransactions.value.filter(t => String(t.symbol || '').includes(searchQuery.value.toUpperCase())); });
        
        const monthlyStats = computed(() => { 
            const statsMap = {}; 
            sortedTransactions.value.forEach(t => { 
                let type = String(t.type || '').toLowerCase();
                if((type === 'sell' || type === 'reduce' || type === 'clear') && t.realizedPnL !== undefined) { 
                    try {
                        let safeDate = String(t.date || '');
                        if(safeDate && safeDate.length >= 7) {
                            const monthKey = safeDate.substring(0, 7); 
                            statsMap[monthKey] = (statsMap[monthKey] || 0) + t.realizedPnL; 
                        }
                    } catch(e){}
                } 
            }); 
            return Object.keys(statsMap).sort().reverse().map(m => ({ month: m, pnl: statsMap[m] })); 
        });

        return { 
            dashboard, form, cashForm, recForm, transactions, cashAdjustments, recommendations, sortedTransactions, filteredTransactions, searchQuery, monthlyStats,
            sortedCash: computed(()=>[...cashAdjustments.value].reverse()), 
            sortedRecommendations: computed(()=>[...recommendations.value].sort((a,b)=>new Date(b.date)-new Date(a.date))), 
            fetchData, saveData, toggleDarkMode, openAIModal, generateAnalysis, addRecommendation, addTransaction, removeTransaction, addCashAdjustment, removeRecommendation, 
            isGeneratingAnalysis, showAIModal, showCashModal, aiLoading, aiContent, selectedSymbol, formatCurrency, isSyncing, marked,
            currentTab, sectorList, filteredHoldings, currentSectorStats, getSectorInfo, sectorNews, isFetchingNews, dynamicBenchmarks, aiSectorMap, runAutoSectorMap, isReorganizing, getSectorGainers, isFetchingHistory, benchmarkHistory, sectorGainersData,
            showCopilot, chatInput, chatHistory, sendChat, isChatting, marketData
        };
    }
}).mount('#app');
</script>
</body>
</html>
