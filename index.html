<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ç¾è‚¡ç®¡ç†">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2534/2534433.png">

    <title>ç¾è‚¡æŠ•è³‡ç®¡ç†ç³»çµ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    
    <style>
        :root {
            --ios-safe-top: env(safe-area-inset-top);
            --ios-safe-bottom: env(safe-area-inset-bottom);
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f8fafc; 
            color: #334155; 
            -webkit-tap-highlight-color: transparent;
            padding-top: var(--ios-safe-top);
            padding-bottom: var(--ios-safe-bottom);
        }

        .text-up { color: #16a34a; } 
        .text-down { color: #dc2626; } 
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* æ»¾å‹•æ¢ç¾åŒ– */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        /* iPhone APP æ„ŸæŒ‰éˆ•åé¥‹ */
        button:active { transform: scale(0.97); opacity: 0.8; transition: 0.1s; }

        /* Markdown å°æ¨£å¼ */
        .markdown-content p { margin-bottom: 8px; }
        .markdown-content ul { list-style-type: disc; padding-left: 1.2rem; margin-bottom: 8px; }

        @media (min-width: 1024px) {
            .app-container { max-width: 1200px; margin: 0 auto; }
        }
    </style>
</head>
<body class="p-3 md:p-8">
<div id="app" class="app-container pb-24">
    
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 px-1">
        <div>
            <h1 class="text-xl md:text-2xl font-black tracking-tight flex items-center gap-2">
                ç¾è‚¡ç®¡ç† <span class="text-[10px] md:text-xs bg-blue-600 text-white px-2 py-0.5 rounded font-bold">PRO v1.10</span>
            </h1>
            <p v-if="isLoading" class="text-blue-500 text-[10px] md:text-xs mt-1 animate-pulse font-bold tracking-widest uppercase">Syncing Cloud Data...</p>
        </div>
        <div class="flex w-full md:w-auto gap-2">
            <button @click="fetchData" class="flex-1 md:flex-none px-5 py-2.5 bg-white border border-slate-200 rounded-2xl shadow-sm text-sm font-bold hover:bg-slate-50 transition">ğŸ”„ åŒæ­¥</button>
            <button @click="saveData" class="flex-1 md:flex-none px-5 py-2.5 bg-slate-900 text-white rounded-2xl shadow-lg text-sm font-bold hover:bg-slate-800 transition">ğŸ’¾ å„²å­˜</button>
        </div>
    </header>

    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
        <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
            <p class="text-[10px] text-slate-400 font-black uppercase tracking-tighter">å¯ç”¨ç¾é‡‘</p>
            <div class="flex items-baseline gap-1 flex-wrap mt-1">
                <p class="text-lg md:text-xl font-black">${{ formatCurrency(dashboard.cash) }}</p>
                <button @click="showCashModal = true" class="text-[10px] text-blue-500 font-bold underline">èª¿ç¯€</button>
            </div>
        </div>
        <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
            <p class="text-[10px] text-slate-400 font-black uppercase tracking-tighter">æŒå€‰æˆæœ¬</p>
            <p class="text-lg md:text-xl font-black mt-1">${{ formatCurrency(dashboard.investedAmount) }}</p>
        </div>
        <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
            <p class="text-[10px] text-slate-400 font-black uppercase tracking-tighter">å·²å¯¦ç¾æç›Š</p>
            <p class="text-lg md:text-xl font-black mt-1" :class="dashboard.totalRealized >= 0 ? 'text-up' : 'text-down'">
                {{ dashboard.totalRealized >= 0 ? '+' : '' }}${{ formatCurrency(dashboard.totalRealized) }}
            </p>
        </div>
        <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
            <p class="text-[10px] text-slate-400 font-black uppercase tracking-tighter">æœªå¯¦ç¾æç›Š</p>
            <p class="text-lg md:text-xl font-black mt-1" :class="dashboard.totalUnrealized >= 0 ? 'text-up' : 'text-down'">
                {{ dashboard.totalUnrealized >= 0 ? '+' : '' }}${{ formatCurrency(dashboard.totalUnrealized) }}
            </p>
        </div>
        <div class="bg-blue-600 p-4 rounded-3xl shadow-xl shadow-blue-100 col-span-2 md:col-span-1 text-center md:text-left">
            <p class="text-[10px] text-blue-100 font-bold uppercase tracking-tighter">ç¸½æ·¨è³‡ç”¢</p>
            <p class="text-xl font-black text-white mt-1">${{ formatCurrency(dashboard.cash + dashboard.investedAmount + dashboard.totalUnrealized) }}</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        
        <div class="lg:col-span-3 space-y-6">
            
            <div class="bg-white rounded-[2rem] border border-slate-100 overflow-hidden shadow-sm">
                <div class="p-5 bg-slate-50 border-b font-black text-xs uppercase tracking-widest text-slate-500">ç•¶å‰æŒå€‰ (Positions)</div>
                <div class="overflow-x-auto no-scrollbar">
                    <table class="w-full text-sm min-w-[700px] md:min-w-full">
                        <thead class="bg-slate-50 text-slate-400 text-[10px] uppercase font-bold">
                            <tr>
                                <th class="p-4 text-left">æ¨™çš„</th>
                                <th class="p-4 text-right">è‚¡æ•¸</th>
                                <th class="p-4 text-right text-blue-600">ç¾åƒ¹</th>
                                <th class="p-4 text-right">å‡åƒ¹</th>
                                <th class="p-4 text-right">ç¸½æˆæœ¬</th> <th class="p-4 text-right">æœªå¯¦ç¾æç›Š</th>
                                <th class="p-4 text-center">AI</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            <tr v-for="(h, sym) in dashboard.holdings" :key="sym" v-show="h.shares > 0" class="hover:bg-slate-50/50 transition">
                                <td class="p-4 font-black text-slate-800">{{ sym }}</td>
                                <td class="p-4 text-right font-medium">{{ h.shares }}</td>
                                <td class="p-4 text-right font-black text-blue-600 font-mono">${{ formatCurrency(h.currentPrice, 2) }}</td>
                                <td class="p-4 text-right text-slate-400 font-mono">${{ formatCurrency(h.avgCost, 2) }}</td>
                                <td class="p-4 text-right text-slate-400 font-mono">${{ formatCurrency(h.totalCost, 0) }}</td> <td class="p-4 text-right font-black" :class="h.unrealizedPnL >= 0 ? 'text-up' : 'text-down'">
                                    <span class="font-mono">${{ formatCurrency(h.unrealizedPnL, 0) }}</span>
                                    <span class="text-[9px] block opacity-70">{{ h.unrealizedPnLPercent }}%</span>
                                </td>
                                <td class="p-4 text-center">
                                    <button @click="openAIModal(sym)" class="bg-blue-50 text-blue-600 text-[10px] font-black px-3 py-1.5 rounded-xl border border-blue-100">è§£è®€</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm">
                <h2 class="text-[10px] font-black mb-4 uppercase tracking-[0.2em] text-slate-400">Add Transaction</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <input type="date" v-model="form.date" class="border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-blue-100 col-span-2 md:col-span-1">
                    <select v-model="form.type" class="border-slate-200 rounded-xl p-3 text-sm font-black bg-white appearance-none"><option value="buy">è²·å…¥ Buy</option><option value="sell">è³£å‡º Sell</option></select>
                    <input type="text" v-model="form.symbol" placeholder="ä»£è™Ÿ" class="border-slate-200 rounded-xl p-3 text-sm uppercase font-black">
                    <input type="number" step="0.01" v-model.number="form.price" placeholder="å–®åƒ¹" class="border-slate-200 rounded-xl p-3 text-sm font-mono">
                    <input type="number" v-model.number="form.shares" placeholder="è‚¡æ•¸" class="border-slate-200 rounded-xl p-3 text-sm font-mono">
                    <button @click="addTransaction" class="col-span-2 md:col-span-5 bg-blue-600 text-white p-3.5 rounded-2xl font-black text-sm hover:bg-blue-700 shadow-lg shadow-blue-100 transition">ç¢ºèªæ–°å¢ç´€éŒ„</button>
                </div>
            </div>

            <div class="bg-white rounded-[2rem] border border-slate-100 overflow-hidden shadow-sm">
                <div class="p-5 bg-slate-50 border-b flex justify-between items-center">
                    <span class="font-black text-xs uppercase tracking-widest text-slate-500">æ­·å²äº¤æ˜“ç´°ç¯€ (æœ€è¿‘ 14 ç­†)</span>
                    <span class="text-[9px] font-bold text-slate-300 italic">Scroll to explore history</span>
                </div>
                <div class="overflow-y-auto no-scrollbar max-h-[720px]">
                    <table class="w-full text-sm min-w-[500px] md:min-w-full">
                        <thead class="bg-slate-50 text-[10px] text-slate-400 uppercase font-bold sticky top-0 z-10">
                            <tr>
                                <th class="p-4 text-left">æ—¥æœŸ</th>
                                <th class="p-4 text-left">æ¨™çš„</th>
                                <th class="p-4 text-center">æ“ä½œ</th>
                                <th class="p-4 text-right">å–®åƒ¹</th>
                                <th class="p-4 text-right">è‚¡æ•¸</th>
                                <th class="p-4 text-right">å·²å¯¦ç¾æç›Š</th>
                                <th class="p-4"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            <tr v-for="t in sortedTransactions" :key="t.id" class="hover:bg-slate-50/50 transition h-[51px]">
                                <td class="p-4 text-[10px] text-slate-400 font-mono">{{ t.date }}</td>
                                <td class="p-4 font-black text-slate-700 uppercase">{{ t.symbol }}</td>
                                <td class="p-4 text-center"><span :class="t.type==='buy'?'text-blue-600 bg-blue-50':'text-amber-600 bg-amber-50'" class="px-2 py-0.5 rounded-lg text-[9px] font-black uppercase border border-current opacity-80">{{ t.type }}</span></td>
                                <td class="p-4 text-right font-mono">${{ formatCurrency(t.price, 2) }}</td>
                                <td class="p-4 text-right font-mono">{{ t.shares }}</td>
                                <td class="p-4 text-right font-black" :class="t.realizedPnL >= 0 ? 'text-up' : 'text-down'">
                                    <span v-if="t.type.toLowerCase()==='sell'" class="font-mono">${{ formatCurrency(t.realizedPnL, 0) }}</span><span v-else class="text-slate-200">-</span>
                                </td>
                                <td class="p-4 text-center"><button @click="removeTransaction(t.id)" class="text-slate-200 hover:text-red-500 font-black px-2">Ã—</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-white rounded-[2rem] border border-slate-100 overflow-hidden shadow-sm">
                <div class="p-5 bg-slate-50 border-b font-black text-xs uppercase tracking-widest text-slate-500">ğŸ’µ ç¾é‡‘æ˜ç´°</div>
                <div class="max-h-48 overflow-y-auto divide-y divide-slate-50 no-scrollbar">
                    <div v-for="c in sortedCash" :key="c.id" class="p-4 flex justify-between items-center text-sm">
                        <div class="max-w-[60%]">
                            <p class="font-black text-slate-700 truncate text-xs">{{ c.note }}</p>
                            <p class="text-[10px] text-slate-400 font-mono">{{ c.date }}</p>
                        </div>
                        <span :class="c.amount >= 0 ? 'text-blue-600' : 'text-red-600'" class="font-black text-xs font-mono">
                            {{ c.amount >= 0 ? '+' : '' }}${{ formatCurrency(c.amount, 0) }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-[2rem] shadow-2xl shadow-slate-200 border border-slate-100 overflow-hidden">
                <div class="p-5 bg-slate-900 text-white font-black text-xs uppercase tracking-widest">ğŸ“¢ AI æŠ•è³‡ç™¼å¸ƒ</div>
                <div class="p-5 bg-slate-50/50 border-b space-y-3">
                    <input v-model="recForm.symbol" placeholder="ä»£è™Ÿ (NVDA)" class="w-full border-slate-200 p-3 rounded-xl text-sm uppercase font-black outline-none focus:ring-2 focus:ring-blue-100">
                    <div class="flex gap-2">
                        <select v-model="recForm.type" class="w-1/2 border-slate-200 p-3 rounded-xl text-sm font-black bg-white appearance-none"><option value="Buy">è²·å…¥</option><option value="Sell">è³£å‡º</option></select>
                        <input v-model.number="recForm.price" step="0.01" type="number" placeholder="å»ºè­°åƒ¹" class="w-1/2 border-slate-200 p-3 rounded-xl text-sm font-mono">
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-slate-400 font-black uppercase">AI åƒè€ƒæ•¸:</span>
                        <input v-model.number="recForm.count" type="number" class="w-full border-slate-200 p-2 rounded-xl text-xs font-mono">
                    </div>

                    <button @click="generateAnalysis" :disabled="isGeneratingAnalysis" class="w-full py-2.5 bg-purple-50 text-purple-700 rounded-xl text-[10px] font-black border border-purple-100 uppercase tracking-widest">
                        {{ isGeneratingAnalysis ? 'AI æ·±åº¦æ€è€ƒä¸­...' : 'âœ¨ ç”Ÿæˆç•¶ä¸‹ AI è§€é»' }}
                    </button>
                    <textarea v-model="recForm.analysis" placeholder="è§€é»æ‘˜è¦..." rows="2" class="w-full border-slate-200 p-3 rounded-xl text-[10px] outline-none focus:ring-1 focus:ring-blue-400"></textarea>
                    <button @click="addRecommendation" class="w-full bg-blue-600 text-white py-3 rounded-xl font-black text-xs shadow-lg shadow-blue-100 transition">ç¢ºèªç™¼å¸ƒå…¬å‘Š</button>
                </div>

                <div class="divide-y divide-slate-50 max-h-80 overflow-y-auto no-scrollbar">
                    <div v-for="r in sortedRecommendations" :key="r.id" class="p-4 relative group hover:bg-slate-50 transition">
                        <button @click="removeRecommendation(r.id)" class="absolute top-4 right-4 text-slate-200 hover:text-red-500 transition">Ã—</button>
                        <p class="font-black text-slate-800 text-sm tracking-wide">{{ r.symbol }} <span class="text-[9px] text-slate-400 font-mono ml-1">{{ r.date }}</span></p>
                        
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-[10px] font-bold" :class="r.type==='Buy'?'text-green-600':'text-red-600'">{{ r.type==='Buy'?'è²·å…¥':'è³£å‡º' }} @ ${{ r.price }}</span>
                            <span class="text-[9px] bg-orange-100 px-1.5 rounded-full text-orange-700 font-bold">AI: {{ r.count }}</span>
                        </div>

                        <div v-if="r.analysis && r.analysis.trim() !== ''" class="mt-2">
                            <button @click="r.showDetails = !r.showDetails" class="text-[9px] text-blue-500 font-black tracking-tighter flex items-center gap-1 hover:underline transition">
                                {{ r.showDetails ? 'éš±è—åˆ†æå…§å®¹' : 'æŸ¥çœ‹ AI æ·±åº¦è§€é»' }} 
                                <span>{{ r.showDetails ? 'â–²' : 'â–¼' }}</span>
                            </button>
                            <div v-if="r.showDetails" class="mt-2 text-[10px] bg-slate-100/50 p-3 rounded-xl leading-relaxed markdown-content text-slate-600 shadow-inner" v-html="marked.parse(r.analysis)"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showAIModal" class="fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center p-2 z-[60]">
        <div class="bg-white rounded-[2.5rem] w-full max-w-2xl max-h-[85vh] overflow-hidden flex flex-col shadow-2xl">
            <div class="p-6 bg-slate-900 text-white flex justify-between items-center font-black border-b border-white/10">
                <span class="text-sm uppercase tracking-widest">ğŸ¤– Stock Analysis Terminal</span>
                <button @click="showAIModal=false" class="w-10 h-10 flex items-center justify-center bg-white/10 rounded-full active:bg-white/20">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 no-scrollbar bg-white">
                <div v-if="aiLoading" class="flex flex-col items-center py-20">
                    <div class="loader mb-4 border-t-blue-600 border-4 w-10 h-10"></div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest italic">Analyzing Market Sentiment...</p>
                </div>
                <div v-else class="prose prose-slate max-w-none text-slate-600 text-sm leading-relaxed markdown-content" v-html="marked.parse(aiContent)"></div>
            </div>
        </div>
    </div>

    <div v-if="showCashModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[60] p-4">
        <div class="bg-white p-7 rounded-[2.5rem] w-full max-w-xs shadow-2xl border border-slate-100">
            <h3 class="font-black mb-6 uppercase text-xs tracking-[0.2em] text-slate-400 text-center">Cash Management</h3>
            <div class="space-y-4">
                <input type="date" v-model="cashForm.date" class="w-full border-slate-200 p-3.5 rounded-xl text-sm outline-none">
                <input type="number" v-model.number="cashForm.amount" placeholder="é‡‘é¡ (æ­£ç‚ºå…¥é‡‘ï¼Œè² ç‚ºæ‰£æ¬¾)" class="w-full border-slate-200 p-3.5 rounded-xl text-sm font-mono">
                <input type="text" v-model="cashForm.note" placeholder="å‚™è¨» (å­˜æ¬¾/è‚¡æ¯/å‡ºé‡‘)" class="w-full border-slate-200 p-3.5 rounded-xl text-sm font-black">
                <div class="flex gap-3 pt-2">
                    <button @click="addCashAdjustment" class="flex-1 bg-blue-600 text-white py-3.5 rounded-2xl font-black text-xs shadow-lg shadow-blue-100 transition">ç¢ºå®š</button>
                    <button @click="showCashModal=false" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-black text-xs transition">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
const { createApp, reactive, computed, onMounted, ref } = Vue;

// ğŸŸ¢ ğŸ”´ é—œéµï¼šè«‹å°‡æ‚¨çš„ Google Apps Script ç¶²å€å¡«å…¥ä¸‹æ–¹å¼•è™Ÿå…§ ğŸ”´ ğŸŸ¢
const API_URL = 'https://script.google.com/macros/s/AKfycbyXBfSISMPrZtiSt24Wsao-9V7bN5SZ_FjENs48tRiOixqzgxrac0tMa1n9F-Ril6ad/exec'; 

createApp({
    setup() {
        const transactions = ref([]);
        const currentPrices = ref({});
        const cashAdjustments = ref([]);
        const watchlist = ref([]);
        const recommendations = ref([]);
        const isLoading = ref(false);
        const isGeneratingAnalysis = ref(false);
        const password = ref(localStorage.getItem('p_pass') || '');
        const showAIModal = ref(false);
        const showCashModal = ref(false);
        const aiLoading = ref(false);
        const selectedSymbol = ref('');
        const aiContent = ref('');
        const form = reactive({ date: new Date().toISOString().split('T')[0], type: 'buy', symbol: '', price: '', shares: '' });
        const cashForm = reactive({ date: new Date().toISOString().split('T')[0], amount: '', note: '' });
        const recForm = reactive({ symbol: '', type: 'Buy', price: '', count: 1, analysis: '' });

        onMounted(() => { if (password.value) fetchData(); });

        const checkPassword = () => {
            if (!password.value) {
                const p = prompt('è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼:');
                if (p) { password.value = p; localStorage.setItem('p_pass', p); return true; }
                return false;
            }
            return true;
        };

        const fetchData = async () => {
            if (!checkPassword()) return;
            isLoading.value = true;
            try {
                const res = await fetch(`${API_URL}?action=read&password=${encodeURIComponent(password.value)}`);
                const data = await res.json();
                if (data.status === 'error') throw new Error(data.message);
                transactions.value = data.transactions || [];
                currentPrices.value = data.currentPrices || {};
                cashAdjustments.value = data.cashAdjustments || [];
                watchlist.value = data.watchlist || [];
                recommendations.value = (data.recommendations || []).map(r => ({...r, showDetails: false}));
            } catch (e) { alert(e.message); password.value = ''; localStorage.removeItem('p_pass'); } finally { isLoading.value = false; }
        };

        const saveData = async () => {
            if (!checkPassword()) return;
            if (!confirm('ç¢ºå®šå„²å­˜è®Šæ›´è‡³é›²ç«¯è©¦ç®—è¡¨ï¼Ÿ')) return;
            try {
                const cleanRecs = recommendations.value.map(({showDetails, ...rest}) => rest);
                await fetch(`${API_URL}?action=save&password=${encodeURIComponent(password.value)}`, {
                    method: 'POST', body: JSON.stringify({ transactions: transactions.value, cashAdjustments: cashAdjustments.value, watchlist: watchlist.value, recommendations: cleanRecs })
                });
                alert('é›²ç«¯æ•¸æ“šåŒæ­¥å®Œæˆ');
            } catch (e) { alert('å„²å­˜å¤±æ•—'); }
        };

        const dashboard = computed(() => {
            let cash = 0, holdings = {}, investedAmount = 0, totalRealized = 0, totalUnrealized = 0;
            cashAdjustments.value.forEach(a => cash += Number(a.amount));
            [...transactions.value].sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(t => {
                const sym = t.symbol.toUpperCase();
                if(!holdings[sym]) holdings[sym] = {shares:0, totalCost:0, avgCost:0, currentPrice:0, unrealizedPnL:0};
                const amt = Number(t.price) * Number(t.shares);
                if (t.type.toLowerCase() === 'buy') {
                    cash -= amt; holdings[sym].totalCost += amt; holdings[sym].shares += Number(t.shares);
                } else {
                    cash += amt; const costOfSold = holdings[sym].avgCost * Number(t.shares);
                    totalRealized += (amt - costOfSold);
                    holdings[sym].totalCost -= costOfSold; holdings[sym].shares -= Number(t.shares);
                }
                if(holdings[sym].shares > 0) holdings[sym].avgCost = holdings[sym].totalCost / holdings[sym].shares;
            });
            for(let s in holdings) {
                if(holdings[s].shares > 0) {
                    investedAmount += holdings[s].totalCost;
                    holdings[s].currentPrice = currentPrices.value[s] || 0;
                    holdings[s].unrealizedPnL = (holdings[s].currentPrice * holdings[s].shares) - holdings[s].totalCost;
                    holdings[s].unrealizedPnLPercent = holdings[s].totalCost > 0 ? ((holdings[s].unrealizedPnL / holdings[s].totalCost) * 100).toFixed(2) : 0;
                    totalUnrealized += holdings[s].unrealizedPnL;
                }
            }
            return { cash, holdings, investedAmount, totalRealized, totalUnrealized };
        });

        const sortedTransactions = computed(() => {
            const h = {};
            return [...transactions.value].sort((a,b)=>new Date(a.date)-new Date(b.date)).map(t => {
                const sym = t.symbol.toUpperCase(); if(!h[sym]) h[sym] = {s:0, c:0, avg:0};
                let pnl = 0; if(t.type.toLowerCase()==='buy'){ h[sym].c += Number(t.price)*Number(t.shares); h[sym].s += Number(t.shares); h[sym].avg = h[sym].c/h[sym].s; }
                else { pnl = (Number(t.price) - h[sym].avg)*Number(t.shares); h[sym].c -= h[sym].avg*Number(t.shares); h[sym].s -= Number(t.shares); }
                return {...t, realizedPnL: pnl};
            }).reverse();
        });

        const addTransaction = () => { if(!form.symbol) return; transactions.value.push({id:Date.now(), ...form, symbol: form.symbol.toUpperCase()}); form.symbol=''; form.price=''; form.shares=''; };
        const removeTransaction = (id) => { if(confirm('åˆªé™¤æ­¤ç­†äº¤æ˜“ï¼Ÿ')) transactions.value = transactions.value.filter(t=>t.id!==id); };
        const addCashAdjustment = () => { if(!cashForm.amount) return; cashAdjustments.value.push({id:Date.now(), ...cashForm}); showCashModal.value=false; cashForm.amount=''; cashForm.note=''; };
        const removeCash = (id) => { if(confirm('åˆªé™¤æ­¤ç¾é‡‘ç´€éŒ„ï¼Ÿ')) cashAdjustments.value = cashAdjustments.value.filter(c=>c.id!==id); };
        
        const addRecommendation = () => { 
            if(!recForm.symbol) return; 
            recommendations.value.push({
                id:Date.now(), 
                date:new Date().toISOString().split('T')[0], 
                ...recForm, 
                symbol:recForm.symbol.toUpperCase(), 
                showDetails:false
            }); 
            recForm.symbol=''; recForm.analysis=''; recForm.count=1; 
        };
        const removeRecommendation = (id) => { if(confirm('ç¢ºå®šåˆªé™¤æ­¤å…¬å‘Šï¼Ÿ')) recommendations.value = recommendations.value.filter(r=>r.id!==id); };
        
        const generateAnalysis = async () => {
            if (!recForm.symbol) return alert('è«‹è¼¸å…¥ä»£è™Ÿ'); isGeneratingAnalysis.value = true;
            try {
                const r = await fetch(`${API_URL}?action=analyze&symbol=${recForm.symbol}&password=${password.value}`);
                const d = await r.json(); recForm.analysis = d.analysis;
            } catch(e) { alert('AI ç”Ÿæˆå¤±æ•—'); } finally { isGeneratingAnalysis.value = false; }
        };

        const openAIModal = async (s) => { 
            selectedSymbol.value = s; showAIModal.value = true; aiLoading.value = true; aiContent.value = '';
            try {
                const r = await fetch(`${API_URL}?action=analyze&symbol=${s}&password=${password.value}`);
                const d = await r.json(); aiContent.value = d.analysis;
            } catch (e) { aiContent.value = 'è®€å–å¤±æ•—'; } finally { aiLoading.value = false; }
        };

        const formatCurrency = (v, d=0) => (v||0).toLocaleString('en-US', {minimumFractionDigits:d, maximumFractionDigits:d});

        return { 
            dashboard, form, cashForm, recForm, transactions, cashAdjustments, recommendations, 
            sortedTransactions, sortedCash: computed(()=>[...cashAdjustments.value].reverse()), 
            sortedRecommendations: computed(()=>[...recommendations.value].reverse()), 
            fetchData, saveData, addTransaction, removeTransaction, addCashAdjustment, removeCash,
            addRecommendation, removeRecommendation, formatCurrency, isLoading, isGeneratingAnalysis, 
            generateAnalysis, openAIModal, showAIModal, showCashModal, aiContent, selectedSymbol, marked,
            resetPassword:()=>{localStorage.clear();location.reload();}
        };
    }
}).mount('#app');
</script>
</body>
</html>
