<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QuantMatrix">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2534/2534433.png">

    <title>Quant Terminal v7.1</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        [v-cloak] { display: none; }
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; 
            background-color: #020617; 
            color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            overflow-x: hidden;
        }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.05); }
        .text-up { color: #10b981; } .text-down { color: #f43f5e; }
        
        /* iPhone å°ˆå±¬æ’ç‰ˆå„ªåŒ– */
        .app-main { padding-top: calc(1rem + var(--safe-top)); padding-bottom: calc(5rem + var(--safe-bottom)); }
        .sidebar-item.active { background: rgba(99, 102, 241, 0.2); border-left: 4px solid #6366f1; color: #818cf8; font-weight: 800; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .btn-action { transition: all 0.2s active:scale-95; }
        
        /* æ»¾å‹•è¡¨æ ¼è™•ç† */
        .table-container { -webkit-overflow-scrolling: touch; overflow-x: auto; }
        
        /* AI è§£æå±•é–‹æ¨£å¼ */
        details summary::-webkit-details-marker { display: none; }
        .markdown-content h3 { font-weight: 900; color: #818cf8; margin-top: 12px; }
    </style>
</head>
<body class="no-scrollbar">
<div id="app" class="flex flex-col lg:flex-row h-screen overflow-hidden" v-cloak>
    
    <aside class="hidden lg:flex w-72 glass border-r border-white/5 flex-col shrink-0">
        <div class="p-8">
            <h1 class="text-2xl font-black tracking-tighter bg-gradient-to-br from-white to-slate-500 bg-clip-text text-transparent uppercase">Quant</h1>
            <p class="text-[10px] font-black text-indigo-500 uppercase tracking-widest mt-1">Terminal Matrix v7.1</p>
        </div>
        <nav class="flex-1 px-4 space-y-1 overflow-y-auto no-scrollbar">
            <div @click="currentTab = 'å…¨å±€'" class="sidebar-item cursor-pointer p-4 rounded-xl flex items-center gap-3 transition-all" :class="{'active': currentTab === 'å…¨å±€'}">ğŸŒ å…¨å±€æˆ°ç•¥ç¸½è¦½</div>
            <div class="pt-6 pb-2 px-4 text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">è¡Œæ¥­ç‰ˆå¡Š</div>
            <div v-for="s in sectorList" @click="currentTab = s.name" class="sidebar-item cursor-pointer p-4 rounded-xl flex justify-between items-center transition-all" :class="{'active': currentTab === s.name}">
                <span class="text-sm font-bold">{{ s.name }}</span>
                <span class="text-[10px] bg-indigo-500/20 text-indigo-400 px-2.5 py-0.5 rounded-full font-mono">{{ s.count }}</span>
            </div>
        </nav>
    </aside>

    <div class="lg:hidden glass border-b border-white/5 pt-[var(--safe-top)] flex-shrink-0 z-30">
        <div class="flex overflow-x-auto no-scrollbar p-4 gap-4 items-center">
            <div @click="currentTab = 'å…¨å±€'" class="shrink-0 px-4 py-2 rounded-full text-sm font-black transition-all" :class="currentTab === 'å…¨å±€' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/20' : 'text-slate-500'">å…¨å±€</div>
            <div v-for="s in sectorList" @click="currentTab = s.name" class="shrink-0 px-4 py-2 rounded-full text-sm font-black transition-all" :class="currentTab === s.name ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/20' : 'text-slate-500'">{{ s.name }}</div>
        </div>
    </div>

    <main class="flex-1 overflow-y-auto app-main px-6 lg:px-12 no-scrollbar space-y-10">
        
        <header class="flex justify-between items-end">
            <div>
                <h2 class="text-3xl lg:text-5xl font-black tracking-tight text-white">{{ currentTab }}</h2>
                <div v-if="isSyncing" class="flex items-center gap-2 mt-2">
                   <div class="w-2 h-2 bg-indigo-500 rounded-full animate-ping"></div>
                   <p class="text-indigo-400 text-[10px] font-black uppercase tracking-widest">Live Syncing...</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button @click="fetchData(true)" class="glass p-3 rounded-2xl hover:bg-white/5 active:scale-90 transition-all">ğŸ”„</button>
                <button @click="saveData" class="bg-white text-black px-5 py-2.5 rounded-2xl text-xs font-black shadow-xl active:scale-95 transition-all">ğŸ’¾ å­˜æª”</button>
            </div>
        </header>

        <div v-if="currentTab === 'å…¨å±€'" class="space-y-10">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6">
                <div class="glass p-6 rounded-[2rem]"><p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">æŠ•è³‡å¸‚å€¼</p><p class="text-2xl font-black mt-1">${{ formatCurrency(dashboard.investedValue) }}</p></div>
                <div class="glass p-6 rounded-[2rem]"><p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">æœªå¯¦ç¾æç›Š</p><p class="text-2xl font-black mt-1" :class="dashboard.totalUnrealized >= 0 ? 'text-up' : 'text-down'">${{ formatCurrency(dashboard.totalUnrealized) }}</p></div>
                <div class="glass p-6 rounded-[2rem]"><p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">æœ¬æœˆçµç®—</p><p class="text-2xl font-black mt-1" :class="(monthlyStats[0]?.pnl||0) >= 0 ? 'text-up' : 'text-down'">${{ formatCurrency(monthlyStats[0]?.pnl||0) }}</p></div>
                <div class="bg-indigo-600 border border-indigo-400/30 p-6 rounded-[2rem] relative overflow-hidden"><p class="text-[10px] font-black text-white/70 uppercase">è³‡ç”¢æ·¨å€¼ (NAV)</p><p class="text-2xl font-black mt-1 text-white">${{ formatCurrency(dashboard.totalNav) }}</p></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass p-8 rounded-[2.5rem]">
                    <h3 class="text-[10px] font-black uppercase text-slate-500 mb-8 tracking-[0.2em]">æ ¸å¿ƒæŒå€‰ Top 5 æ¬Šé‡</h3>
                    <div class="flex flex-col sm:flex-row items-center gap-8 lg:gap-12">
                        <canvas id="allocationChart" class="w-40 h-40"></canvas>
                        <div class="flex-1 w-full space-y-3">
                            <div v-for="(h, i) in top5Holdings" :key="h.symbol" class="flex justify-between items-center p-3.5 bg-white/5 rounded-2xl border border-white/5">
                                <div class="flex items-center gap-3"><span class="w-6 h-6 flex items-center justify-center bg-indigo-600 text-white text-[10px] font-black rounded-lg">{{i+1}}</span><span class="font-black text-sm uppercase">{{ h.symbol }}</span></div>
                                <div class="text-right"><span class="text-sm font-black">{{ h.weight }}%</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="glass p-8 rounded-[2.5rem] flex flex-col h-[350px]">
                    <h3 class="text-[10px] font-black uppercase text-slate-500 mb-8 tracking-[0.2em]">ğŸ“‰ æ¯æœˆç›ˆè™§çµç®—</h3>
                    <div class="flex-1 overflow-y-auto no-scrollbar space-y-3 pr-2">
                        <div v-for="s in monthlyStats" :key="s.month" class="flex justify-between items-center p-4 bg-black/20 rounded-2xl border border-white/5">
                            <span class="font-black text-xs opacity-50 uppercase tracking-widest">{{ s.month }}</span>
                            <span class="font-mono font-black text-lg" :class="s.pnl >= 0 ? 'text-up' : 'text-down'">${{ formatCurrency(s.pnl, 0) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass rounded-[2.5rem] overflow-hidden">
                <div class="p-8 bg-white/5 border-b border-white/5 flex justify-between items-center"><h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest">ğŸ“œ æŠ•è³‡çµ„åˆæ­·å²æ˜ç´°</h3></div>
                <div class="table-container no-scrollbar">
                    <table class="w-full text-sm text-left"><thead class="text-[10px] font-black text-slate-600 uppercase tracking-widest"><tr><th class="p-6">ä»£è™Ÿ</th><th class="p-6">é¡å‹</th><th class="p-6 text-right">å–®åƒ¹</th><th class="p-6 text-right">è‚¡æ•¸</th><th class="p-6"></th></tr></thead><tbody class="divide-y divide-white/5">
                        <tr v-for="t in filteredTransactions" :key="t.id" class="active:bg-white/5"><td class="p-6 font-black uppercase text-lg">{{ t.symbol }}<div class="text-[9px] opacity-30 font-mono mt-1">{{ t.date }}</div></td><td class="p-6"><span :class="t.type==='buy'?'text-indigo-400 bg-indigo-500/10':'text-rose-400 bg-rose-500/10'" class="px-2 py-0.5 rounded text-[9px] font-black border border-current/20 uppercase">{{ t.type }}</span></td><td class="p-6 text-right font-mono font-black">${{ formatCurrency(t.price, 2) }}</td><td class="p-6 text-right font-mono font-bold">{{ t.shares }}</td><td class="p-6 text-center"><button @click="removeTransaction(t.id)" class="text-slate-700 active:text-rose-500">Ã—</button></td></tr>
                    </tbody></table>
                </div>
            </div>

            <div class="bg-indigo-950/20 border border-indigo-500/10 p-8 lg:p-12 rounded-[3rem] space-y-10">
                <h3 class="text-[10px] font-black uppercase text-indigo-400 tracking-[0.3em]">ğŸ“¢ AI ç¶“ç†äººæˆ°ç•¥å»ºè­°ç®¡ç†</h3>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-10">
                    <div class="glass p-8 rounded-[2.5rem] space-y-5">
                        <input v-model="recForm.symbol" placeholder="æ¨™çš„ä»£è™Ÿ" class="w-full bg-black/40 border border-white/5 rounded-2xl p-4 text-sm uppercase outline-none focus:border-indigo-500">
                        <div class="flex gap-2">
                            <select v-model="recForm.type" class="flex-1 bg-black/40 border border-white/5 rounded-2xl p-4 text-xs outline-none"><option value="New">å»ºå€‰</option><option value="Add">åŠ ç¢¼</option><option value="Reduce">æ¸›ç¢¼</option><option value="Clear">æ¸…å€‰</option></select>
                            <input v-model.number="recForm.price" type="number" placeholder="ç›®æ¨™åƒ¹" class="flex-1 bg-black/40 border border-white/5 rounded-2xl p-4 text-sm">
                        </div>
                        <button @click="generateAIAnalysis" :disabled="isAnalyzing" class="w-full bg-indigo-600/20 border border-indigo-500/30 text-indigo-400 py-4 rounded-2xl text-xs font-black active:bg-indigo-600 active:text-white transition-all">{{ isAnalyzing ? 'â³ æœƒè­°ä¸­...' : 'ğŸ§  AI è‡ªå‹•æ’°å¯«' }}</button>
                        <textarea v-model="recForm.analysis" placeholder="æˆ°ç•¥æ•˜äº‹ç´°ç¯€..." class="w-full bg-black/40 border border-white/5 rounded-2xl p-4 text-xs h-32 outline-none"></textarea>
                        <button @click="addRecommendation" class="w-full bg-white text-black py-4 rounded-2xl text-xs font-black shadow-xl active:scale-95">æ­£å¼ç™¼å¸ƒè¨Šè™Ÿ</button>
                    </div>
                    <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6 h-[500px] overflow-y-auto no-scrollbar pr-2">
                        <div v-for="r in recommendations" :key="r.id" class="glass p-8 rounded-[2.5rem] relative group border-indigo-500/10">
                            <button @click="removeRecommendation(r.id)" class="absolute top-6 right-6 text-white/10 group-active:text-rose-500 font-black">Ã—</button>
                            <div class="flex justify-between items-start mb-4"><span class="font-black text-3xl uppercase tracking-tighter">{{ r.symbol }}</span><span class="bg-indigo-500 text-[8px] px-2.5 py-1 rounded-full font-black uppercase tracking-widest">{{ r.type }}</span></div>
                            <p class="text-[9px] text-slate-500 font-mono mb-4">{{ r.date }} | @${{ formatCurrency(r.price, 2) }}</p>
                            <details class="group/analysis">
                                <summary class="text-[10px] font-black text-indigo-400 cursor-pointer uppercase tracking-widest list-none flex items-center gap-2">Read Logic Analysis <span class="group-open/analysis:rotate-180 transition-transform">â–¼</span></summary>
                                <div class="mt-6 text-sm text-slate-400 leading-relaxed border-t border-white/5 pt-6 markdown-content" v-html="marked.parse(r.analysis)"></div>
                            </details>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-else class="space-y-10">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <div class="lg:col-span-3 glass p-8 rounded-[2.5rem] flex flex-col min-h-[350px]">
                    <div class="flex justify-between items-center mb-8"><span class="text-xs font-black text-indigo-400 uppercase tracking-widest">ğŸ‘‘ ç‰ˆå¡Šå°æ¨™ ETF (90D Curve)</span><span class="text-[9px] text-slate-500 px-3 py-1.5 bg-black/40 rounded-xl border border-white/5">{{ getSectorInfo(currentTab).desc }}</span></div>
                    <div class="flex-1 relative w-full bg-black/20 rounded-[2rem] border border-white/5 flex items-center justify-center overflow-hidden">
                        <canvas id="benchmarkChart"></canvas>
                        <div v-if="benchmarkHistory.symbol" class="absolute top-6 left-8"><span class="font-black text-3xl tracking-tighter">{{ benchmarkHistory.symbol }}</span><span class="ml-3 font-mono font-black text-sm px-2 py-1 rounded-xl" :class="benchmarkHistory.pctChange >= 0 ? 'text-up bg-emerald-500/10' : 'text-down bg-rose-500/10'">{{ benchmarkHistory.pctChange >= 0 ? '+' : '' }}{{ benchmarkHistory.pctChange }}%</span></div>
                    </div>
                </div>
                <div class="glass p-8 rounded-[2.5rem] flex flex-col">
                    <h3 class="text-xs font-black uppercase text-slate-500 mb-8 tracking-widest">ğŸ† è¡Œæ¥­ Alpha æ¨™çš„</h3>
                    <div class="space-y-4">
                        <div v-for="(sym, i) in getSectorGainers(currentTab)" :key="sym" class="flex justify-between items-center p-4 bg-white/5 rounded-2xl border border-white/5"><span class="font-black text-sm uppercase flex items-center gap-3"><span class="w-6 h-6 flex items-center justify-center bg-indigo-500/10 text-indigo-400 text-[10px] rounded font-mono">{{i+1}}</span> {{ sym }}</span><span class="text-[8px] font-black px-2 py-1 bg-white/5 text-slate-500 rounded uppercase">HOT</span></div>
                    </div>
                </div>
            </div>

            <div class="glass rounded-[2.5rem] overflow-hidden">
                <div class="p-8 bg-white/5 border-b border-white/5 flex justify-between items-center"><h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest">ğŸ’¼ ç‰ˆå¡ŠæŒå€‰é‡åŒ–é›·é”</h3><button v-if="currentTab === 'å…¨å±€'" @click="scanAllQuantRisk" :disabled="isScanningAll" class="bg-indigo-600 text-white px-5 py-2 rounded-xl text-[10px] font-black">Scan</button></div>
                <div class="table-container no-scrollbar">
                    <table class="w-full text-sm text-left min-w-[900px]"><thead class="text-[10px] font-black text-slate-500 uppercase tracking-widest"><tr><th class="p-8">æ¨™çš„</th><th class="p-8 text-right">ç¾åƒ¹</th><th class="p-8 text-right">æç›Š</th><th class="p-8">å§”å“¡æœƒè©•åˆ†</th><th class="p-8">ğŸ›¡ï¸ æ±ºç­–</th></tr></thead><tbody class="divide-y divide-white/5">
                        <tr v-for="h in filteredHoldings" :key="h.symbol" class="active:bg-white/5 transition-all"><td class="p-8"><div class="font-black text-2xl tracking-tighter uppercase">{{ h.symbol }}</div><div class="text-[9px] text-slate-600 font-mono mt-1 uppercase">{{ h.shares }} SHARES | {{ h.sector }}</div></td><td class="p-8 text-right font-mono font-black text-lg text-slate-400">${{ formatCurrency(h.currentPrice, 2) }}</td><td class="p-8 text-right font-black font-mono"><div :class="h.unrealizedPnL >= 0 ? 'text-up' : 'text-down'">${{ formatCurrency(h.unrealizedPnL, 0) }} <span class="text-[10px] opacity-60 ml-1">{{ h.unrealizedPnLPercent }}%</span></div></td><td class="p-8 w-72"><div v-if="quantData[h.symbol]" class="space-y-4"><div><div class="flex justify-between text-[8px] font-black mb-1.5 text-slate-500 uppercase tracking-widest"><span>æ•˜äº‹</span><span>{{quantData[h.symbol].narrative_score}}%</span></div><div class="w-full bg-white/5 rounded-full h-1"><div class="h-full bg-indigo-500" :style="{width: quantData[h.symbol].narrative_score+'%'}"></div></div></div><div><div class="flex justify-between text-[8px] font-black mb-1.5 text-slate-500 uppercase tracking-widest"><span>å‚¬åŒ–</span><span>{{quantData[h.symbol].catalyst_prob}}%</span></div><div class="w-full bg-white/5 rounded-full h-1"><div class="h-full bg-rose-500" :style="{width: quantData[h.symbol].catalyst_prob+'%'}"></div></div></div></div><span v-else class="text-[9px] text-slate-700 italic font-black">PENDING...</span></td><td class="p-8 w-60">
                            <div v-if="quantData[h.symbol]">
                                <details class="group/report">
                                    <summary class="bg-white/5 p-4 rounded-2xl text-[10px] font-black text-indigo-400 border border-white/5 leading-relaxed cursor-pointer list-none hover:bg-white/10 active:scale-95"> {{quantData[h.symbol].action_zone}} â–¼</summary>
                                    <div class="mt-4 p-5 bg-black/40 rounded-2xl text-[11px] text-slate-400 border border-white/5 leading-loose markdown-content" v-html="marked.parse('### å§”å“¡æœƒåˆ†æå ±å‘Š\n' + (quantData[h.symbol].report || 'æ•¸æ“šæ•´ç†ä¸­...'))"></div>
                                </details>
                            </div>
                        </td></tr>
                    </tbody></table>
                </div>
            </div>

            <div class="glass p-8 lg:p-12 rounded-[3rem]">
                <h3 class="text-[10px] font-black uppercase text-slate-500 mb-10 flex items-center gap-4 tracking-widest">ğŸ“° ç‰ˆå¡Šå³æ™‚æ·±åº¦è¨Šè™Ÿ (Depth Scan) <span v-if="isFetchingNews" class="animate-pulse text-indigo-400 ml-4 font-black">CRAWLING WEB...</span></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <a v-for="(news, i) in sectorNews" :key="i" :href="news.link" target="_blank" class="p-6 bg-white/5 active:bg-white/10 rounded-3xl border border-white/5">
                        <div class="flex items-start gap-5"><span class="bg-indigo-600 text-white px-2.5 py-1 rounded text-[9px] font-black uppercase shrink-0">{{ news.symbol }}</span><div><p class="text-sm font-bold text-slate-300 leading-snug">{{ news.title }}</p><p class="text-[9px] text-slate-500 mt-3 font-mono uppercase opacity-50">{{ new Date(news.pubDate).toLocaleDateString() }} | Signal #{{(i%5)+1}}</p></div></div>
                    </a>
                </div>
            </div>
        </div>

        <div class="h-20"></div>
    </main>

    <div class="fixed bottom-8 right-6 z-50">
        <transition name="fade"><div v-if="showCopilot" class="glass w-[90vw] lg:w-[420px] h-[60vh] lg:h-[650px] mb-6 rounded-[3rem] shadow-2xl border border-white/10 flex flex-col overflow-hidden"><div class="bg-indigo-600 p-6 flex justify-between items-center text-white font-black tracking-tighter"><span>ğŸ¤– STRATEGY COPILOT</span><button @click="showCopilot = false" class="text-2xl">&times;</button></div><div class="flex-1 p-8 overflow-y-auto space-y-6 no-scrollbar" id="chat-box"><div v-for="(msg, i) in chatHistory" :key="i" :class="msg.role==='user'?'text-right pl-20':'text-left pr-20'"><div class="inline-block p-5 rounded-[2rem] text-sm" :class="msg.role==='user'?'bg-indigo-600 text-white rounded-tr-none':'bg-white/5 border border-white/10 text-slate-300 shadow-sm'" v-html="marked.parse(msg.text)"></div></div></div><div class="p-6 glass border-t border-white/5 flex gap-3"><input v-model="chatInput" @keyup.enter="sendChat" placeholder="è©¢å•ç­–ç•¥åˆ†æ..." class="flex-1 bg-white/5 border-none rounded-2xl px-6 text-sm outline-none focus:bg-white/10"><button @click="sendChat" class="bg-indigo-600 text-white w-12 h-12 rounded-2xl font-black shadow-lg">â†‘</button></div></div></transition>
        <button @click="showCopilot = !showCopilot" class="w-16 h-16 bg-indigo-600 text-white rounded-[2rem] shadow-2xl flex items-center justify-center text-3xl active:scale-90 transition-all border-4 border-[#020617] focus:outline-none">ğŸ’¬</button>
    </div>
</div>

<script>
const { createApp, reactive, computed, onMounted, ref, watch, nextTick } = Vue;

const API_URL = 'https://script.google.com/macros/s/AKfycbxl_D6MTuIY4DQNrSJoxMcLo4T0Ux0Do4hVCQtLVSsXasr6YencnN7eYfQkiSxdtkeQ/exec'; 

createApp({
    setup() {
        const transactions = ref([]); const recommendations = ref([]); const marketData = ref({}); const navHistoryData = ref([]); 
        const quantData = reactive({}); const isSyncing = ref(false); const isScanningAll = ref(false); const isReorganizing = ref(false);
        const currentTab = ref('å…¨å±€'); const showCopilot = ref(false); const chatInput = ref(''); const chatHistory = ref([]); const isChatting = ref(false);
        const aiSectorMap = ref({}); const dynamicBenchmarks = ref({}); const sectorNews = ref([]); const isFetchingNews = ref(false);
        const isFetchingHistory = ref(false); const benchmarkHistory = reactive({ symbol: '', prices: [], pctChange: 0 });
        const password = ref(''); const isAnalyzing = ref(false);
        const form = reactive({ date: new Date().toISOString().split('T')[0], type: 'buy', symbol: '', price: '', shares: '' });
        const recForm = reactive({ symbol: '', type: 'New', price: '', analysis: '' });
        let pieChart, benchChartInstance;

        const safeGet = (k) => { try { return localStorage.getItem(k) || ''; } catch(e) { return ''; } };
        const safeSet = (k, v) => { try { localStorage.setItem(k, v); } catch(e) {} };

        const fetchData = async (force) => {
            if (!password.value) { const p = prompt('çµ‚ç«¯è¨ªå•å¯†ç¢¼:'); if(p) { password.value = p; safeSet('p_pass', p); } else return; }
            isSyncing.value = true;
            try {
                const res = await fetch(`${API_URL}?action=read&password=${encodeURIComponent(password.value)}`);
                const d = await res.json();
                if(d.status === 'error') throw new Error(d.message);
                transactions.value = d.transactions||[]; recommendations.value = d.recommendations||[]; marketData.value = d.marketData||{}; navHistoryData.value = d.navHistory||[];
                aiSectorMap.value = d.aiSectorMap||{}; dynamicBenchmarks.value = d.dynamicBenchmarks||{};
                if(d.quantData) Object.assign(quantData, d.quantData);
                safeSet('app_cache', JSON.stringify({tx: d.transactions, md: d.marketData, sect: d.aiSectorMap, bench: d.dynamicBenchmarks, rec: d.recommendations}));
            } catch (e) { if(force) alert("åŒæ­¥å¤±æ•—"); } finally { isSyncing.value = false; }
        };

        const dashboard = computed(() => {
            let holdings = {}, totalRealized = 0;
            const sortedTx = [...transactions.value].sort((a,b)=>new Date(a.date)-new Date(b.date));
            sortedTx.forEach(t => {
                const s = t.symbol.toUpperCase(); if(!holdings[s]) holdings[s] = {shares:0, totalCost:0};
                if(t.type === 'buy') { holdings[s].shares += Number(t.shares); holdings[s].totalCost += Number(t.price)*Number(t.shares); }
                else { 
                    const avg = holdings[s].totalCost / holdings[s].shares;
                    totalRealized += (Number(t.price) - avg) * Number(t.shares);
                    holdings[s].shares -= Number(t.shares); holdings[s].totalCost -= avg*Number(t.shares);
                }
            });
            let investedValue = 0, totalUnrealized = 0; const final = {};
            Object.keys(holdings).forEach(s => {
                const h = holdings[s]; if(h.shares > 0.001) {
                    const cur = marketData.value[s]?.price || 0; h.currentPrice = cur; h.avgCost = h.totalCost/h.shares;
                    h.unrealizedPnL = (cur*h.shares)-h.totalCost; h.unrealizedPnLPercent = ((h.unrealizedPnL/h.totalCost)*100).toFixed(2);
                    h.symbol = s; h.sector = aiSectorMap.value[s] || 'ğŸ“ æœªåˆ†é¡';
                    investedValue += cur*h.shares; totalUnrealized += h.unrealizedPnL; final[s] = h;
                }
            });
            return { holdings: final, investedValue, totalUnrealized, totalRealized, totalNav: investedValue };
        });

        const monthlyStats = computed(() => {
            const stats = {}; const active = {};
            [...transactions.value].sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(t => {
                const s = t.symbol; if(!active[s]) active[s] = {q:0, c:0};
                if(t.type==='buy') { active[s].q += t.shares; active[s].c += t.price*t.shares; }
                else { const avg = active[s].c / active[s].q; const pnl = (t.price - avg) * t.shares; const m = t.date.substring(0, 7); stats[m] = (stats[m] || 0) + pnl; active[s].q -= t.shares; active[s].c -= avg*t.shares; }
            });
            return Object.keys(stats).sort().reverse().map(m => ({ month: m, pnl: stats[m] }));
        });

        const top5Holdings = computed(() => Object.values(dashboard.value.holdings).map(h => ({ symbol: h.symbol, val: h.shares*h.currentPrice, weight: ((h.shares*h.currentPrice)/dashboard.value.totalNav*100).toFixed(1), unrealizedPnL: h.unrealizedPnL })).sort((a,b) => b.val - a.val).slice(0, 5));
        const sectorList = computed(() => { const s = {}; Object.values(dashboard.value.holdings).forEach(h => { s[h.sector] = (s[h.sector]||0) + 1; }); return Object.keys(s).map(n => ({ name: n, count: s[n] })).sort((a,b)=>b.count-a.count); });
        const filteredHoldings = computed(() => currentTab.value === 'å…¨å±€' ? Object.values(dashboard.value.holdings) : Object.values(dashboard.value.holdings).filter(h => h.sector === currentTab.value));
        const getSectorInfo = (s) => dynamicBenchmarks.value[s] || { desc: 'è«‹é‡å•Ÿ AI é‡çµ„' };
        const getSectorGainers = (s) => dynamicBenchmarks.value[s]?.top_gainers || [];

        const renderCharts = () => {
            if(currentTab.value !== 'å…¨å±€') return;
            setTimeout(() => {
                const ctxP = document.getElementById('allocationChart');
                if(ctxP) { if(pieChart) pieChart.destroy(); pieChart = new Chart(ctxP, { type:'doughnut', data:{ labels: top5Holdings.value.map(h=>h.symbol), datasets:[{data:top5Holdings.value.map(h=>h.val), backgroundColor:['#6366f1','#10b981','#f59e0b','#f43f5e','#ec4899'], borderWidth:0}] }, options:{ cutout:'88%', plugins:{legend:{display:false}} } }); }
            }, 300);
        };
        watch(() => [dashboard.value.holdings, currentTab.value], renderCharts, { deep: true });

        watch(currentTab, async (newTab) => {
            if(newTab==='å…¨å±€') { nextTick(renderCharts); return; }
            const etf = getSectorInfo(newTab).etf;
            if(etf) {
                isFetchingHistory.value = true;
                try {
                    const res = await fetch(`${API_URL}?action=get_history&symbols=${encodeURIComponent(JSON.stringify([etf]))}&password=${password.value}`);
                    const d = await res.json();
                    if(d.data && d.data[etf]) { 
                        benchmarkHistory.symbol=etf; benchmarkHistory.prices=d.data[etf].prices; benchmarkHistory.pctChange=d.data[etf].pctChange; 
                        nextTick(() => {
                            const ctx = document.getElementById('benchmarkChart'); if(!ctx) return; if(benchChartInstance) benchChartInstance.destroy();
                            benchChartInstance = new Chart(ctx, { type: 'line', data: { labels: benchmarkHistory.prices.map((_,i)=>i), datasets:[{data:benchmarkHistory.prices, borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.05)', fill:true, pointRadius:0, tension:0.1, borderWidth:4}] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false},tooltip:{enabled:false}}, scales:{x:{display:false},y:{display:false}}, layout:{padding:{top:100, bottom:10, left:20, right:20}} } });
                        });
                    }
                } catch(e) {} finally { isFetchingHistory.value = false; }
            }
            sectorNews.value = []; isFetchingNews.value = true;
            try {
                for(const h of filteredHoldings.value) {
                    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent('https://news.google.com/rss/search?q='+h.symbol+'+stock+news&hl=en-US&gl=US&ceid=US:en')}`);
                    const d = await res.json(); if(d.items) d.items.slice(0,5).forEach(item => sectorNews.value.push({symbol:h.symbol, title:item.title, link:item.link, pubDate:item.pubDate}));
                }
                sectorNews.value.sort((a,b)=>new Date(b.pubDate)-new Date(a.pubDate));
            } catch(e) {} finally { isFetchingNews.value = false; }
        });

        onMounted(() => {
            password.value = safeGet('p_pass');
            const c = safeGet('app_cache'); if(c){ try { const p=JSON.parse(c); transactions.value=p.tx||[]; marketData.value=p.md||{}; aiSectorMap.value=p.sect||{}; dynamicBenchmarks.value=p.bench||{}; recommendations.value=p.rec||[]; } catch(e){} }
            if(password.value) fetchData(false);
        });

        return {
            dashboard, monthlyStats, recommendations, quantData, sectorList, filteredHoldings, currentTab, isSyncing, isScanningAll, isReorganizing, top5Holdings, showCopilot, chatInput, chatHistory, isChatting,
            recForm, isAnalyzing, sectorNews, isFetchingNews, isFetchingHistory, benchmarkHistory,
            formatCurrency: (v,d=0)=> (Number(v)||0).toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d}), marked, fetchData, getSectorInfo, getSectorGainers,
            saveData: async () => { if(!confirm('å­˜æª”è‡³é›²ç«¯ï¼Ÿ'))return; await fetch(`${API_URL}?action=save&password=${password.value}`, { method: 'POST', body: JSON.stringify({ transactions: transactions.value, recommendations: recommendations.value, currentNav: dashboard.value.totalNav, quantData: quantData }) }); alert('å­˜æª”å®Œæˆ'); fetchData(false); },
            runAutoSectorMap: async () => { isReorganizing.value=true; try { await fetch(`${API_URL}?action=auto_sector_map&password=${password.value}`); fetchData(false); } finally { isReorganizing.value=false; } },
            scanAllQuantRisk: async () => { isScanningAll.value=true; for(let s of filteredHoldings.value.map(h=>h.symbol)){ const r=await fetch(`${API_URL}?action=quant_scan_all&symbols=["${s}"]&password=${password.value}`); const d=await r.json(); quantData[s]=d.data[s]; } isScanningAll.value=false; },
            generateAIAnalysis: async () => { if(!recForm.symbol)return; isAnalyzing.value=true; try { const r=await fetch(`${API_URL}?action=analyze_stock&symbol=${recForm.symbol}&password=${password.value}`); const d=await r.json(); recForm.analysis=d.analysis.action_zone; } finally { isAnalyzing.value=false; } },
            addRecommendation: () => { if(recForm.symbol) { recommendations.value.push({id:Date.now(), date:new Date().toISOString().split('T')[0], ...recForm, count:1}); recForm.symbol=''; recForm.analysis=''; } },
            removeRecommendation: (id) => { if(confirm('åˆªé™¤ï¼Ÿ')) recommendations.value = recommendations.value.filter(r=>r.id!==id); },
            sendChat: async () => { if(!chatInput.value.trim())return; const t=chatInput.value; chatHistory.value.push({role:'user',text:t}); chatInput.value=''; isChatting.value=true; try { const r = await fetch(`${API_URL}?action=copilot&msg=${encodeURIComponent(t)}&context=NAV:${dashboard.value.totalNav}&password=${password.value}`); const d=await r.json(); chatHistory.value.push({role:'ai',text:d.reply}); } finally { isChatting.value = false; } },
            addTransaction: () => { if(form.symbol) { transactions.value.push({id:Date.now(), ...form, symbol:form.symbol.toUpperCase()}); form.symbol=''; } },
            removeTransaction: (id) => { if(confirm('åˆªé™¤ï¼Ÿ')) transactions.value = transactions.value.filter(t=>t.id!==id); },
            filteredTransactions: computed(() => transactions.value.slice().sort((a,b)=>new Date(b.date)-new Date(a.date))),
            form
        };
    }
}).mount('#app');
</script>
</body>
</html>
